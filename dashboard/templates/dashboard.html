{% extends 'layout.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/dashboard.css' %}">
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <div class="left-section">
            <h1>Dashboard de Qualidade</h1>
        </div>
        <div class="agenda-scale">
            <input type="radio" id="financas-view" name="view-toggle" checked>
            <label for="financas-view"><b>Finanças</b></label>
            <input type="radio" id="qualidade-view" name="view-toggle">
            <label for="qualidade-view"><b>Qualidade</b></label>
        </div>
        <div class="dashboard-actions">
            <div class="period-filter">
                <button class="filter-btn" id="periodFilterBtn">
                    <i class="fas fa-calendar"></i>
                    {% if selected_period %}
                        {% if selected_period == 'custom' %}
                            Personalizado
                        {% elif selected_period == 7 %}Últimos 7 dias
                        {% elif selected_period == 14 %}Últimos 14 dias
                        {% elif selected_period == 30 %}Últimos 30 dias
                        {% elif selected_period == 90 %}Últimos 3 meses
                        {% elif selected_period == 180 %}Últimos 6 meses
                        {% elif selected_period == 365 %}Último ano
                        {% elif selected_period == 540 %}Último 1 ano e meio
                        {% elif selected_period == 730 %}Últimos 2 anos
                        {% endif %}
                    {% else %}
                        Filtrar por período
                    {% endif %}
                </button>
                <div id="periodFilter" class="period-dropdown" style="display: none;">
                    <div class="period-option" data-value="7" {% if selected_period == '7' %}data-selected{% endif %}>Últimos 7 dias</div>
                    <div class="period-option" data-value="14" {% if selected_period == '14' %}data-selected{% endif %}>Últimos 14 dias</div>
                    <div class="period-option" data-value="30" {% if selected_period == '30' %}data-selected{% endif %}>Últimos 30 dias</div>
                    <div class="period-option" data-value="90" {% if selected_period == '90' %}data-selected{% endif %}>Últimos 3 meses</div>
                    <div class="period-option" data-value="180" {% if selected_period == '180' %}data-selected{% endif %}>Últimos 6 meses</div>
                    <div class="period-option" data-value="365" {% if selected_period == '365' %}data-selected{% endif %}>Último ano</div>
                    <div class="period-option" data-value="540" {% if selected_period == '540' %}data-selected{% endif %}>Último 1 ano e meio</div>
                    <div class="period-option" data-value="730" {% if selected_period == '730' %}data-selected{% endif %}>Últimos 2 anos</div>
                    <div class="period-option" data-value="custom" {% if selected_period == 'custom' %}data-selected{% endif %}>Período Personalizado</div>
            
                    <div id="customRangeContainer" class="custom-range" style="display: none; margin-top: 10px;">
                        <label for="customStart">Início:</label>
                        <input type="date" id="customStart" />
                        <label for="customEnd">Fim:</label>
                        <input type="date" id="customEnd" />
                        <button type="button" id="applyCustomRangeBtn">Aplicar</button>
                    </div>

                    <div class="period-option" data-value="month" {% if selected_period == 'month' %}data-selected{% endif %}>Selecionar Mês</div>
                    <div id="monthPickerContainer" class="month-picker" style="{% if selected_period == 'month' %}display: flex;{% else %}display: none;{% endif %}">
                        <label for="monthPicker">Mês de referência:</label>
                        <input type="month" id="monthPicker" value="{{ selected_month }}" />
                        <button type="button" id="applyMonthBtn">Aplicar mês</button>
                    </div>
                </div>
            </div>            
            <button class="export-btn" id="exportBtn">
                <i class="fas fa-download"></i>
                Exportar
            </button>
        </div>
    </div>

    <div class="metrics-grid">
        <!-- CSAT Score -->
        <div class="metric-card csat">
            <div class="csat-text">
                <div class="csat-label">CSAT</div>
                <div class="csat-value">{% if metrics.csat_score %}{{ metrics.csat_score|floatformat:1 }}{% else %}--{% endif %}</div>
            </div>
            <div class="csat-emoji">
                {% if metrics.csat_score >= 8 %}
                    <img src="{% static 'csat_grade_faces/happy.png' %}" alt="Happy face">
                {% elif metrics.csat_score >= 6 %}
                    <img src="{% static 'csat_grade_faces/neutral.png' %}" alt="Neutral face">
                {% else %}
                    <img src="{% static 'csat_grade_faces/sad.png' %}" alt="Sad face">
                {% endif %}
            </div>
        </div>

        <!-- Column 1 -->
        <div class="metrics-column-1">
            <div class="metric-card eventos-adversos">
                <div class="header-row">
                    <h3>Procedimento</h3>
                    <div class="procedure-filter">
                        <select id="procedimentoFilter">
                            <option value="">Todos</option>
                            {% for proc in procedimentos %}
                                <option value="{{ proc.name }}" {% if selected_procedimento == proc.name %}selected{% endif %}>
                                    {{ proc.name|truncatechars:25 }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>
                </div>
                <div class="metric-value">{% if metrics.eventos_adversos %}{{ metrics.eventos_adversos|floatformat:0 }}%{% else %}0%{% endif %}</div>
                <div class="metric-label">Taxa de eventos adversos graves</div>
            </div>

            <div class="metric-card">
                <h3>Tempo de atraso médio para início da cirurgia (hh:mm)</h3>
                <div class="metric-value">{% if metrics.atraso_medio %}{{ metrics.atraso_medio }}{% else %}--:--{% endif %}</div>
            </div>

            <div class="metric-card">
                <h3>Tempo médio de duração das cirurgias (hh:mm)</h3>
                <div class="metric-value">{% if metrics.duracao_media %}{{ metrics.duracao_media }}{% else %}--:--{% endif %}</div>
            </div>
        </div>

        <!-- Column 2 -->
        <div class="metrics-column-2">
            <div class="metric-card">
                <h3>Taxa de Reações Alérgicas</h3>
                <div class="metric-value">{% if metrics.reacoes_alergicas %}{{ metrics.reacoes_alergicas|floatformat:0 }}%{% else %}0%{% endif %}</div>
            </div>

            <div class="metric-card">
                <h3>Encaminhamentos não programados ao CTI</h3>
                <div class="metric-value">{% if metrics.encaminhamentos_uti %}{{ metrics.encaminhamentos_uti|floatformat:0 }}%{% else %}0%{% endif %}</div>
            </div>

            <div class="metric-card">
                <h3>Abreviação de Jejum</h3>
                <div class="metric-value">{% if metrics.abreviacao_jejum_percent %}{{ metrics.abreviacao_jejum_percent|floatformat:0 }}%{% else %}--{% endif %}</div>
                <div class="metric-label">Sim</div>
            </div>

            <div class="metric-card">
                <h3>Aldrete > 8</h3>
                <div class="metric-value">{% if metrics.aldrete_maior_que_8_percent %}{{ metrics.aldrete_maior_que_8_percent|floatformat:0 }}%{% else %}--{% endif %}</div>
                <div class="metric-label">% com Aldrete acima de 8</div>
            </div>
        </div>

        <!-- Column 3 -->
        <div class="metrics-column-3">
            <div class="metric-card">
                <div class="header-row">
                    <h3>PONV</h3>
                    <div class="view-filter">
                        <select class="view-selector" data-param="ponv_view">
                            <option value="final" {% if metrics.ponv_view == 'final' %}selected{% endif %}>Final do Procedimento</option>
                            <option value="rpa" {% if metrics.ponv_view == 'rpa' %}selected{% endif %}>RPA</option>
                        </select>
                    </div>
                </div>
                <div class="metric-value">{% if metrics.ponv %}{{ metrics.ponv|floatformat:0 }}%{% else %}0%{% endif %}</div>
            </div>

            <div class="metric-card">
                <div class="header-row">
                    <h3>Dor pós-operatória</h3>
                    <div class="view-filter">
                        <select class="view-selector" data-param="dor_view">
                            <option value="final" {% if metrics.dor_view == 'final' %}selected{% endif %}>Final do Procedimento</option>
                            <option value="rpa" {% if metrics.dor_view == 'rpa' %}selected{% endif %}>RPA</option>
                        </select>
                    </div>
                </div>
                <div class="metric-value">{% if metrics.dor_pos_operatoria %}{{ metrics.dor_pos_operatoria|floatformat:0 }}%{% else %}0%{% endif %}</div>
            </div>

            <div class="metric-card peak-hours-card">
                <h3>Horários de Pico de Cirurgia</h3>
                <div class="chart-container">
                    <canvas id="peakHoursChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Column 4 -->
        <div class="metrics-column-4">
            <div class="metric-card">
                <div class="header-row">
                    <h3>Eventos adversos evitáveis</h3>
                    <div class="view-filter">
                        <select class="view-selector" data-param="evento_view">
                            <option value="final" {% if metrics.evento_view == 'final' %}selected{% endif %}>Final do Procedimento</option>
                            <option value="rpa" {% if metrics.evento_view == 'rpa' %}selected{% endif %}>RPA</option>
                        </select>
                    </div>
                </div>
                <div class="metric-value">{% if metrics.evento_adverso_evitavel %}{{ metrics.evento_adverso_evitavel|floatformat:0 }}%{% else %}0%{% endif %}</div>
            </div>

            <div class="metric-card">
                <h3>Adesão ao checklist de segurança</h3>
                <div class="metric-value">{% if metrics.adesao_checklist %}{{ metrics.adesao_checklist|floatformat:0 }}%{% else %}--{% endif %}</div>
            </div>

            <!-- Progress bars -->
            <div class="progress-section">
                <div class="progress-card">
                    <div class="progress-bar">
                        <div class="progress" style="height: {% if metrics.conformidade_protocolos %}{{ metrics.conformidade_protocolos|floatformat:0 }}%{% else %}100%{% endif %}"></div>
                    </div>
                    <div class="progress-label">{% if metrics.conformidade_protocolos %}{{ metrics.conformidade_protocolos|floatformat:0 }}%{% else %}--{% endif %}</div>
                    <div class="progress-title">Conformidade com os protocolos</div>
                </div>

                <div class="progress-card">
                    <div class="progress-bar">
                        <div class="progress" style="height: {% if metrics.tecnicas_assepticas %}{{ metrics.tecnicas_assepticas|floatformat:0 }}%{% else %}100%{% endif %}"></div>
                    </div>
                    <div class="progress-label">{% if metrics.tecnicas_assepticas %}{{ metrics.tecnicas_assepticas|floatformat:0 }}%{% else %}--{% endif %}</div>
                    <div class="progress-title">Uso de técnicas assépticas</div>
                </div>

                <div class="progress-card">
                    <div class="progress-bar">
                        <div class="progress" style="height: {% if metrics.adesao_profilaxia_antibiotica %}{{ metrics.adesao_profilaxia_antibiotica|floatformat:0 }}%{% else %}100%{% endif %}"></div>
                    </div>
                    <div class="progress-label">{% if metrics.adesao_profilaxia_antibiotica %}{{ metrics.adesao_profilaxia_antibiotica|floatformat:0 }}%{% else %}--{% endif %}</div>
                    <div class="progress-title">Adesão à profilaxia antibiótica</div>
                </div>

                <div class="progress-card">
                    <div class="progress-bar">
                        <div class="progress" style="height: {% if metrics.adesao_prevencao_tvp_tep %}{{ metrics.adesao_prevencao_tvp_tep|floatformat:0 }}%{% else %}100%{% endif %}"></div>
                    </div>
                    <div class="progress-label">{% if metrics.adesao_prevencao_tvp_tep %}{{ metrics.adesao_prevencao_tvp_tep|floatformat:0 }}%{% else %}--{% endif %}</div>
                    <div class="progress-title">Adesão à prevenção de TVP/TEP</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Peak Hours Chart
    const peakHoursCtx = document.getElementById('peakHoursChart').getContext('2d');
    const peakHoursData = {{ metrics.peak_hours_data|safe }};
    
    new Chart(peakHoursCtx, {
        type: 'bar',
        data: {
            labels: Array.from({length: 24}, (_, i) => `${i}h`),
            datasets: [{
                label: 'Cirurgias',
                data: peakHoursData,
                backgroundColor: '#1A73E8',
                borderRadius: 4,
                borderSkipped: false,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        title: function(context) {
                            return `Horário: ${context[0].label}`;
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        font: {
                            size: 10
                        }
                    },
                    grid: {
                        display: false
                    }
                },
                x: {
                    ticks: {
                        font: {
                            size: 9
                        },
                        maxRotation: 0,
                        autoSkip: true,
                        maxTicksLimit: 12
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });
});

document.getElementById('procedimentoFilter').addEventListener('change', function() {
    const selectedValue = this.value;
    console.log('Selected value:', selectedValue);
    
    if (selectedValue) {
        const newUrl = '?procedimento=' + encodeURIComponent(selectedValue);
        console.log('Redirecting to:', newUrl);
        window.location.href = newUrl;
    } else {
        console.log('Resetting to base URL');
        window.location.href = window.location.pathname;
    }
});

// Log on page load to verify the element exists
console.log('Filter element:', document.getElementById('procedimentoFilter'));

document.getElementById('periodFilterBtn').addEventListener('click', function(e) {
    e.stopPropagation();
    const dropdown = document.getElementById('periodFilter');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
});

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('periodFilter');
    if (!e.target.closest('.period-filter')) {
        dropdown.style.display = 'none';
    }
});

document.getElementById('exportBtn').addEventListener('click', function() {
    const element = document.querySelector('.dashboard-container');
    const opt = {
        margin: 1,
        filename: 'dashboard-qualidade.pdf',
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'landscape' }
    };

    html2pdf().set(opt).from(element).save();
});

document.addEventListener('DOMContentLoaded', function() {
    const financasRadio = document.getElementById('financas-view');
    const qualidadeRadio = document.getElementById('qualidade-view');
    
    // Set initial state based on current page
    qualidadeRadio.checked = true;
    financasRadio.checked = false;
    
    financasRadio.addEventListener('change', function() {
        if (this.checked) {
            console.log('Switching to financas dashboard');
            window.location.href = "{% url 'financas_dashboard_view' %}";
        }
    });

    qualidadeRadio.addEventListener('change', function() {
        if (this.checked) {
            console.log('Switching to qualidade dashboard');
            window.location.href = "{% url 'dashboard' %}";
        }
    });
});

document.querySelectorAll('.view-selector').forEach(selector => {
    selector.addEventListener('change', function() {
        const param = this.dataset.param;
        const value = this.value;
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set(param, value);
        window.location.href = currentUrl.toString();
    });
});

// Handle "Aplicar" button for the custom range
document.getElementById('applyCustomRangeBtn').addEventListener('click', function() {
    const startInput = document.getElementById('customStart');
    const endInput = document.getElementById('customEnd');
    
    if (startInput.value && endInput.value) {
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('period', 'custom');
        currentUrl.searchParams.set('start_date', startInput.value);
        currentUrl.searchParams.set('end_date', endInput.value);
        window.location.href = currentUrl.toString();
    } else {
        alert('Por favor, selecione ambas as datas.');
    }
});

document.querySelectorAll('.period-option').forEach(option => {
  option.addEventListener('click', function() {
    const value = this.dataset.value;
    
    // If "custom" was selected, just show the date inputs, no page reload yet
    if (value === 'custom') {
      document.getElementById('customRangeContainer').style.display = 'block';
      document.getElementById('monthPickerContainer').style.display = 'none';
    } else if (value === 'month') {
      // If "month" was selected, show the month picker, no page reload yet
      document.getElementById('monthPickerContainer').style.display = 'flex';
      document.getElementById('customRangeContainer').style.display = 'none';
    } else {
      // Hide custom range and month picker UI if previously shown
      document.getElementById('customRangeContainer').style.display = 'none';
      document.getElementById('monthPickerContainer').style.display = 'none';

      // Immediately apply the chosen period filter
      const currentUrl = new URL(window.location.href);
      currentUrl.searchParams.set('period', value);
      currentUrl.searchParams.delete('start_date');
      currentUrl.searchParams.delete('end_date');
      currentUrl.searchParams.delete('month');
      window.location.href = currentUrl.toString();
    }
  });
});

// "Aplicar" button for month selection
const applyMonthBtn = document.getElementById('applyMonthBtn');
if (applyMonthBtn) {
    applyMonthBtn.addEventListener('click', function() {
        const monthInput = document.getElementById('monthPicker');
        if (monthInput && monthInput.value) {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('period', 'month');
            currentUrl.searchParams.set('month', monthInput.value);
            currentUrl.searchParams.delete('start_date');
            currentUrl.searchParams.delete('end_date');
            window.location.href = currentUrl.toString();
        } else {
            alert('Por favor, selecione um mês.');
        }
    });
}


</script>
{% endblock %}
