{% extends 'layout.html' %}
{% load static %}
{% load financas_filters %}
{% load humanize %}

{% block title %}Finanças{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/financas.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}

{% block content %}
<div class="financas-container">
    <div class="financas-header">
        <h1>Finanças</h1>
        
        <div class="view-toggle">
            <a href="?view=receitas" class="toggle-btn {% if view_type == 'receitas' %}active{% endif %}">Receitas</a>
            <a href="?view=despesas" class="toggle-btn {% if view_type == 'despesas' %}active{% endif %}">Despesas & Custos</a>
        </div>
    </div>
    
    <div class="header-actions">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Buscar por paciente, CPF ou CPSA" value="{{ search_query }}" autocomplete="off"> {# Updated placeholder #}
        </div>
        
        {% if view_type == 'receitas' %} {# Only show status filter for Receitas #}
        <div class="status-filter">
            <select name="status" id="statusFilterSelect" class="form-select"> {# Added ID for JS if needed #}
                <option value="">Todos Status</option> {# Changed default text #}
                <option value="em_processamento" {% if selected_status == 'em_processamento' %}selected{% endif %}>Em Processamento</option>
                <option value="aguardando_pagamento" {% if selected_status == 'aguardando_pagamento' %}selected{% endif %}>Aguardando Pagamento</option>
                <option value="recurso_de_glosa" {% if selected_status == 'recurso_de_glosa' %}selected{% endif %}>Recurso de Glosa</option>
                <option value="processo_finalizado" {% if selected_status == 'processo_finalizado' %}selected{% endif %}>Processo Finalizado</option>
                <option value="cancelada" {% if selected_status == 'cancelada' %}selected{% endif %}>Cancelada</option>
            </select>
        </div>
        {% endif %}
        
        <div class="period-filter">
            <button class="filter-btn" id="periodFilterBtn">
                <i class="fas fa-calendar"></i>
                {% if selected_period %}
                    {% if selected_period == 'custom' %}
                        Personalizado ({{ custom_start_date|date:"d/m/y" }} - {{ custom_end_date|date:"d/m/y" }}) {# Show range #}
                    {% elif selected_period == '7' %}Últimos 7 dias
                    {% elif selected_period == '14' %}Últimos 14 dias
                    {% elif selected_period == '30' %}Últimos 30 dias
                    {% elif selected_period == '90' %}Últimos 3 meses
                    {% elif selected_period == '180' %}Últimos 6 meses
                    {% elif selected_period == '365' %}Último ano
                    {% elif selected_period == '540' %}Último 1 ano e meio
                    {% elif selected_period == '730' %}Últimos 2 anos
                    {% endif %}
                {% else %}
                    Filtrar por período
                {% endif %}
            </button>
            <div id="periodFilter" class="period-dropdown" style="display: none;">
                <div class="period-option" data-value="7" {% if selected_period == '7' %}data-selected{% endif %}>Últimos 7 dias</div>
                <div class="period-option" data-value="14" {% if selected_period == '14' %}data-selected{% endif %}>Últimos 14 dias</div>
                <div class="period-option" data-value="30" {% if selected_period == '30' %}data-selected{% endif %}>Últimos 30 dias</div>
                <div class="period-option" data-value="90" {% if selected_period == '90' %}data-selected{% endif %}>Últimos 3 meses</div>
                <div class="period-option" data-value="180" {% if selected_period == '180' %}data-selected{% endif %}>Últimos 6 meses</div>
                <div class="period-option" data-value="365" {% if selected_period == '365' %}data-selected{% endif %}>Último ano</div>
                <div class="period-option" data-value="540" {% if selected_period == '540' %}data-selected{% endif %}>Último 1 ano e meio</div>
                <div class="period-option" data-value="730" {% if selected_period == '730' %}data-selected{% endif %}>Últimos 2 anos</div>
                <div class="period-option" data-value="custom" {% if selected_period == 'custom' %}data-selected{% endif %}>Período Personalizado</div>

                <div id="customRangeContainer" class="custom-range" style="{% if selected_period != 'custom' %}display: none;{% endif %}"> {# Show if custom selected #}
                    <label for="customStart">Início:</label>
                    <input type="date" id="customStart" value="{{ custom_start_date }}" />
                    <label for="customEnd">Fim:</label>
                    <input type="date" id="customEnd" value="{{ custom_end_date }}" />
                    <button type="button" id="applyCustomRangeBtn">Aplicar</button>
                </div>
            </div>
        </div>
        
        <button class="export-btn" onclick="exportFinances()">
            <i class="fas fa-file-excel"></i> Exportar {# Added icon #}
        </button>
        
        {% if user.user_type == GESTOR_USER or user.user_type == ADMIN_USER %} {# Only show conciliation button to relevant users #}
        <button id="conciliate-btn" class="conciliate-btn" onclick="runConciliation()">
            <i class="fas fa-sync"></i> Conciliar {# Added icon #}
        </button>
        {% endif %}
        
    </div>

    <div class="financas-table">
        <table>
            <thead>
                <tr>
                    {% if view_type == 'receitas' %}
                        <th>Paciente</th>
                        <th>CPF</th>
                        <th>Data Cirurgia</th>
                        <th>Valor Faturado</th>
                        <th>Valor Recebido</th>
                        <th>Valor Recuperado</th>
                        <th>Valor a Recuperar</th>
                        <th>Fonte Pagadora</th>
                        <th>CPSA</th>
                        <th>Anestesista / Cooperado</th> {# Renamed Header #}
                        <th>Situação</th>
                        <th>Data Pagamento</th>
                        <th>Ações</th> {# Renamed Header #}
                    {% else %} {# Despesas Headers #}
                        <th>Descrição</th>
                        <th>Data</th>
                        <th>Valor</th>
                        <th>Pago</th>
                        <th>Ações</th> {# Renamed Header #}
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                    <tr data-id="{{ item.id }}">
                        {% if view_type == 'receitas' %}
                            {# Use procedure data if available, otherwise fallback to API data #}
                            <td>
                                {% if item.procedimento %}
                                    {{ item.procedimento.nome_paciente }}
                                {% else %}
                                    {{ item.api_paciente_nome|default:"(Não vinculado)" }}
                                {% endif %}
                            </td>
                            <td>{{ item.procedimento.cpf_paciente|default:"--" }}</td> {# CPF only if linked #}
                            <td>
                                {% if item.procedimento and item.procedimento.data_horario %}
                                    {{ item.procedimento.data_horario|date:"d/m/Y" }}
                                {% elif item.api_data_cirurgia %}
                                    {{ item.api_data_cirurgia|date:"d/m/Y" }}
                                {% else %}
                                    --
                                {% endif %}
                            </td>
                            {# Revert to original formatting #}
                            <td>{% if item.valor_faturado is not None %}R$ {{ item.valor_faturado|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{% if item.valor_recebido is not None %}R$ {{ item.valor_recebido|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{% if item.valor_recuperado is not None %}R$ {{ item.valor_recuperado|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{% if item.valor_acatado is not None %}R$ {{ item.valor_acatado|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{{ item.get_tipo_cobranca_display|default:"--" }}</td>
                            <td>{{ item.get_cpsa_display|default:"--" }}</td>
                            <td>
                                {% if item.procedimento and item.procedimento.anestesistas_responsaveis.exists %}
                                    {{ item.procedimento.anestesistas_responsaveis.first.name }}
                                {% else %}
                                    {{ item.api_cooperado_nome|default:"--" }} {# Show API cooperado if unlinked #}
                                {% endif %}
                            </td>
                            <td>{{ item.get_status_pagamento_display|default:"--" }}</td>
                            <td>{{ item.data_pagamento|date:"d/m/Y"|default:"-" }}</td>
                            <td>
                                <div class="action-buttons"> {# Wrap buttons #}
                                    <button type="button" class="edit-btn action-btn" title="Editar">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    <button type="button" class="delete-btn action-btn" title="Excluir"> {# Changed from cancel #}
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        {% else %} {# Despesas Row #}
                            <td>{{ item.descricao }}</td>
                            <td>{{ item.data|date:"d/m/Y" }}</td>
                            {# Revert to original formatting #}
                            <td>{% if item.valor is not None %}R$ {{ item.valor|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{% if item.pago %}Sim{% else %}Não{% endif %}</td>
                            <td>
                                <div class="action-buttons">
                                    <button type="button" class="edit-btn action-btn" title="Editar">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    <button type="button" class="delete-btn action-btn" title="Excluir">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        {% endif %}
                    </tr>
                {% empty %}
                 <tr>
                    <td colspan="{% if view_type == 'receitas' %}13{% else %}5{% endif %}" style="text-align: center; padding: 20px;">Nenhum item encontrado para os filtros selecionados.</td>
                 </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if view_type == 'despesas' %}
    <button class="add-btn" onclick="openAddDespesaModal()">
        <i class="fas fa-plus"></i>
        Inserir despesa ou custo
    </button>
    {% endif %}
</div>

{# --- Edit Modal (Receitas part needs adjustment if editing unlinked items) --- #}
<div id="edit-finance-modal" class="modal">
    <div class="modal-content">
        <span class="close" data-modal-id="edit-finance-modal">&times;</span>
        <h2><span id="modal-action-type">Editar</span> <span id="modal-title-type"></span></h2>
        
        <form id="edit-finance-form">
            {% csrf_token %}
            <input type="hidden" id="finance_id" name="finance_id">
            <input type="hidden" id="finance_type" name="finance_type">
            <input type="hidden" id="is_new" name="is_new" value="false">
            <input type="hidden" id="is_linked" name="is_linked" value="false"> {# Add hidden field for linked status #}
            
            {# Display basic info for unlinked items #}
            <div id="unlinked-info" style="display: none; margin-bottom: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 4px;">
                <strong>Item não vinculado a um procedimento.</strong><br>
                Paciente (API): <span id="unlinked-paciente"></span><br>
                Data Cirurgia (API): <span id="unlinked-data"></span>
            </div>

            <!-- Receitas fields -->
            <div id="receitas-fields">
                 {# Show CPF only if linked #}
                <div class="form-group" id="cpf-group">
                    <label for="cpf">CPF do Paciente</label>
                    <input type="text" id="cpf" name="cpf" readonly> {# Make readonly if unlinked? #}
                </div>
                 <div class="form-group">
                    <label for="valor_faturado">Valor Faturado</label>
                    <input type="text" class="money-input form-control" id="valor_faturado" name="valor_faturado">
                </div>
                {# ... other value fields ... #}
                 <div class="form-group">
                    <label for="valor_recebido">Valor Recebido</label>
                    <input type="text" class="money-input form-control" id="valor_recebido" name="valor_recebido">
                </div>
                <div class="form-group">
                    <label for="valor_recuperado">Valor Recuperado</label>
                    <input type="text" class="money-input form-control" id="valor_recuperado" name="valor_recuperado">
                </div>
                <div class="form-group">
                    <label for="valor_acatado">Valor a Recuperar</label>
                    <input type="text" class="money-input form-control" id="valor_acatado" name="valor_acatado">
                </div>
                <div class="form-group">
                    <label for="status_pagamento">Status do Pagamento</label>
                    <select id="status_pagamento" name="status_pagamento">
                        <option value="em_processamento">Em Processamento</option>
                        <option value="aguardando_pagamento">Aguardando Pagamento</option>
                        <option value="recurso_de_glosa">Recurso de Glosa</option>
                        <option value="processo_finalizado">Processo Finalizado</option>
                        <option value="cancelada">Cancelada</option>
                    </select>
                </div>
                 {# Hide fields not applicable to unlinked items? Or make readonly? #}
                <div class="form-group" id="tipo-cobranca-group">
                    <label for="tipo_cobranca">Tipo de Cobrança</label>
                    <select id="tipo_cobranca" name="tipo_cobranca">
                        <option value="cooperativa">Cooperativa</option>
                        <option value="hospital">Hospital</option>
                        <option value="particular">Direta</option>
                    </select>
                </div>
                <div class="form-group" id="data-pagamento-group">
                    <label for="data_pagamento">Data do Pagamento</label>
                    <input type="date" id="data_pagamento" name="data_pagamento">
                </div>
                <div class="form-group" id="cpsa-group">
                    <label for="cpsa">CPSA</label>
                    <input type="text" id="cpsa" name="cpsa">
                </div>
                <div class="form-group" id="tipo-pagamento-direto-group" style="display: none;">
                    <label for="tipo_pagamento_direto">Tipo de Pagamento (Direta)</label>
                    <select id="tipo_pagamento_direto" name="tipo_pagamento_direto">
                        <option value="cartao">Cartão</option>
                        <option value="cheque">Cheque</option>
                        <option value="dinheiro">Dinheiro</option>
                        <option value="pix">Pix</option>
                        <option value="transferencia">Transferência</option>
                        <option value="boleto">Boleto</option>
                    </select>
                </div>
            </div>

            <!-- Despesas fields -->
            <div id="despesas-fields">
                {# ... despesas fields remain the same ... #}
                 <div class="form-group">
                    <label for="descricao">Descrição</label>
                    <input type="text" id="descricao" name="descricao" required>
                </div>
                <div class="form-group">
                    <label for="valor">Valor</label>
                    <input type="text" class="money-input" id="valor" name="valor" required>
                </div>
                <div class="form-group">
                    <label for="data">Data</label>
                    <input type="date" id="data" name="data" required>
                </div>
                <div class="form-group">
                    <label>
                        Pago
                        <input type="checkbox" id="pago" name="pago">
                    </label>
                </div>
            </div>

            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>


{# Removed Conciliation Modal and Unmatched Guias Modal/FAB as conciliation is now automatic #}
{# The results are shown via alerts/messages after clicking the "Conciliar" button #}

{# --- SCRIPTS --- #}
<script src="https://unpkg.com/imask"></script> {# Keep iMask #}

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('edit-finance-form');
    const editModal = document.getElementById('edit-finance-modal'); 
    
    // --- Generalized Modal Close Logic ---
    document.querySelectorAll('.modal .close').forEach(closeBtn => {
        closeBtn.onclick = function() {
            const modalId = this.getAttribute('data-modal-id');
            if (modalId) {
                const modalToClose = document.getElementById(modalId);
                if (modalToClose) {
                    modalToClose.style.display = "none";
                }
            }
        }
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }

    // Function to toggle fields based on 'Tipo de Cobrança' for Receitas
    function toggleReceitaFieldsVisibility() {
        const financeType = document.getElementById('finance_type').value;
        if (financeType !== 'receitas') return; // Only run for receitas

        const tipoCobranca = document.getElementById('tipo_cobranca').value;
        const cpsaGroup = document.getElementById('cpsa-group');
        const tipoPagamentoDiretoGroup = document.getElementById('tipo-pagamento-direto-group');
        const isLinked = document.getElementById('is_linked').value === 'true'; // Check linked status

        // Hide both by default
        if (cpsaGroup) cpsaGroup.style.display = 'none';
        if (tipoPagamentoDiretoGroup) tipoPagamentoDiretoGroup.style.display = 'none';
        
        // Show CPSA only if 'cooperativa'
        if (tipoCobranca === 'cooperativa' && cpsaGroup) {
             cpsaGroup.style.display = 'block';
        } 
        // Show Payment Type only if 'particular'
        else if (tipoCobranca === 'particular' && tipoPagamentoDiretoGroup) {
             tipoPagamentoDiretoGroup.style.display = 'block';
        }
        
        // Show/hide CPF based on linked status
        const cpfGroup = document.getElementById('cpf-group');
        if (cpfGroup) {
             cpfGroup.style.display = isLinked ? 'block' : 'none';
             // Maybe make CPF readonly if shown for unlinked?
             // document.getElementById('cpf').readOnly = !isLinked; 
        }
    }

    const tipoCobrancaSelect = document.getElementById('tipo_cobranca');
    if (tipoCobrancaSelect) {
        tipoCobrancaSelect.addEventListener('change', toggleReceitaFieldsVisibility);
    }
    
    // Function to toggle Data Pagamento visibility based on Status for Receitas
    function toggleDataPagamentoVisibility() {
         const financeType = document.getElementById('finance_type').value;
         if (financeType !== 'receitas') return;

         const statusSelect = document.getElementById('status_pagamento');
         const dataPagamentoGroup = document.getElementById('data-pagamento-group'); // Use group ID
         const dataPagamentoInput = document.getElementById('data_pagamento');

         if (!statusSelect || !dataPagamentoGroup || !dataPagamentoInput) return; // Elements might not exist if despesas

         const status = statusSelect.value;
         // Show if 'processo_finalizado' or 'recurso_de_glosa' (assuming glosa implies payment attempt)
         if (status === 'processo_finalizado' || status === 'recurso_de_glosa') { 
             dataPagamentoGroup.style.display = 'block';
             dataPagamentoInput.required = true;
         } else {
             dataPagamentoGroup.style.display = 'none';
             dataPagamentoInput.required = false;
             dataPagamentoInput.value = ''; // Clear value if hidden
         }
    }
    
    const statusPagamentoSelect = document.getElementById('status_pagamento');
     if (statusPagamentoSelect) {
         statusPagamentoSelect.addEventListener('change', toggleDataPagamentoVisibility);
     }


    // Handle edit button clicks
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const row = this.closest('tr');
            const financeId = row.dataset.id;
            // Determine view type from the page context (less error-prone)
            const viewType = '{{ view_type }}'; 
            
            // Reset form and modal state
            form.reset();
            document.getElementById('modal-action-type').textContent = 'Editar';
            document.getElementById('unlinked-info').style.display = 'none'; // Hide unlinked info by default
            document.getElementById('finance_id').value = financeId;
            document.getElementById('finance_type').value = viewType;
            document.getElementById('is_new').value = 'false';

            // Show/hide field sections based on viewType
            if (viewType === 'receitas') {
                document.getElementById('receitas-fields').style.display = 'block';
                document.getElementById('despesas-fields').style.display = 'none';
                document.getElementById('modal-title-type').textContent = 'Receita';
                 // Set initial required attributes (might be overridden based on status/type later)
                 // document.getElementById('valor_faturado').required = true; // Set required dynamically?
            } else { // despesas
                document.getElementById('receitas-fields').style.display = 'none';
                document.getElementById('despesas-fields').style.display = 'block';
                document.getElementById('modal-title-type').textContent = 'Despesa';
                 document.getElementById('descricao').required = true;
                 document.getElementById('valor').required = true;
                 document.getElementById('data').required = true;
            }
            
            // Fetch item data
            fetch(`/financas/get-item/${viewType}/${financeId}/`)
                .then(response => {
                    if (!response.ok) {
                         return response.json().then(err => { throw new Error(err.error || `Erro ${response.status}`) });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    document.getElementById('is_linked').value = data.is_linked ? 'true' : 'false';

                    if (viewType === 'receitas') {
                         // Apply mask and set values using maskRef API
                         const valorInputs = [
                             { elem: document.getElementById('valor_faturado'), value: data.valor_faturado },
                             { elem: document.getElementById('valor_recebido'), value: data.valor_recebido },
                             { elem: document.getElementById('valor_recuperado'), value: data.valor_recuperado },
                             { elem: document.getElementById('valor_acatado'), value: data.valor_acatado },
                         ];
                         
                         valorInputs.forEach(({elem, value}) => {
                             if (elem && elem.maskRef) {
                                 elem.maskRef.unmaskedValue = String(value || '0');
                             } else if (elem) {
                                 // Fallback if maskRef not ready/available (shouldn't happen ideally)
                                 elem.value = `R$ ${parseFloat(value || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                             }
                         });

                         document.getElementById('status_pagamento').value = data.status_pagamento || 'em_processamento';
                         document.getElementById('data_pagamento').value = data.data_pagamento || '';
                         document.getElementById('tipo_cobranca').value = data.tipo_cobranca || 'cooperativa';
                         document.getElementById('cpsa').value = data.cpsa || '';
                         document.getElementById('cpf').value = data.cpf || ''; // Comes from get_finance_item if linked
                         
                         if (data.tipo_pagamento_direto) {
                             document.getElementById('tipo_pagamento_direto').value = data.tipo_pagamento_direto;
                         } else {
                             // Ensure a default is selected if null/undefined
                             document.getElementById('tipo_pagamento_direto').value = 'cartao'; 
                         }
                         
                         // Show info panel if not linked
                         if (!data.is_linked) {
                             document.getElementById('unlinked-info').style.display = 'block';
                             document.getElementById('unlinked-paciente').textContent = data.paciente_nome || 'N/A';
                             document.getElementById('unlinked-data').textContent = data.data_cirurgia ? new Date(data.data_cirurgia + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';
                         }

                         // Trigger visibility updates based on loaded data
                         toggleReceitaFieldsVisibility();
                         toggleDataPagamentoVisibility(); 

                    } else { // despesas
                         document.getElementById('descricao').value = data.descricao || '';
                         const valorInput = document.getElementById('valor');
                         if(valorInput.maskRef){
                              valorInput.maskRef.unmaskedValue = String(data.valor || '0');
                         } else {
                             valorInput.value = `R$ ${parseFloat(data.valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
                         }
                         document.getElementById('data').value = data.data || '';
                         document.getElementById('pago').checked = data.pago || false;
                    }
                    
                    editModal.style.display = "block";
                })
                .catch(error => {
                    console.error('Error fetching item data:', error);
                    alert(`Erro ao carregar os dados: ${error.message}`);
                });
        });
    });

    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const financeType = formData.get('finance_type');
        const isNew = formData.get('is_new') === 'true';
        
        // --- Data Preparation ---
        if (financeType === 'receitas') {
            // Convert masked money values to raw numbers
            const valorInputNames = ['valor_faturado', 'valor_recebido', 'valor_recuperado', 'valor_acatado'];
            valorInputNames.forEach(name => {
                const elem = document.getElementById(name);
                if (elem && elem.maskRef) {
                    formData.set(name, elem.maskRef.unmaskedValue || '0');
                } else if (elem) {
                     // Fallback conversion (less reliable)
                     let valor = elem.value.replace('R$ ', '').replace(/\./g, '').replace(',', '.');
                     formData.set(name, parseFloat(valor) || '0');
                }
            });
        } else { // Despesas
             const valorElem = document.getElementById('valor');
             if (valorElem && valorElem.maskRef) {
                 formData.set('valor', valorElem.maskRef.unmaskedValue || '0');
             } else if (valorElem) {
                 let valor = valorElem.value.replace('R$ ', '').replace(/\./g, '').replace(',', '.');
                 formData.set('valor', parseFloat(valor) || '0');
             }
             // Ensure 'pago' is sent correctly ('on' or null)
             if (!formData.has('pago')) {
                 formData.set('pago', ''); // Explicitly set if unchecked
             }
        }
        
        // --- Validation (Example) ---
        // Add specific validation logic here if needed, e.g., check required fields based on status/type
        if (financeType === 'receitas') {
            // Example: Check if Data Pagamento is provided when status requires it
             const status = formData.get('status_pagamento');
             const dataPagamento = formData.get('data_pagamento');
             if ((status === 'processo_finalizado' || status === 'recurso_de_glosa') && !dataPagamento) {
                 alert('Data de pagamento é obrigatória para o status selecionado.');
                 return; // Stop submission
             }
        } else { // Despesas validation (already handled by 'required' attribute mostly)
             if (!formData.get('descricao') || !formData.get('valor') || !formData.get('data')) {
                 alert('Preencha todos os campos obrigatórios para despesas.');
                 return;
             }
        }
        
        // Determine URL (Create only supported for despesas now)
        const url = isNew ? '/financas/create-item/' : '/financas/update-item/';
        if (isNew && financeType === 'receitas') {
             alert('A criação de receitas é feita automaticamente pela conciliação.');
             return;
        }
        
        // Disable submit button to prevent multiple submissions
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Salvando...';

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}' // Ensure CSRF token is correct
            }
        })
        .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
        .then(({ ok, status, data }) => {
            if (ok && data.success) {
                editModal.style.display = "none"; // Close modal on success
                window.location.reload(); // Reload page to see changes
            } else {
                throw new Error(data.error || `Erro ${status} ao salvar`);
            }
        })
        .catch(error => {
            console.error('Error submitting form:', error);
            alert('Erro ao salvar: ' + error.message);
        })
        .finally(() => {
             // Re-enable submit button
             submitButton.disabled = false;
             submitButton.textContent = 'Salvar Alterações';
        });
    });

    // Initialize money masks for all designated inputs
    document.querySelectorAll('.money-input').forEach(element => {
        if (!element.maskRef) { // Avoid re-initializing if already done
             element.maskRef = IMask(element, {
                 mask: 'R$ num',
                 blocks: {
                     num: {
                         mask: Number,
                         scale: 2,
                         thousandsSeparator: '.',
                         padFractionalZeros: true,
                         normalizeZeros: true,
                         radix: ',',
                         mapToRadix: ['.'],
                     }
                 }
             });
        }
    });

    // Add CPF mask (only if element exists)
    const cpfInput = document.getElementById('cpf');
    if (cpfInput) {
        IMask(cpfInput, {
            mask: '000.000.000-00'
        });
    }

    // --- Filter Functionality ---
    const periodFilterBtn = document.getElementById('periodFilterBtn');
    const periodFilter = document.getElementById('periodFilter');
    const customRangeContainer = document.getElementById('customRangeContainer');
    const applyCustomRangeBtn = document.getElementById('applyCustomRangeBtn');
    const statusFilterSelect = document.getElementById('statusFilterSelect'); // Get status select
    
    // Toggle period dropdown
    if(periodFilterBtn && periodFilter){
        periodFilterBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            periodFilter.style.display = periodFilter.style.display === 'none' ? 'block' : 'none';
        });
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (periodFilter && !periodFilter.contains(e.target) && e.target !== periodFilterBtn) {
            periodFilter.style.display = 'none';
        }
    });

    // Function to build URL and navigate
    function applyFilters() {
         const currentUrl = new URL(window.location.href);
         const params = currentUrl.searchParams;

         // Get filter values
         const view = params.get('view') || 'receitas'; // Keep current view
         const search = document.getElementById('searchInput').value;
         const status = statusFilterSelect ? statusFilterSelect.value : ''; // Get status if select exists
         let period = '';
         let startDate = '';
         let endDate = '';
         
         // Determine period from selection or custom inputs
         const selectedOption = periodFilter ? periodFilter.querySelector('.period-option[data-selected]') : null;
         const customOptionSelected = periodFilter ? periodFilter.querySelector('.period-option[data-value="custom"][data-selected]') : null;

         if (customOptionSelected || (customRangeContainer && customRangeContainer.style.display === 'block')) {
             period = 'custom';
             startDate = document.getElementById('customStart').value;
             endDate = document.getElementById('customEnd').value;
             if (!startDate || !endDate) {
                 alert("Selecione as datas de início e fim para o período personalizado.");
                 return; // Don't navigate if custom range is incomplete
             }
         } else if (selectedOption) {
             period = selectedOption.dataset.value;
         }

         // Build new query string
         const newParams = new URLSearchParams();
         newParams.set('view', view);
         if (search) newParams.set('search', search);
         if (status) newParams.set('status', status); // Add status if selected
         if (period) newParams.set('period', period);
         if (period === 'custom' && startDate && endDate) {
             newParams.set('start_date', startDate);
             newParams.set('end_date', endDate);
         }
         
         window.location.href = `?${newParams.toString()}`;
    }

    // Handle period option clicks
    if(periodFilter){
        periodFilter.querySelectorAll('.period-option').forEach(option => {
            option.addEventListener('click', function() {
                // Mark as selected visually (optional, can be done via backend context too)
                periodFilter.querySelectorAll('.period-option').forEach(opt => opt.removeAttribute('data-selected'));
                this.setAttribute('data-selected', '');

                const value = this.dataset.value;
                if (value === 'custom') {
                    if(customRangeContainer) customRangeContainer.style.display = 'block';
                    // Don't navigate yet, wait for apply button or date selection
                } else {
                    if(customRangeContainer) customRangeContainer.style.display = 'none'; // Hide custom range
                    applyFilters(); // Apply filter immediately for predefined periods
                }
                periodFilter.style.display = 'none'; // Hide dropdown after selection (except for custom)
            });
        });
    }
    
    // Handle custom range apply button
    if (applyCustomRangeBtn) {
        applyCustomRangeBtn.addEventListener('click', function() {
             applyFilters(); // Apply filters using custom dates
        });
    }

    // Handle Status filter change
    if (statusFilterSelect) {
         statusFilterSelect.addEventListener('change', applyFilters);
    }


    // Add dynamic search with debounce
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    if(searchInput){
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                applyFilters(); // Apply all filters when search changes
            }, 500); // Wait 500ms after typing
        });
    }


    // --- Add Despesa Modal ---
    function openAddDespesaModal() {
        form.reset(); // Reset form fields
        
        // Setup modal for new despesa
        document.getElementById('modal-action-type').textContent = 'Adicionar';
        document.getElementById('modal-title-type').textContent = 'Despesa';
        document.getElementById('finance_type').value = 'despesas';
        document.getElementById('is_new').value = 'true';
        document.getElementById('is_linked').value = 'false'; // Despesas are never 'linked' in this context
        
        // Show correct fields
        document.getElementById('receitas-fields').style.display = 'none';
        document.getElementById('despesas-fields').style.display = 'block';
        document.getElementById('unlinked-info').style.display = 'none'; 
        
        // Set today's date as default
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('data').value = today;
        
        // Ensure required attributes are set
        document.getElementById('descricao').required = true;
        document.getElementById('valor').required = true;
        document.getElementById('data').required = true;
        
        editModal.style.display = "block";
    }
    window.openAddDespesaModal = openAddDespesaModal; // Make globally accessible


    // --- Delete Buttons ---
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (confirm('Deseja realmente excluir este item? Esta ação não pode ser desfeita.')) {
                const row = this.closest('tr');
                const financeId = row.dataset.id;
                const viewType = '{{ view_type }}'; // Get type from context
                
                const formData = new FormData();
                formData.append('finance_type', viewType);
                formData.append('finance_id', financeId);
                
                fetch('/financas/delete-item/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
                .then(({ ok, status, data }) => {
                     if (ok && data.success) {
                         row.remove(); // Remove the row visually
                         // Optionally show a success message
                         // alert('Item excluído com sucesso.'); 
                     } else {
                         throw new Error(data.error || `Erro ${status} ao excluir`);
                     }
                })
                .catch(error => {
                    console.error('Error deleting item:', error);
                    alert('Erro ao excluir: ' + error.message);
                });
            }
        });
    });
    
    // --- Conciliation Trigger ---
    // Renamed function to avoid conflicts
    window.runConciliation = function() {
         const conciliateButton = document.getElementById('conciliate-btn');
         if (!conciliateButton) return;

         conciliateButton.disabled = true;
         conciliateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Conciliando...';

         fetch('/financas/conciliar/') // Endpoint defined in urls.py
             .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
             .then(({ ok, status, data }) => {
                 if (ok && data.success) {
                     alert(data.message || 'Conciliação concluída.');
                     window.location.reload(); // Reload to see changes
                 } else {
                      throw new Error(data.error || `Erro ${status} durante a conciliação.`);
                 }
             })
             .catch(error => {
                 console.error('Error running conciliation:', error);
                 alert('Erro ao executar conciliação: ' + error.message);
             })
             .finally(() => {
                 // Re-enable button
                 conciliateButton.disabled = false;
                 conciliateButton.innerHTML = '<i class="fas fa-sync"></i> Conciliar';
             });
    }

}); // End DOMContentLoaded

// --- Export Function ---
function exportFinances() {
    const currentUrl = new URL(window.location.href);
    const params = currentUrl.searchParams;
    
    // Construct the export URL with current filters
    const exportUrl = new URL('{% url "export_finances" %}', window.location.origin);
    
    // Append view, status, search, period, start_date, end_date from current params
    if (params.get('view')) exportUrl.searchParams.append('view', params.get('view'));
    if (params.get('status')) exportUrl.searchParams.append('status', params.get('status'));
    if (params.get('search')) exportUrl.searchParams.append('search', params.get('search'));
    if (params.get('period')) exportUrl.searchParams.append('period', params.get('period'));
    if (params.get('start_date')) exportUrl.searchParams.append('start_date', params.get('start_date'));
    if (params.get('end_date')) exportUrl.searchParams.append('end_date', params.get('end_date'));

    // Redirect to trigger download
    window.location.href = exportUrl.toString();
}
</script>

{% endblock %}