{% extends 'layout.html' %}
{% load static %}

{% block title %}Finanças{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/financas.css' %}">
{% endblock %}

{% block content %}
<div class="financas-container">
    <div class="financas-header">
        <h1>Finanças</h1>
        
        <div class="view-toggle">
            <a href="?view=receitas" class="toggle-btn {% if view_type == 'receitas' %}active{% endif %}">Receitas</a>
            <a href="?view=despesas" class="toggle-btn {% if view_type == 'despesas' %}active{% endif %}">Despesas & Custos</a>
        </div>
    </div>
    
    <div class="header-actions">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" placeholder="Buscar guias" value="{{ search_query }}">
        </div>
        
        <div class="status-filter">
            <select>
                <option value="">Status</option>
                {% if view_type == 'receitas' %}
                    <option value="pago" {% if selected_status == 'pago' %}selected{% endif %}>Pago</option>
                    <option value="pendente" {% if selected_status == 'pendente' %}selected{% endif %}>Em andamento</option>
                    <option value="glosa" {% if selected_status == 'glosa' %}selected{% endif %}>Glosa</option>
                {% else %}
                    <option value="a_vencer" {% if selected_status == 'a_vencer' %}selected{% endif %}>A Vencer</option>
                    <option value="pago" {% if selected_status == 'pago' %}selected{% endif %}>Pago</option>
                    <option value="atrasado" {% if selected_status == 'atrasado' %}selected{% endif %}>Pagamento Atrasado</option>
                {% endif %}
            </select>
        </div>
        
        <div class="period-filter">
            <button class="filter-btn" id="periodFilterBtn">
                <i class="fas fa-calendar"></i>
                {% if selected_period %}
                    {% if selected_period == 'custom' %}
                        Personalizado
                    {% elif selected_period == 7 %}Últimos 7 dias
                    {% elif selected_period == 14 %}Últimos 14 dias
                    {% elif selected_period == 30 %}Últimos 30 dias
                    {% elif selected_period == 90 %}Últimos 3 meses
                    {% elif selected_period == 180 %}Últimos 6 meses
                    {% elif selected_period == 365 %}Último ano
                    {% elif selected_period == 540 %}Último 1 ano e meio
                    {% elif selected_period == 730 %}Últimos 2 anos
                    {% endif %}
                {% else %}
                    Filtrar por período
                {% endif %}
            </button>
            <div id="periodFilter" class="period-dropdown" style="display: none;">
                <div class="period-option" data-value="7" {% if selected_period == '7' %}data-selected{% endif %}>Últimos 7 dias</div>
                <div class="period-option" data-value="14" {% if selected_period == '14' %}data-selected{% endif %}>Últimos 14 dias</div>
                <div class="period-option" data-value="30" {% if selected_period == '30' %}data-selected{% endif %}>Últimos 30 dias</div>
                <div class="period-option" data-value="90" {% if selected_period == '90' %}data-selected{% endif %}>Últimos 3 meses</div>
                <div class="period-option" data-value="180" {% if selected_period == '180' %}data-selected{% endif %}>Últimos 6 meses</div>
                <div class="period-option" data-value="365" {% if selected_period == '365' %}data-selected{% endif %}>Último ano</div>
                <div class="period-option" data-value="540" {% if selected_period == '540' %}data-selected{% endif %}>Último 1 ano e meio</div>
                <div class="period-option" data-value="730" {% if selected_period == '730' %}data-selected{% endif %}>Últimos 2 anos</div>
                <div class="period-option" data-value="custom" {% if selected_period == 'custom' %}data-selected{% endif %}>Período Personalizado</div>

                <div id="customRangeContainer" class="custom-range" style="display: none; margin-top: 10px;">
                    <label for="customStart">Início:</label>
                    <input type="date" id="customStart" value="{{ custom_start_date }}" />
                    <label for="customEnd">Fim:</label>
                    <input type="date" id="customEnd" value="{{ custom_end_date }}" />
                    <button type="button" id="applyCustomRangeBtn">Aplicar</button>
                </div>
            </div>
        </div>
        
        <button class="export-btn">
            <i class="fas fa-download"></i>
            Exportar em PDF
        </button>
    </div>

    <div class="financas-table">
        <table>
            <thead>
                <tr>
                    {% if view_type == 'receitas' %}
                        <th>Paciente</th>
                        <th>CPF</th>
                        <th>Data da Cirurgia</th>
                        <th>Valor</th>
                        <th>Fonte Pagadora</th>
                        <th>CPSA</th>
                        <th>Anestesista</th>
                        <th>Situação</th>
                        <th>Data do Pagamento</th>
                        <th>Editar</th>
                    {% else %}
                        <th>Classificação</th>
                        <th>Data</th>
                        <th>Valor</th>
                        <th>Pago</th>
                        <th>Editar</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                    <tr>
                        {% if view_type == 'receitas' %}
                            <td>{{ item.procedimento.nome_paciente }}</td>
                            <td>{{ item.procedimento.cpf_paciente }}</td>
                            <td>{{ item.procedimento.data_horario|date:"d/m/Y" }}</td>
                            <td>R$ {{ item.valor_cobranca|floatformat:2 }}</td>
                            <td>{{ item.get_tipo_cobranca_display }}</td>
                            <td>{{ item.procedimento.convenio }}</td>
                            <td>{{ item.procedimento.anestesistas_responsaveis.first.name }}</td>
                            <td>{{ item.get_status_pagamento_display }}</td>
                            <td>{{ item.data_pagamento|date:"d/m/Y"|default:"-" }}</td>
                            <td><a href="#" class="edit-btn"><i class="fas fa-pen"></i></a></td>
                        {% else %}
                            <td>{{ item.descricao }}</td>
                            <td>{{ item.data|date:"d/m/Y" }}</td>
                            <td>R$ {{ item.valor|floatformat:2 }}</td>
                            <td>{{ item.get_status_display }}</td>
                            <td><a href="#" class="edit-btn"><i class="fas fa-pen"></i></a></td>
                        {% endif %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if view_type == 'despesas' %}
    <button class="add-btn">
        <i class="fas fa-plus"></i>
        Inserir despesa ou custo
    </button>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Search functionality
    const searchInput = document.querySelector('.search-box input');
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('search', this.value);
            window.location.href = currentUrl.toString();
        }
    });

    // Status filter
    const statusSelect = document.querySelector('.status-filter select');
    statusSelect.addEventListener('change', function() {
        const currentUrl = new URL(window.location.href);
        if (this.value) {
            currentUrl.searchParams.set('status', this.value);
        } else {
            currentUrl.searchParams.delete('status');
        }
        window.location.href = currentUrl.toString();
    });
});

// Period filter functionality
document.getElementById('periodFilterBtn').addEventListener('click', function(e) {
    e.stopPropagation();
    const dropdown = document.getElementById('periodFilter');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
});

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.getElementById('periodFilter');
    if (!e.target.closest('.period-filter')) {
        dropdown.style.display = 'none';
    }
});

// Handle period options
document.querySelectorAll('.period-option').forEach(option => {
    option.addEventListener('click', function() {
        const value = this.dataset.value;
        
        // If "custom" was selected, show the date inputs
        if (value === 'custom') {
            document.getElementById('customRangeContainer').style.display = 'block';
        } else {
            // Hide custom range UI if previously shown
            document.getElementById('customRangeContainer').style.display = 'none';

            // Apply the chosen period filter
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('period', value);
            currentUrl.searchParams.delete('start_date');
            currentUrl.searchParams.delete('end_date');
            window.location.href = currentUrl.toString();
        }
    });
});

// Handle custom range application
document.getElementById('applyCustomRangeBtn').addEventListener('click', function() {
    const startInput = document.getElementById('customStart');
    const endInput = document.getElementById('customEnd');
    
    if (startInput.value && endInput.value) {
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.set('period', 'custom');
        currentUrl.searchParams.set('start_date', startInput.value);
        currentUrl.searchParams.set('end_date', endInput.value);
        window.location.href = currentUrl.toString();
    } else {
        alert('Por favor, selecione ambas as datas.');
    }
});
</script>
{% endblock %}
