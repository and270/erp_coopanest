{% extends 'layout.html' %}
{% load static %}
{% load financas_filters %}
{% load humanize %}

{% block title %}Finanças{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/financas.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}

{% block content %}
<div class="financas-container">
    <div class="financas-header">
        <h1>Finanças</h1>
        
        <div class="view-toggle">
            <a href="?view=receitas" class="toggle-btn {% if view_type == 'receitas' %}active{% endif %}">Receitas</a>
            <a href="?view=despesas" class="toggle-btn {% if view_type == 'despesas' %}active{% endif %}">Despesas & Custos</a>
        </div>
    </div>
    
    <div class="header-actions">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Buscar por paciente, CPF, CPSA ou Anestesista" value="{{ search_query }}" autocomplete="off"> {# Updated placeholder #}
        </div>
        
        {% if view_type == 'receitas' %} {# Only show status filter for Receitas #}
        <div class="status-filter">
            <select name="status" id="statusFilterSelect" class="form-select"> {# Added ID for JS if needed #}
                <option value="">Todos Status</option> {# Changed default text #}
                <option value="em_processamento" {% if selected_status == 'em_processamento' %}selected{% endif %}>Em Processamento</option>
                <option value="aguardando_pagamento" {% if selected_status == 'aguardando_pagamento' %}selected{% endif %}>Aguardando Pagamento</option>
                <option value="recurso_de_glosa" {% if selected_status == 'recurso_de_glosa' %}selected{% endif %}>Recurso de Glosa</option>
                <option value="processo_finalizado" {% if selected_status == 'processo_finalizado' %}selected{% endif %}>Processo Finalizado</option>
                <option value="cancelada" {% if selected_status == 'cancelada' %}selected{% endif %}>Cancelada</option>
            </select>
        </div>
        {% endif %}
        
        <div class="period-filter">
            <button class="filter-btn" id="periodFilterBtn">
                <i class="fas fa-calendar"></i>
                {% if selected_period %}
                    {% if selected_period == 'custom' %}
                        Personalizado ({{ custom_start_date|date:"d/m/y" }} - {{ custom_end_date|date:"d/m/y" }}) {# Show range #}
                    {% elif selected_period == '7' %}Últimos 7 dias
                    {% elif selected_period == '14' %}Últimos 14 dias
                    {% elif selected_period == '30' %}Últimos 30 dias
                    {% elif selected_period == '90' %}Últimos 3 meses
                    {% elif selected_period == '180' %}Últimos 6 meses
                    {% elif selected_period == '365' %}Último ano
                    {% elif selected_period == '540' %}Último 1 ano e meio
                    {% elif selected_period == '730' %}Últimos 2 anos
                    {% endif %}
                {% else %}
                    Filtrar por período
                {% endif %}
            </button>
            <div id="periodFilter" class="period-dropdown" style="display: none;">
                <div class="period-option" data-value="7" {% if selected_period == '7' %}data-selected{% endif %}>Últimos 7 dias</div>
                <div class="period-option" data-value="14" {% if selected_period == '14' %}data-selected{% endif %}>Últimos 14 dias</div>
                <div class="period-option" data-value="30" {% if selected_period == '30' %}data-selected{% endif %}>Últimos 30 dias</div>
                <div class="period-option" data-value="90" {% if selected_period == '90' %}data-selected{% endif %}>Últimos 3 meses</div>
                <div class="period-option" data-value="180" {% if selected_period == '180' %}data-selected{% endif %}>Últimos 6 meses</div>
                <div class="period-option" data-value="365" {% if selected_period == '365' %}data-selected{% endif %}>Último ano</div>
                <div class="period-option" data-value="540" {% if selected_period == '540' %}data-selected{% endif %}>Último 1 ano e meio</div>
                <div class="period-option" data-value="730" {% if selected_period == '730' %}data-selected{% endif %}>Últimos 2 anos</div>
                <div class="period-option" data-value="custom" {% if selected_period == 'custom' %}data-selected{% endif %}>Período Personalizado</div>

                <div id="customRangeContainer" class="custom-range" {% if selected_period != 'custom' %}style="display: none;"{% endif %}> {# Show if custom selected #}
                    <label for="customStart">Início:</label>
                    <input type="date" id="customStart" value="{{ custom_start_date }}" />
                    <label for="customEnd">Fim:</label>
                    <input type="date" id="customEnd" value="{{ custom_end_date }}" />
                    <button type="button" id="applyCustomRangeBtn">Aplicar</button>
                </div>
            </div>
        </div>
        
        <button class="export-btn" onclick="exportFinances()">
            <i class="fas fa-file-excel"></i> Exportar {# Added icon #}
        </button>

        {% if active_role == 'gestor' or user.is_superuser %}
        <button id="conciliate-header-btn" class="refresh-btn" onclick="runConciliation()" title="Conciliar Dados da API">
            <i class="fas fa-sync"></i>
        </button>
        {% endif %}
        
    </div>

    <div id="top-scrollbar-wrapper" class="top-scrollbar-wrapper">
        <div id="top-scrollbar-content"></div>
    </div>

    <div class="financas-table" id="main-table-wrapper">
        <table>
            <thead>
                <tr>
                    {% if view_type == 'receitas' %}
                        <th>Paciente</th>
                        <th>CPF</th>
                        <th>Nasc.</th>
                        <th>Data Cirurgia</th>
                        <th>Horário</th>
                        <th>Eletiva / Urgência</th>
                        {% if user_group_name == 'Américas' or user_group_name == 'AMCRJ - SERVICOS MEDICOS LTDA' %}<th>Plantão/Eletiva</th>{% endif %}
                        <th>Acomod.</th>
                        <th>Valor Faturado</th>
                        <th>Valor Recebido</th>
                        <th>Valor Recuperado</th>
                        <th>Valor a Recuperar</th>
                        <th>Fonte Pagadora</th>
                        <th>Forma de Pagamento</th>
                        <th>CPSA</th>
                        <th>Matrícula</th>
                        <th>Senha</th>
                        <th>Cooperado</th>
                        <th>Anestesistas</th>
                        <th>Cirurgião</th>
                        <th>Situação</th>
                        <th>Data Pagamento</th>
                        <th>Ações</th> {# Renamed Header #}
                    {% else %} {# Despesas Headers #}
                        <th>Tipo</th>
                        <th>Descrição</th>
                        <th>Data</th>
                        <th>Valor</th>
                        <th>Periodicidade</th>
                        <th>Status</th>
                        <th>Ações</th> {# Renamed Header #}
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                    <tr data-id="{{ item.id }}">
                        {% if view_type == 'receitas' %}
                            {# Use procedure data if available, otherwise fallback to API data #}
                            <td>
                                {% if item.procedimento %}
                                    {{ item.procedimento.nome_paciente }}
                                {% else %}
                                    {{ item.api_paciente_nome|default:"(Não vinculado)" }}
                                {% endif %}
                            </td>
                            <td>{{ item.procedimento.cpf_paciente|default:"--" }}</td> {# CPF only if linked #}
                            <td>{{ item.procedimento.data_nascimento|date:"d/m/Y"|default:"--" }}</td>
                            <td>
                                {% if item.procedimento and item.procedimento.data_horario %}
                                    {{ item.procedimento.data_horario|date:"d/m/Y" }}
                                {% elif item.api_data_cirurgia %}
                                    {{ item.api_data_cirurgia|date:"d/m/Y" }}
                                {% else %}
                                    --
                                {% endif %}
                            </td>
                            <td>
                                {% if item.procedimento and item.procedimento.data_horario %}
                                    {{ item.procedimento.data_horario|date:"H:i" }}{% if item.procedimento.data_horario_fim %} - {{ item.procedimento.data_horario_fim|date:"H:i" }}{% endif %}
                                {% else %}
                                    --
                                {% endif %}
                            </td>
                            <td>
                                {% if item.procedimento %}
                                    {{ item.procedimento.get_tipo_procedimento_display|default:"--" }}
                                {% else %}
                                    --
                                {% endif %}
                            </td>
                            {% if user_group_name == 'Américas' or user_group_name == 'AMCRJ - SERVICOS MEDICOS LTDA' %}
                                <td>{{ item.plantao_eletiva|default:"--" }}</td>
                            {% endif %}
                            <td>{{ item.procedimento.acomodacao|default:"--" }}</td>
                            {# Revert to original formatting #}
                            <td>{% if item.valor_faturado is not None %}R$ {{ item.valor_faturado|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{% if item.valor_recebido is not None %}R$ {{ item.valor_recebido|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{% if item.valor_recuperado is not None %}R$ {{ item.valor_recuperado|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{% if item.valor_acatado is not None %}R$ {{ item.valor_acatado|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{{ item.get_tipo_cobranca_display|default:"--" }}</td>
                            <td>
                                {% if item.tipo_cobranca == 'particular' %}
                                    {{ item.get_tipo_pagamento_direto_display|default:"--" }}
                                {% else %}
                                    --
                                {% endif %}
                            </td>
                            <td>{{ item.get_cpsa_display|default:"--" }}</td>
                            <td>{{ item.matricula|default:"--" }}</td>
                            <td>{{ item.senha|default:"--" }}</td>
                            <td>
                                {% if item.procedimento and item.procedimento.cooperado %}
                                    {{ item.procedimento.cooperado.name }}
                                {% else %}
                                    {{ item.api_cooperado_nome|default:"--" }}
                                {% endif %}
                            </td>
                            <td>
                                {% if item.procedimento %}
                                    {{ item.procedimento.anestesistas_livres|default:"--" }}
                                {% else %}
                                    --
                                {% endif %}
                            </td>
                            <td>
                                {% if item.procedimento and item.procedimento.cirurgiao %}
                                    {{ item.procedimento.cirurgiao.name }}{% if item.procedimento.cirurgiao.crm %} ({{ item.procedimento.cirurgiao.crm }}){% endif %}
                                {% elif item.procedimento and item.procedimento.cirurgiao_nome %}
                                    {{ item.procedimento.cirurgiao_nome }}
                                {% else %}
                                    --
                                {% endif %}
                            </td>
                            <td>{{ item.get_status_pagamento_display|default:"--" }}</td>
                            <td>{{ item.data_pagamento|date:"d/m/Y"|default:"-" }}</td>
                            <td>
                                <div class="action-buttons"> {# Wrap buttons #}
                                    <button type="button" class="edit-btn action-btn" title="Editar">
                                        <i class="fas fa-pen"></i>
                                    </button>
                                    <button type="button" class="delete-btn action-btn" title="Excluir"> {# Changed from cancel #}
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        {% else %} {# Despesas Row #}
                            {% if item.item_type == 'despesa' %}
                                <td><span class="badge badge-despesa">Despesa</span></td>
                                <td>{{ item.descricao }}</td>
                                <td>{{ item.data|date:"d/m/Y" }}</td>
                                {# Revert to original formatting #}
                                <td>{% if item.valor is not None %}R$ {{ item.valor|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                                <td>--</td>
                                <td>{% if item.pago %}Pago{% else %}Pendente{% endif %}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button type="button" class="edit-btn action-btn" title="Editar" data-type="despesas">
                                            <i class="fas fa-pen"></i>
                                        </button>
                                        <button type="button" class="delete-btn action-btn" title="Excluir" data-type="despesas">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            {% else %} {# Despesa Recorrente #}
                                <td><span class="badge badge-recorrente">Recorrente</span></td>
                                <td>{{ item.descricao }}</td>
                                <td>{{ item.data_inicio|date:"d/m/Y" }}</td>
                                {# Revert to original formatting #}
                                <td>{% if item.valor is not None %}R$ {{ item.valor|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                                <td>{{ item.get_periodicidade_display_short }}</td>
                                <td>{% if item.ativa %}Ativa{% else %}Inativa{% endif %}</td>
                                <td>
                                    <div class="action-buttons">
                                        <button type="button" class="edit-btn action-btn" title="Editar" data-type="despesas_recorrentes">
                                            <i class="fas fa-pen"></i>
                                        </button>
                                        <button type="button" class="delete-btn action-btn" title="Excluir" data-type="despesas_recorrentes">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            {% endif %}
                        {% endif %}
                    </tr>
                {% empty %}
                <tr>
                   <td colspan="{% if view_type == 'receitas' %}{% if user_group_name == 'Américas' or user_group_name == 'AMCRJ - SERVICOS MEDICOS LTDA' %}23{% else %}22{% endif %}{% else %}7{% endif %}" style="text-align: center; padding: 20px;">Nenhum item encontrado para os filtros selecionados.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if items.has_other_pages %}
    <div class="pagination">
        {% if items.has_previous %}
            <a href="?page=1{% if view_type %}&view={{ view_type }}{% endif %}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_period %}&period={{ selected_period }}{% endif %}{% if custom_start_date %}&start_date={{ custom_start_date }}{% endif %}{% if custom_end_date %}&end_date={{ custom_end_date }}{% endif %}" class="pagination-btn">&laquo; Primeiro</a>
            <a href="?page={{ items.previous_page_number }}{% if view_type %}&view={{ view_type }}{% endif %}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_period %}&period={{ selected_period }}{% endif %}{% if custom_start_date %}&start_date={{ custom_start_date }}{% endif %}{% if custom_end_date %}&end_date={{ custom_end_date }}{% endif %}" class="pagination-btn">Anterior</a>
        {% endif %}

        <span class="pagination-current">
            Página {{ items.number }} de {{ items.paginator.num_pages }}
        </span>

        {% if items.has_next %}
            <a href="?page={{ items.next_page_number }}{% if view_type %}&view={{ view_type }}{% endif %}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_period %}&period={{ selected_period }}{% endif %}{% if custom_start_date %}&start_date={{ custom_start_date }}{% endif %}{% if custom_end_date %}&end_date={{ custom_end_date }}{% endif %}" class="pagination-btn">Próxima</a>
            <a href="?page={{ items.paginator.num_pages }}{% if view_type %}&view={{ view_type }}{% endif %}{% if search_query %}&search={{ search_query|urlencode }}{% endif %}{% if selected_status %}&status={{ selected_status }}{% endif %}{% if selected_period %}&period={{ selected_period }}{% endif %}{% if custom_start_date %}&start_date={{ custom_start_date }}{% endif %}{% if custom_end_date %}&end_date={{ custom_end_date }}{% endif %}" class="pagination-btn">Último &raquo;</a>
        {% endif %}
    </div>
    {% endif %}
    
    {% if view_type == 'despesas' %}
    <div class="add-buttons-container">
        <button class="add-btn" onclick="openAddDespesaModal()">
            <i class="fas fa-plus"></i>
            Inserir despesa ou custo
        </button>
        <button class="add-btn btn-recorrente" onclick="openAddDespesaRecorrenteModal()">
            <i class="fas fa-sync-alt"></i>
            Inserir despesa recorrente
        </button>
    </div>
    {% endif %}
    {% if view_type == 'receitas' %}
    <button class="add-btn" onclick="openAddReceitaModal()">
        <i class="fas fa-plus"></i>
         Inserir Receita / Guia Manualmente
    </button>
    {% endif %}
</div>

{# --- Edit Modal --- #}
<div id="edit-finance-modal" class="modal">
    <div class="modal-content">
        <span class="close" data-modal-id="edit-finance-modal">&times;</span>
        <h2><span id="modal-action-type">Editar</span> <span id="modal-title-type"></span></h2>
        
        <form id="edit-finance-form">
            {% csrf_token %}
            <input type="hidden" id="finance_id" name="finance_id">
            <input type="hidden" id="finance_type" name="finance_type">
            <input type="hidden" id="is_new" name="is_new" value="false">
            <input type="hidden" id="is_linked" name="is_linked" value="false"> {# Add hidden field for linked status #}
            
            {# Display basic info for unlinked items #}
            <div id="unlinked-info" style="display: none; margin-bottom: 15px; padding: 10px; background-color: #f0f0f0; border-radius: 4px;">
                <strong>Item não vinculado a um procedimento.</strong><br>
                Paciente (API): <span id="unlinked-paciente"></span><br>
                Data Cirurgia (API): <span id="unlinked-data"></span>
            </div>
            
            {# Add fields for manual creation - Shown only when adding unlinked Receita #}
             <div id="manual-receita-fields">
                 <div class="form-group">
                     <label for="manual_api_paciente_nome">Nome Paciente (Manual)</label>
                     <input type="text" id="manual_api_paciente_nome" name="api_paciente_nome">
                 </div>
                 <div class="form-group">
                     <label for="manual_api_data_cirurgia">Data Cirurgia (Manual)</label>
                     <input type="date" id="manual_api_data_cirurgia" name="api_data_cirurgia">
                 </div>
                 <div class="form-group">
                     <label for="manual_api_cooperado_nome">Nome Cooperado (Manual)</label>
                     <input type="text" id="manual_api_cooperado_nome" name="api_cooperado_nome">
                 </div>
                 <div class="form-group">
                     <label for="manual_api_hospital_nome">Nome Hospital (Manual)</label>
                     <input type="text" id="manual_api_hospital_nome" name="api_hospital_nome">
                 </div>
             </div>

            <!-- Receitas fields (Shared for edit and manual add) -->
            <div id="receitas-fields">
                 {# Show CPF only if linked during EDIT #}
                <div class="form-group" id="cpf-group">
                    <label for="cpf">CPF do Paciente</label>
                    <input type="text" id="cpf" name="cpf">
                </div>
                 <div class="form-group">
                    <label for="valor_faturado">Valor Faturado</label>
                    <input type="text" class="money-input form-control" id="valor_faturado" name="valor_faturado">
                </div>
                 <div class="form-group">
                    <label for="valor_recebido">Valor Recebido</label>
                    <input type="text" class="money-input form-control" id="valor_recebido" name="valor_recebido">
                </div>
                <div class="form-group">
                    <label for="valor_recuperado">Valor Recuperado</label>
                    <input type="text" class="money-input form-control" id="valor_recuperado" name="valor_recuperado">
                </div>
                <div class="form-group">
                    <label for="valor_acatado">Valor a Recuperar</label>
                    <input type="text" class="money-input form-control" id="valor_acatado" name="valor_acatado">
                </div>
                <div class="form-group">
                    <label for="status_pagamento">Status do Pagamento</label>
                    <select id="status_pagamento" name="status_pagamento">
                        <option value="em_processamento">Em Processamento</option>
                        <option value="aguardando_pagamento">Aguardando Pagamento</option>
                        <option value="recurso_de_glosa">Recurso de Glosa</option>
                        <option value="processo_finalizado">Processo Finalizado</option>
                        <option value="cancelada">Cancelada</option>
                    </select>
                </div>
                <div class="form-group" id="tipo-cobranca-group">
                    <label for="tipo_cobranca">Tipo de Cobrança</label>
                    <select id="tipo_cobranca" name="tipo_cobranca">
                        <option value="cooperativa">Cooperativa</option>
                        <option value="hospital">Hospital</option>
                        {% if user_group_name == 'Américas' or user_group_name == 'AMCRJ - SERVICOS MEDICOS LTDA' %}
                            <option value="coi">COI</option>
                            <option value="amil">Amil</option>
                        {% endif %}
                        <option value="particular">Direta</option>
                        <option value="via_cirurgiao">Via Cirurgião</option>
                        <option value="cortesia">Cortesia</option>
                    </select>
                </div>
                <div class="form-group" id="data-pagamento-group">
                    <label for="data_pagamento">Data do Pagamento</label>
                    <input type="date" id="data_pagamento" name="data_pagamento">
                </div>
                <div class="form-group" id="cpsa-group">
                    <label for="cpsa">CPSA</label>
                    <input type="text" id="cpsa" name="cpsa">
                </div>
                <div class="form-group" id="matricula-group">
                    <label for="matricula">Matrícula</label>
                    <input type="text" id="matricula" name="matricula">
                </div>
                <div class="form-group" id="senha-group">
                    <label for="senha">Senha</label>
                    <input type="text" id="senha" name="senha">
                </div>
                <div class="form-group" id="cooperado-group">
                    <label for="cooperado">Cooperado</label>
                    <input type="text" id="cooperado" name="cooperado" placeholder="Se vinculado, exibido como leitura">
                </div>
                <div class="form-group" id="anest-livres-group" style="display: none;">
                    <label for="anestesistas_livres">Anestesistas (livre)</label>
                    <input type="text" id="anestesistas_livres" name="anestesistas_livres" placeholder="Separar por vírgula">
                </div>
                <div class="form-group" id="tipo-pagamento-direto-group" style="display: none;">
                    <label for="tipo_pagamento_direto">Tipo de Pagamento (Direta)</label>
                    <select id="tipo_pagamento_direto" name="tipo_pagamento_direto">
                        <option value="cartao">Cartão</option>
                        <option value="cheque">Cheque</option>
                        <option value="dinheiro">Dinheiro</option>
                        <option value="pix">Pix</option>
                        <option value="transferencia">Transferência</option>
                        <option value="boleto">Boleto</option>
                    </select>
                </div>
            </div>

            <!-- Despesas fields -->
            <div id="despesas-fields">
                 <div class="form-group">
                    <label for="descricao">Descrição</label>
                    <input type="text" id="descricao" name="descricao" required>
                </div>
                <div class="form-group">
                    <label for="valor">Valor</label>
                    <input type="text" class="money-input" id="valor" name="valor" required>
                </div>
                <div class="form-group">
                    <label for="data">Data</label>
                    <input type="date" id="data" name="data" required>
                </div>
                <div class="form-group">
                    <label>
                        Pago
                        <input type="checkbox" id="pago" name="pago">
                    </label>
                </div>
            </div>

            <!-- Despesas Recorrentes fields -->
            <div id="despesas-recorrentes-fields">
                <div class="form-group">
                    <label for="descricao_recorrente">Descrição</label>
                    <input type="text" id="descricao_recorrente" name="descricao" required>
                </div>
                <div class="form-group">
                    <label for="valor_recorrente">Valor</label>
                    <input type="text" class="money-input" id="valor_recorrente" name="valor_recorrente" required>
                </div>
                <div class="form-group">
                    <label for="periodicidade">Periodicidade</label>
                    <select id="periodicidade" name="periodicidade" required>
                        <option value="">Selecione a periodicidade</option>
                        <option value="diaria">Diária</option>
                        <option value="semanal">Semanal</option>
                        <option value="quinzenal">Quinzenal</option>
                        <option value="mensal">Mensal</option>
                        <option value="semestral">Semestral</option>
                        <option value="anual">Anual</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="data_inicio">Data de Início</label>
                    <input type="date" id="data_inicio" name="data_inicio" required>
                </div>
                <div class="form-group">
                    <label>
                        Ativa
                        <input type="checkbox" id="ativa" name="ativa" checked>
                    </label>
                </div>
            </div>

            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">Salvar</button> {# Changed text #}
            </div>
        </form>
    </div>
</div>


{# --- SCRIPTS --- #}
<script src="https://unpkg.com/imask"></script> {# Keep iMask #}

<script>
document.addEventListener('DOMContentLoaded', function() {
    // --- Double Scrollbar Synchronization ---
    const topWrapper = document.getElementById('top-scrollbar-wrapper');
    const topContent = document.getElementById('top-scrollbar-content');
    const tableWrapper = document.getElementById('main-table-wrapper');
    
    if (topWrapper && tableWrapper) {
        const table = tableWrapper.querySelector('table');
        
        const updateTopScroll = () => {
            const tableWidth = table.scrollWidth;
            const wrapperWidth = tableWrapper.clientWidth;
            
            if (tableWidth > wrapperWidth) {
                topWrapper.style.display = 'block';
                topContent.style.width = tableWidth + 'px';
                // Sync initial positions
                topWrapper.scrollLeft = tableWrapper.scrollLeft;
            } else {
                topWrapper.style.display = 'none';
            }
        };

        // Initial update
        setTimeout(updateTopScroll, 100); // Small delay to ensure table is rendered
        
        window.addEventListener('resize', updateTopScroll);
        
        // Use a mutation observer to update when table content changes (e.g. search)
        const observer = new MutationObserver(updateTopScroll);
        observer.observe(table, { childList: true, subtree: true });

        // Sync scrolls
        topWrapper.onscroll = function() {
            tableWrapper.scrollLeft = topWrapper.scrollLeft;
        };
        tableWrapper.onscroll = function() {
            topWrapper.scrollLeft = tableWrapper.scrollLeft;
        };
    }

    const form = document.getElementById('edit-finance-form');
    const editModal = document.getElementById('edit-finance-modal'); 
    
    // --- Generalized Modal Close Logic ---
    document.querySelectorAll('.modal .close').forEach(closeBtn => {
        closeBtn.onclick = function() {
            const modalId = this.getAttribute('data-modal-id');
            if (modalId) {
                const modalToClose = document.getElementById(modalId);
                if (modalToClose) {
                    modalToClose.style.display = "none";
                }
            }
        }
    });

    // Close modal when clicking outside
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }

    // Function to toggle fields based on 'Tipo de Cobrança' for Receitas
    function toggleReceitaFieldsVisibility() {
        const financeType = document.getElementById('finance_type').value;
        if (financeType !== 'receitas') return; // Only run for receitas

        const tipoCobranca = document.getElementById('tipo_cobranca').value;
        const cpsaGroup = document.getElementById('cpsa-group');
        const tipoPagamentoDiretoGroup = document.getElementById('tipo-pagamento-direto-group');
        const isLinked = document.getElementById('is_linked').value === 'true'; // Check linked status
        const isNew = document.getElementById('is_new').value === 'true'; // Check if adding new
            const anestLivresGroup = document.getElementById('anest-livres-group');

        // Hide specific groups by default
        if (cpsaGroup) cpsaGroup.style.display = 'none';
        if (tipoPagamentoDiretoGroup) tipoPagamentoDiretoGroup.style.display = 'none';
            if (anestLivresGroup) anestLivresGroup.style.display = 'none';
        
        // Show CPSA only if 'cooperativa'
        if (tipoCobranca === 'cooperativa' && cpsaGroup) {
             cpsaGroup.style.display = 'block';
        } 
        // Show Payment Type only if 'particular'
        else if (tipoCobranca === 'particular' && tipoPagamentoDiretoGroup) {
             tipoPagamentoDiretoGroup.style.display = 'block';
        } else if (tipoCobranca === 'cortesia') {
             if (tipoPagamentoDiretoGroup) tipoPagamentoDiretoGroup.style.display = 'none';
             // Ensure valores are zero for cortesia where applicable in UI
             ['valor_faturado','valor_recebido','valor_recuperado','valor_acatado'].forEach(id => {
                 const el = document.getElementById(id);
                 if (el?.maskRef) { el.maskRef.unmaskedValue = '0'; }
                 else if (el) { el.value = '0'; }
             });
        }
        
        // Show/hide CPF group based on linked status (only relevant when editing)
        const cpfGroup = document.getElementById('cpf-group');
        if (cpfGroup) {
             cpfGroup.style.display = isLinked && !isNew ? 'block' : 'none';
        }

            // Show free-text anestesistas only when linked (editing linked procedure)
            if (anestLivresGroup) {
                anestLivresGroup.style.display = isLinked && !isNew ? 'block' : 'none';
            }

        // Show/hide Manual fields based on isNew status (relevant when adding)
        const manualFieldsDiv = document.getElementById('manual-receita-fields');
         if (manualFieldsDiv) {
             manualFieldsDiv.style.display = isNew ? 'block' : 'none';
             // Set required attribute for manual fields when adding
             document.getElementById('manual_api_paciente_nome').required = isNew;
             document.getElementById('manual_api_data_cirurgia').required = isNew;
             // CPSA might be optional if not cooperativa
             document.getElementById('cpsa').required = isNew && tipoCobranca === 'cooperativa'; 
         } else {
             // If editing, ensure manual fields are not required
             document.getElementById('manual_api_paciente_nome').required = false;
             document.getElementById('manual_api_data_cirurgia').required = false;
             // document.getElementById('cpsa').required = false; // CPSA might still be required based on type
         }

        // Show/Hide Unlinked Info Panel (only relevant when editing)
        const unlinkedInfoPanel = document.getElementById('unlinked-info');
         if(unlinkedInfoPanel){
             unlinkedInfoPanel.style.display = !isLinked && !isNew ? 'block' : 'none';
         }
    }

    const tipoCobrancaSelect = document.getElementById('tipo_cobranca');
    if (tipoCobrancaSelect) {
        tipoCobrancaSelect.addEventListener('change', toggleReceitaFieldsVisibility);
    }
    
    // Function to toggle Data Pagamento visibility based on Status for Receitas
    function toggleDataPagamentoVisibility() {
         const financeType = document.getElementById('finance_type').value;
         if (financeType !== 'receitas') return;

         const statusSelect = document.getElementById('status_pagamento');
         const dataPagamentoGroup = document.getElementById('data-pagamento-group'); // Use group ID
         const dataPagamentoInput = document.getElementById('data_pagamento');

         if (!statusSelect || !dataPagamentoGroup || !dataPagamentoInput) return; // Elements might not exist if despesas

         const status = statusSelect.value;
         if (status === 'processo_finalizado' || status === 'recurso_de_glosa') { 
             dataPagamentoGroup.style.display = 'block';
             dataPagamentoInput.required = true;
         } else {
             dataPagamentoGroup.style.display = 'none';
             dataPagamentoInput.required = false;
             dataPagamentoInput.value = ''; 
         }
    }
    
    const statusPagamentoSelect = document.getElementById('status_pagamento');
     if (statusPagamentoSelect) {
         statusPagamentoSelect.addEventListener('change', toggleDataPagamentoVisibility);
     }


    // Handle edit button clicks
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const row = this.closest('tr');
            const financeId = row.dataset.id;
            const viewType = '{{ view_type }}';
            const dataType = this.getAttribute('data-type'); // Get the specific type for despesas
            
            // Reset form and modal state for EDIT
            form.reset();
            document.getElementById('modal-action-type').textContent = 'Editar';
            document.getElementById('finance_id').value = financeId;
            document.getElementById('is_new').value = 'false'; // EDITING

            // Show/hide field sections AND set required attributes
            if (viewType === 'receitas') {
                document.getElementById('finance_type').value = viewType;
                document.getElementById('manual-receita-fields').style.display = 'none'; // Hide manual fields
                document.getElementById('receitas-fields').style.display = 'block';
                document.getElementById('despesas-fields').style.display = 'none';
                document.getElementById('despesas-recorrentes-fields').style.display = 'none';
                document.getElementById('modal-title-type').textContent = 'Receita';
                // Remove required from despesas fields
                document.getElementById('descricao').required = false;
                document.getElementById('valor').required = false;
                document.getElementById('data').required = false;
                document.getElementById('descricao_recorrente').required = false;
                document.getElementById('valor_recorrente').required = false;
                document.getElementById('periodicidade').required = false;
                document.getElementById('data_inicio').required = false;
            } else if (dataType === 'despesas') { // Normal despesas
                document.getElementById('finance_type').value = 'despesas';
                document.getElementById('manual-receita-fields').style.display = 'none';
                document.getElementById('receitas-fields').style.display = 'none';
                document.getElementById('despesas-fields').style.display = 'block';
                document.getElementById('despesas-recorrentes-fields').style.display = 'none';
                document.getElementById('modal-title-type').textContent = 'Despesa';
                // Set required for despesas fields
                document.getElementById('descricao').required = true;
                document.getElementById('valor').required = true;
                document.getElementById('data').required = true;
                // Remove required from other fields
                document.getElementById('descricao_recorrente').required = false;
                document.getElementById('valor_recorrente').required = false;
                document.getElementById('periodicidade').required = false;
                document.getElementById('data_inicio').required = false;
            } else { // despesas_recorrentes
                document.getElementById('finance_type').value = 'despesas_recorrentes';
                document.getElementById('manual-receita-fields').style.display = 'none';
                document.getElementById('receitas-fields').style.display = 'none';
                document.getElementById('despesas-fields').style.display = 'none';
                document.getElementById('despesas-recorrentes-fields').style.display = 'block';
                document.getElementById('modal-title-type').textContent = 'Despesa Recorrente';
                // Set required for despesas recorrentes fields
                document.getElementById('descricao_recorrente').required = true;
                document.getElementById('valor_recorrente').required = true;
                document.getElementById('periodicidade').required = true;
                document.getElementById('data_inicio').required = true;
                // Remove required from other fields
                document.getElementById('descricao').required = false;
                document.getElementById('valor').required = false;
                document.getElementById('data').required = false;
            }
            
            // Fetch item data - use different endpoint for despesas recorrentes
            let fetchUrl = `/financas/get-item/${viewType}/${financeId}/`;
            if (dataType === 'despesas_recorrentes') {
                fetchUrl = `/financas/get-despesa-recorrente/${financeId}/`;
            }
            
            fetch(fetchUrl)
                .then(response => {
                    if (!response.ok) {
                         return response.json().then(err => { throw new Error(err.error || `Erro ${response.status}`) });
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data for edit:', data);
                    const isLinked = data.is_linked === true; // Ensure boolean
                    document.getElementById('is_linked').value = isLinked ? 'true' : 'false';

                    if (viewType === 'receitas') {
                         // Populate common Receita fields
                         const valorInputs = [
                             { elem: document.getElementById('valor_faturado'), value: data.valor_faturado },
                             { elem: document.getElementById('valor_recebido'), value: data.valor_recebido },
                             { elem: document.getElementById('valor_recuperado'), value: data.valor_recuperado },
                             { elem: document.getElementById('valor_acatado'), value: data.valor_acatado },
                         ];
                         valorInputs.forEach(({elem, value}) => {
                              if (elem?.maskRef) elem.maskRef.unmaskedValue = String(value || '0');
                         });
                         document.getElementById('status_pagamento').value = data.status_pagamento || 'em_processamento';
                         document.getElementById('data_pagamento').value = data.data_pagamento || '';
                         document.getElementById('tipo_cobranca').value = data.tipo_cobranca || 'cooperativa';
                         document.getElementById('cpsa').value = data.cpsa || '';
                         document.getElementById('matricula').value = data.matricula || '';
                         document.getElementById('senha').value = data.senha || '';
                         document.getElementById('cpf').value = data.cpf || ''; // Populate CPF if available
                         
                         if (data.tipo_pagamento_direto) {
                              document.getElementById('tipo_pagamento_direto').value = data.tipo_pagamento_direto;
                         } else {
                              document.getElementById('tipo_pagamento_direto').value = 'cartao'; 
                         }
                         
                         // Show info panel ONLY if not linked during edit
                         const unlinkedInfoPanel = document.getElementById('unlinked-info');
                         if (!isLinked) {
                             unlinkedInfoPanel.style.display = 'block';
                             document.getElementById('unlinked-paciente').textContent = data.paciente_nome || 'N/A'; // Uses combined field from view
                             document.getElementById('unlinked-data').textContent = data.data_cirurgia ? new Date(data.data_cirurgia + 'T00:00:00').toLocaleDateString('pt-BR') : 'N/A';
                         } else {
                              unlinkedInfoPanel.style.display = 'none';
                         }

                         // Populate cooperado/anestesistas livres for display/edit
                         const coopInput = document.getElementById('cooperado');
                         const livresInput = document.getElementById('anestesistas_livres');
                         if (coopInput) {
                             coopInput.value = data.cooperado || '';
                             // If linked, we can make it readonly to avoid confusion for now
                             coopInput.readOnly = isLinked;
                         }
                         if (livresInput) {
                             livresInput.value = data.anestesistas_livres || '';
                         }

        // Trigger visibility updates AFTER populating
                         toggleReceitaFieldsVisibility();
                         toggleDataPagamentoVisibility(); 

                    } else if (dataType === 'despesas') { // despesas normais
                         document.getElementById('descricao').value = data.descricao || '';
                         const valorInput = document.getElementById('valor');
                         if(valorInput?.maskRef) valorInput.maskRef.unmaskedValue = String(data.valor || '0');
                         document.getElementById('data').value = data.data || '';
                         document.getElementById('pago').checked = data.pago || false;
                    } else { // despesas recorrentes
                         document.getElementById('descricao_recorrente').value = data.descricao || '';
                         const valorRecorrenteInput = document.getElementById('valor_recorrente');
                         if(valorRecorrenteInput?.maskRef) valorRecorrenteInput.maskRef.unmaskedValue = String(data.valor || '0');
                         document.getElementById('periodicidade').value = data.periodicidade || '';
                         document.getElementById('data_inicio').value = data.data_inicio || '';
                         document.getElementById('ativa').checked = data.ativa || false;
                    }
                    
                    editModal.style.display = "block";
                })
                .catch(error => {
                    console.error('Error fetching item data:', error);
                    alert(`Erro ao carregar os dados: ${error.message}`);
                });
        });
    });

    // --- Add Receita Modal (now triggered by header button) ---
     window.openAddReceitaModal = function() {
         form.reset(); // Clear previous data

         document.getElementById('modal-action-type').textContent = 'Adicionar';
         document.getElementById('modal-title-type').textContent = 'Receita (Manual)';
         document.getElementById('finance_type').value = 'receitas';
         document.getElementById('is_new').value = 'true'; // ADDING NEW
         document.getElementById('is_linked').value = 'false'; // Manual adds are unlinked
         document.getElementById('finance_id').value = ''; // No ID for new item

         // Show/Hide sections for ADDING RECEITA
         document.getElementById('manual-receita-fields').style.display = 'block'; // Show manual fields
         document.getElementById('receitas-fields').style.display = 'block'; // Show common receita fields
         document.getElementById('despesas-fields').style.display = 'none';
         document.getElementById('unlinked-info').style.display = 'none'; // Hide info panel
        
         // Remove required from hidden despesas fields
         document.getElementById('descricao').required = false;
         document.getElementById('valor').required = false;
         document.getElementById('data').required = false;


          // Clear potentially pre-filled fields from edit mode AND explicitly clear money fields
         const valorInputs = ['valor_faturado', 'valor_recebido', 'valor_recuperado', 'valor_acatado'];
         valorInputs.forEach(id => {
              const elem = document.getElementById(id);
              if (elem?.maskRef) {
                  elem.maskRef.unmaskedValue = ''; // Set unmasked value to empty string
              } else if (elem) {
                  elem.value = ''; // Fallback for non-masked or if maskRef is missing
              }
         });
         // Also clear non-money receita fields that might persist after reset
         document.getElementById('status_pagamento').value = 'em_processamento'; // Default status
         document.getElementById('tipo_cobranca').value = 'cooperativa'; // Default type? Or blank?
         document.getElementById('cpsa').value = ''; 
         document.getElementById('matricula').value = '';
         document.getElementById('senha').value = '';
         document.getElementById('data_pagamento').value = '';
         document.getElementById('tipo_pagamento_direto').value = 'cartao'; // Reset direct payment too

         // Trigger visibility updates for the default state ('cooperativa')
         toggleReceitaFieldsVisibility(); 
         toggleDataPagamentoVisibility(); 
         
         editModal.style.display = "block";
     }

    // Handle form submission (UPDATED)
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Disable unused form sections to prevent field conflicts
        const financeType = document.getElementById('finance_type').value;
        const isNew = document.getElementById('is_new').value === 'true';
        
        // Disable fields in unused sections to prevent them from being submitted
        if (financeType === 'receitas') {
            // Disable despesas fields
            document.querySelectorAll('#despesas-fields input, #despesas-fields select').forEach(input => input.disabled = true);
            document.querySelectorAll('#despesas-recorrentes-fields input, #despesas-recorrentes-fields select').forEach(input => input.disabled = true);
        } else if (financeType === 'despesas') {
            // Disable receitas and despesas recorrentes fields
            document.querySelectorAll('#receitas-fields input, #receitas-fields select').forEach(input => input.disabled = true);
            document.querySelectorAll('#manual-receita-fields input').forEach(input => input.disabled = true);
            document.querySelectorAll('#despesas-recorrentes-fields input, #despesas-recorrentes-fields select').forEach(input => input.disabled = true);
        } else if (financeType === 'despesas_recorrentes') {
            // Disable receitas and normal despesas fields
            document.querySelectorAll('#receitas-fields input, #receitas-fields select').forEach(input => input.disabled = true);
            document.querySelectorAll('#manual-receita-fields input').forEach(input => input.disabled = true);
            document.querySelectorAll('#despesas-fields input, #despesas-fields select').forEach(input => input.disabled = true);
        }
        
        const formData = new FormData(this);
        
        // Data Preparation (money fields)
        let valueFields = [];
        if (financeType === 'receitas') {
             valueFields = ['valor_faturado', 'valor_recebido', 'valor_recuperado', 'valor_acatado'];
        } else if (financeType === 'despesas') {
             valueFields = ['valor'];
        } else { // despesas_recorrentes
             valueFields = ['valor_recorrente'];
        }
        valueFields.forEach(name => {
             const elem = document.getElementById(name);
             if (elem && elem.maskRef) {
                 formData.set(name, elem.maskRef.unmaskedValue || '0');
             } else if (elem) { // Fallback
                 let valor = elem.value.replace('R$ ', '').replace(/\./g, '').replace(',', '.');
                 formData.set(name, parseFloat(valor) || '0');
             }
        });
         // Handle checkboxes
         if (financeType === 'despesas' && !formData.has('pago')) {
             formData.set('pago', ''); 
         }
         if (financeType === 'despesas_recorrentes' && !formData.has('ativa')) {
             formData.set('ativa', ''); 
         }
        
        // Validation (simplified example) -> Can be removed if relying solely on native HTML5 validation now
        /* 
        let validationError = false;
        if (financeType === 'receitas') {
             const status = formData.get('status_pagamento');
             const dataPagamento = formData.get('data_pagamento');
             if ((status === 'processo_finalizado' || status === 'recurso_de_glosa') && !dataPagamento) {
                 alert('Data de pagamento é obrigatória para o status selecionado.');
                 validationError = true;
             }
             // Add validation for manual fields if isNew
             if(isNew){
                  if(!formData.get('api_paciente_nome')) { alert('Nome do Paciente (Manual) é obrigatório.'); validationError = true; }
                  if(!formData.get('api_data_cirurgia')) { alert('Data da Cirurgia (Manual) é obrigatória.'); validationError = true; }
                  if(formData.get('tipo_cobranca') === 'cooperativa' && !formData.get('cpsa')){ alert('CPSA é obrigatório para tipo Cooperativa.'); validationError = true; }
             }
        } else { // Despesas
             // This check is now handled by the required attribute, can be removed
             // if (!formData.get('descricao') || !formData.get('valor') || !formData.get('data')) {
             //     alert('Preencha todos os campos obrigatórios para despesas.');
             //     validationError = true;
             // }
        }
        // if (validationError) return; // Stop if validation failed
        */
        
        // Determine URL based on type and action
        let url = '';
        if (isNew) {
             if (financeType === 'receitas') {
                 url = '/financas/create-receita/'; // NEW endpoint for manual receita
             } else if (financeType === 'despesas') {
                 url = '/financas/create-item/'; 
             } else { // despesas_recorrentes
                 url = '/financas/create-despesa-recorrente/';
             }
        } else { // Editing existing item
             if (financeType === 'despesas_recorrentes') {
                 url = '/financas/update-despesa-recorrente/';
             } else {
                 url = '/financas/update-item/';
             }
        }
        
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        submitButton.textContent = 'Salvando...';

        fetch(url, {
            method: 'POST',
            body: formData,
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        })
        .then(response => response.json().then(data => ({ ok: response.ok, status: response.status, data })))
        .then(({ ok, status, data }) => {
            if (ok && data.success) {
                editModal.style.display = "none"; 
                window.location.reload(); 
            } else {
                throw new Error(data.error || `Erro ${status} ao salvar`);
            }
        })
        .catch(error => {
            console.error('Error submitting form:', error);
            alert('Erro ao salvar: ' + error.message);
        })
        .finally(() => {
             submitButton.disabled = false;
             submitButton.textContent = 'Salvar'; // Reset button text
             
             // Re-enable all form fields after submission
             document.querySelectorAll('#edit-finance-form input, #edit-finance-form select').forEach(input => {
                 input.disabled = false;
             });
        });
    });

    // Initialize money masks for all designated inputs
    document.querySelectorAll('.money-input').forEach(element => {
        if (!element.maskRef) { 
             element.maskRef = IMask(element, {
                 mask: 'R$ num',
                 blocks: { num: { mask: Number, scale: 2, thousandsSeparator: '.', padFractionalZeros: true, normalizeZeros: true, radix: ',', mapToRadix: ['.'], } }
             });
        }
    });

    // Also initialize mask for valor_recorrente specifically (in case it was added dynamically)
    const valorRecorrenteInput = document.getElementById('valor_recorrente');
    if (valorRecorrenteInput && !valorRecorrenteInput.maskRef) {
        valorRecorrenteInput.maskRef = IMask(valorRecorrenteInput, {
            mask: 'R$ num',
            blocks: { num: { mask: Number, scale: 2, thousandsSeparator: '.', padFractionalZeros: true, normalizeZeros: true, radix: ',', mapToRadix: ['.'], } }
        });
    }

    // Add CPF mask (only if element exists)
    const cpfInput = document.getElementById('cpf');
    if (cpfInput) {
        IMask(cpfInput, { mask: '000.000.000-00' });
    }

    // --- Filter Functionality (no changes needed here) ---
    const periodFilterBtn = document.getElementById('periodFilterBtn');
    const periodFilter = document.getElementById('periodFilter');
    const customRangeContainer = document.getElementById('customRangeContainer');
    const applyCustomRangeBtn = document.getElementById('applyCustomRangeBtn');
    const statusFilterSelect = document.getElementById('statusFilterSelect'); 
    
    if(periodFilterBtn && periodFilter){
        periodFilterBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            periodFilter.style.display = periodFilter.style.display === 'none' ? 'block' : 'none';
        });
    }

    document.addEventListener('click', function(e) {
        if (periodFilter && !periodFilter.contains(e.target) && e.target !== periodFilterBtn) {
            periodFilter.style.display = 'none';
        }
    });

    function applyFilters() {
         const currentUrl = new URL(window.location.href);
         const params = currentUrl.searchParams;
         const view = params.get('view') || 'receitas'; 
         const search = document.getElementById('searchInput').value;
         const status = statusFilterSelect ? statusFilterSelect.value : ''; 
         let period = '';
         let startDate = '';
         let endDate = '';
         const selectedOption = periodFilter ? periodFilter.querySelector('.period-option[data-selected]') : null;
         const customOptionSelected = periodFilter ? periodFilter.querySelector('.period-option[data-value="custom"][data-selected]') : null;

         if (customOptionSelected || (customRangeContainer && customRangeContainer.style.display === 'block')) {
             period = 'custom';
             startDate = document.getElementById('customStart').value;
             endDate = document.getElementById('customEnd').value;
             if (!startDate || !endDate) { alert("Selecione as datas de início e fim."); return; }
         } else if (selectedOption) {
             period = selectedOption.dataset.value;
         }

         const newParams = new URLSearchParams();
         newParams.set('view', view);
         if (search) newParams.set('search', search);
         if (status) newParams.set('status', status); 
         if (period) newParams.set('period', period);
         if (period === 'custom' && startDate && endDate) {
             newParams.set('start_date', startDate);
             newParams.set('end_date', endDate);
         }
         window.location.href = `?${newParams.toString()}`;
    }

    if(periodFilter){
        periodFilter.querySelectorAll('.period-option').forEach(option => {
            option.addEventListener('click', function() {
                periodFilter.querySelectorAll('.period-option').forEach(opt => opt.removeAttribute('data-selected'));
                this.setAttribute('data-selected', '');
                const value = this.dataset.value;
                if (value === 'custom') {
                    if(customRangeContainer) customRangeContainer.style.display = 'block';
                } else {
                    if(customRangeContainer) customRangeContainer.style.display = 'none'; 
                    applyFilters(); 
                }
                // Keep dropdown open only for custom range selection
                if (value !== 'custom') {
                     periodFilter.style.display = 'none';
                }
            });
        });
    }
    
    if (applyCustomRangeBtn) {
        applyCustomRangeBtn.addEventListener('click', function() {
             applyFilters(); 
        });
    }

    if (statusFilterSelect) {
         statusFilterSelect.addEventListener('change', applyFilters);
    }

    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    if(searchInput){
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(applyFilters, 500); 
        });
    }

    // --- Add Despesa Modal Trigger ---
    window.openAddDespesaModal = function() { // Keep existing Despesa add function
        form.reset(); 
        document.getElementById('modal-action-type').textContent = 'Adicionar';
        document.getElementById('modal-title-type').textContent = 'Despesa';
        document.getElementById('finance_type').value = 'despesas';
        document.getElementById('is_new').value = 'true';
        document.getElementById('is_linked').value = 'false'; 
        document.getElementById('manual-receita-fields').style.display = 'none'; 
        document.getElementById('receitas-fields').style.display = 'none';
        document.getElementById('despesas-fields').style.display = 'block';
        document.getElementById('despesas-recorrentes-fields').style.display = 'none';
        document.getElementById('unlinked-info').style.display = 'none'; 
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('data').value = today;
        // Ensure required is set for despesas fields
        document.getElementById('descricao').required = true;
        document.getElementById('valor').required = true;
        document.getElementById('data').required = true;
        // Remove required from hidden receitas fields (optional but good practice)
        document.getElementById('manual_api_paciente_nome').required = false;
        document.getElementById('manual_api_data_cirurgia').required = false;
        // Remove required from hidden despesas recorrentes fields
        document.getElementById('descricao_recorrente').required = false;
        document.getElementById('valor_recorrente').required = false;
        document.getElementById('periodicidade').required = false;
        document.getElementById('data_inicio').required = false;

        editModal.style.display = "block";
    }

    // --- Add Despesa Recorrente Modal Trigger ---
    window.openAddDespesaRecorrenteModal = function() {
        form.reset(); 
        document.getElementById('modal-action-type').textContent = 'Adicionar';
        document.getElementById('modal-title-type').textContent = 'Despesa Recorrente';
        document.getElementById('finance_type').value = 'despesas_recorrentes';
        document.getElementById('is_new').value = 'true';
        document.getElementById('is_linked').value = 'false'; 
        document.getElementById('manual-receita-fields').style.display = 'none'; 
        document.getElementById('receitas-fields').style.display = 'none';
        document.getElementById('despesas-fields').style.display = 'none';
        document.getElementById('despesas-recorrentes-fields').style.display = 'block';
        document.getElementById('unlinked-info').style.display = 'none'; 
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('data_inicio').value = today;
        document.getElementById('ativa').checked = true;
        // Ensure required is set for despesas recorrentes fields
        document.getElementById('descricao_recorrente').required = true;
        document.getElementById('valor_recorrente').required = true;
        document.getElementById('periodicidade').required = true;
        document.getElementById('data_inicio').required = true;
        // Remove required from hidden fields
        document.getElementById('manual_api_paciente_nome').required = false;
        document.getElementById('manual_api_data_cirurgia').required = false;
        document.getElementById('descricao').required = false;
        document.getElementById('valor').required = false;
        document.getElementById('data').required = false;

        editModal.style.display = "block";
    }

    // --- Delete Buttons ---
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault(); e.stopPropagation();
            if (confirm('Deseja realmente excluir este item?')) {
                const row = this.closest('tr');
                const financeId = row.dataset.id;
                const viewType = '{{ view_type }}';
                const dataType = this.getAttribute('data-type');
                const formData = new FormData();
                
                // Determine the finance_type and URL based on data-type
                let financeType = viewType;
                let deleteUrl = '/financas/delete-item/';
                
                if (dataType === 'despesas_recorrentes') {
                    financeType = 'despesas_recorrentes';
                    deleteUrl = '/financas/delete-despesa-recorrente/';
                } else if (dataType === 'despesas') {
                    financeType = 'despesas';
                }
                
                formData.append('finance_type', financeType);
                formData.append('finance_id', financeId);
                
                fetch(deleteUrl, {
                    method: 'POST', body: formData, headers: { 'X-CSRFToken': '{{ csrf_token }}' }
                })
                .then(response => response.json().then(data => ({ ok: response.ok, data })))
                .then(({ ok, data }) => {
                     if (ok && data.success) { row.remove(); } 
                     else { throw new Error(data.error || 'Erro ao excluir'); }
                })
                .catch(error => { console.error('Error deleting:', error); alert('Erro: ' + error.message); });
            }
        });
    });
    
    // --- Conciliation Trigger ---
    window.runConciliation = function() {
         const conciliateButton = document.getElementById('conciliate-header-btn'); // Target Header button now
         if (!conciliateButton) return;
         conciliateButton.disabled = true;
         conciliateButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>'; // Just spinner
        fetch('/financas/conciliar/') 
            .then(async (response) => {
                if (response.redirected) {
                    window.location.href = response.url;
                    // Stop further handling since we're navigating away
                    return Promise.reject('redirected');
                }
                const contentType = response.headers.get('content-type') || '';
                const isJson = contentType.includes('application/json');
                const data = isJson ? await response.json() : {};
                return { ok: response.ok, status: response.status, data };
            })
            .then(({ ok, status, data }) => {
                if (ok && data.success) {
                    alert(data.message || 'Conciliação concluída.');
                    window.location.reload(); 
                    return;
                }
                if (status === 401) {
                    const target = (data && data.redirect_url) || '/login/';
                    window.location.href = target;
                    return;
                }
                throw new Error((data && data.error) || 'Erro durante a conciliação.');
            })
            .catch(error => { 
                if (error === 'redirected') return;
                console.error('Error conciliation:', error); 
                alert('Erro: ' + (error?.message || error)); 
            })
            .finally(() => {
                conciliateButton.disabled = false;
                conciliateButton.innerHTML = '<i class="fas fa-sync"></i>'; // Reset icon
            });
    }

    // --- Re-focus on search input after search ---
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('search') && urlParams.get('search')) {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.focus();
            // Move cursor to the end of the input
            const val = searchInput.value;
            searchInput.setSelectionRange(val.length, val.length);
        }
    }

}); // End DOMContentLoaded

// --- Export Function (no changes needed) ---
function exportFinances() {
    const currentUrl = new URL(window.location.href);
    const params = currentUrl.searchParams;
    const exportUrl = new URL('{% url "export_finances" %}', window.location.origin);
    params.forEach((value, key) => { // Copy all current filters
        exportUrl.searchParams.append(key, value);
    });
    window.location.href = exportUrl.toString();
}
</script>

{% endblock %}