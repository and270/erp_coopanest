{% extends 'layout.html' %}
{% load static %}
{% load financas_filters %}
{% load humanize %}

{% block title %}Finanças{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/financas.css' %}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
{% endblock %}

{% block content %}
<div class="financas-container">
    <div class="financas-header">
        <h1>Finanças</h1>
        
        <div class="view-toggle">
            <a href="?view=receitas" class="toggle-btn {% if view_type == 'receitas' %}active{% endif %}">Receitas</a>
            <a href="?view=despesas" class="toggle-btn {% if view_type == 'despesas' %}active{% endif %}">Despesas & Custos</a>
        </div>
    </div>
    
    <div class="header-actions">
        <div class="search-box">
            <i class="fas fa-search"></i>
            <input type="text" id="searchInput" placeholder="Buscar guias" value="{{ search_query }}" autocomplete="off">
        </div>
        
        <div class="status-filter">
            <select name="status" class="form-select">
                <option value="">Todos</option>
                <option value="em_processamento" {% if selected_status == 'em_processamento' %}selected{% endif %}>Em Processamento</option>
                <option value="aguardando_pagamento" {% if selected_status == 'aguardando_pagamento' %}selected{% endif %}>Aguardando Pagamento</option>
                <option value="recurso_de_glosa" {% if selected_status == 'recurso_de_glosa' %}selected{% endif %}>Recurso de Glosa</option>
                <option value="processo_finalizado" {% if selected_status == 'processo_finalizado' %}selected{% endif %}>Processo Finalizado</option>
                <option value="cancelada" {% if selected_status == 'cancelada' %}selected{% endif %}>Cancelada</option>
            </select>
        </div>
        
        <div class="period-filter">
            <button class="filter-btn" id="periodFilterBtn">
                <i class="fas fa-calendar"></i>
                {% if selected_period %}
                    {% if selected_period == 'custom' %}
                        Personalizado
                    {% elif selected_period == '7' %}Últimos 7 dias
                    {% elif selected_period == '14' %}Últimos 14 dias
                    {% elif selected_period == '30' %}Últimos 30 dias
                    {% elif selected_period == '90' %}Últimos 3 meses
                    {% elif selected_period == '180' %}Últimos 6 meses
                    {% elif selected_period == '365' %}Último ano
                    {% elif selected_period == '540' %}Último 1 ano e meio
                    {% elif selected_period == '730' %}Últimos 2 anos
                    {% endif %}
                {% else %}
                    Filtrar por período
                {% endif %}
            </button>
            <div id="periodFilter" class="period-dropdown" style="display: none;">
                <div class="period-option" data-value="7" {% if selected_period == '7' %}data-selected{% endif %}>Últimos 7 dias</div>
                <div class="period-option" data-value="14" {% if selected_period == '14' %}data-selected{% endif %}>Últimos 14 dias</div>
                <div class="period-option" data-value="30" {% if selected_period == '30' %}data-selected{% endif %}>Últimos 30 dias</div>
                <div class="period-option" data-value="90" {% if selected_period == '90' %}data-selected{% endif %}>Últimos 3 meses</div>
                <div class="period-option" data-value="180" {% if selected_period == '180' %}data-selected{% endif %}>Últimos 6 meses</div>
                <div class="period-option" data-value="365" {% if selected_period == '365' %}data-selected{% endif %}>Último ano</div>
                <div class="period-option" data-value="540" {% if selected_period == '540' %}data-selected{% endif %}>Último 1 ano e meio</div>
                <div class="period-option" data-value="730" {% if selected_period == '730' %}data-selected{% endif %}>Últimos 2 anos</div>
                <div class="period-option" data-value="custom" {% if selected_period == 'custom' %}data-selected{% endif %}>Período Personalizado</div>

                <div id="customRangeContainer" class="custom-range" style="display: none;">
                    <label for="customStart">Início:</label>
                    <input type="date" id="customStart" value="{{ custom_start_date }}" />
                    <label for="customEnd">Fim:</label>
                    <input type="date" id="customEnd" value="{{ custom_end_date }}" />
                    <button type="button" id="applyCustomRangeBtn">Aplicar</button>
                </div>
            </div>
        </div>
        
        <button class="export-btn" onclick="exportFinances()">
            Exportar
        </button>
        
    </div>

    <div class="financas-table">
        <table>
            <thead>
                <tr>
                    {% if view_type == 'receitas' %}
                        <th>Paciente</th>
                        <th>CPF</th>
                        <th>Data da Cirurgia</th>
                        <th>Valor Faturado</th>
                        <th>Valor Recebido</th>
                        <th>Valor Recuperado</th>
                        <th>Valor a Recuperar</th>
                        <th>Fonte Pagadora</th>
                        <th>CPSA</th>
                        <th>Anestesista</th>
                        <th>Situação</th>
                        <th>Data do Pagamento</th>
                        <th>Editar</th>
                    {% else %}
                        <th>Descrição</th>
                        <th>Data</th>
                        <th>Valor Faturado</th>
                        <th>Valor Recebido</th>
                        <th>Valor Recuperado</th>
                        <th>Valor a Recuperar</th>
                        <th>Pago</th>
                        <th>Editar</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for item in items %}
                    <tr data-id="{{ item.id }}">
                        {% if view_type == 'receitas' %}
                            <td>{{ item.procedimento.nome_paciente }}</td>
                            <td>{{ item.procedimento.cpf_paciente }}</td>
                            <td>{{ item.procedimento.data_horario|date:"d/m/Y" }}</td>
                            <td>{% if item.valor_faturado %}R$ {{ item.valor_faturado|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{% if item.valor_recebido %}R$ {{ item.valor_recebido|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{% if item.valor_recuperado %}R$ {{ item.valor_recuperado|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{% if item.valor_acatado %}R$ {{ item.valor_acatado|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{{ item.get_tipo_cobranca_display|default:"" }}</td>
                            <td>{{ item.get_cpsa_display }}</td>
                            <td>{{ item.procedimento.anestesistas_responsaveis.first.name }}</td>
                            <td>{{ item.get_status_pagamento_display }}</td>
                            <td>{{ item.data_pagamento|date:"d/m/Y"|default:"-" }}</td>
                            <td>
                                <button type="button" class="edit-btn" title="Editar">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button type="button" class="cancel-btn" title="Cancelar" style="margin-left: 5px;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        {% else %}
                            <td>{{ item.descricao }}</td>
                            <td>{{ item.data|date:"d/m/Y" }}</td>
                            <td>{% if item.valor %}R$ {{ item.valor|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{% if item.valor %}R$ {{ item.valor|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{% if item.valor %}R$ {{ item.valor|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{% if item.valor %}R$ {{ item.valor|floatformat:2|intcomma|replace:',.' }}{% else %}R$ --{% endif %}</td>
                            <td>{% if item.pago %}Pago{% else %}Não Pago{% endif %}</td>
                            <td>
                                <button type="button" class="edit-btn" title="Editar">
                                    <i class="fas fa-pen"></i>
                                </button>
                                <button type="button" class="cancel-btn" title="Cancelar" style="margin-left: 5px;">
                                    <i class="fas fa-times"></i>
                                </button>
                            </td>
                        {% endif %}
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    {% if view_type == 'despesas' %}
    <button class="add-btn" onclick="openAddDespesaModal()">
        <i class="fas fa-plus"></i>
        Inserir despesa ou custo
    </button>
    {% endif %}
</div>

<div id="edit-finance-modal" class="modal">
    <div class="modal-content">
        <span class="close" data-modal-id="edit-finance-modal">&times;</span>
        <h2><span id="modal-action-type">Editar</span> <span id="modal-title-type"></span></h2>
        
        <form id="edit-finance-form">
            {% csrf_token %}
            <input type="hidden" id="finance_id" name="finance_id">
            <input type="hidden" id="finance_type" name="finance_type">
            <input type="hidden" id="is_new" name="is_new" value="false">
            
            <!-- Receitas fields -->
            <div id="receitas-fields">
                <div class="form-group">
                    <label for="valor_faturado">Valor Faturado</label>
                    <input type="text" class="money-input form-control" id="valor_faturado" name="valor_faturado">
                </div>
                <div class="form-group">
                    <label for="valor_recebido">Valor Recebido</label>
                    <input type="text" class="money-input form-control" id="valor_recebido" name="valor_recebido">
                </div>
                <div class="form-group">
                    <label for="valor_recuperado">Valor Recuperado</label>
                    <input type="text" class="money-input form-control" id="valor_recuperado" name="valor_recuperado">
                </div>
                <div class="form-group">
                    <label for="valor_acatado">Valor a Recuperar</label>
                    <input type="text" class="money-input form-control" id="valor_acatado" name="valor_acatado">
                </div>
                <div class="form-group">
                    <label for="status_pagamento">Status do Pagamento</label>
                    <select id="status_pagamento" name="status_pagamento">
                        <option value="em_processamento">Em Processamento</option>
                        <option value="aguardando_pagamento">Aguardando Pagamento</option>
                        <option value="recurso_de_glosa">Recurso de Glosa</option>
                        <option value="processo_finalizado">Processo Finalizado</option>
                        <option value="cancelada">Cancelada</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="tipo_cobranca">Tipo de Cobrança</label>
                    <select id="tipo_cobranca" name="tipo_cobranca">
                        <option value="cooperativa">Cooperativa</option>
                        <option value="hospital">Hospital</option>
                        <option value="particular">Direta</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="data_pagamento">Data do Pagamento</label>
                    <input type="date" id="data_pagamento" name="data_pagamento">
                </div>
                <div class="form-group">
                    <label for="cpf">CPF do Paciente</label>
                    <input type="text" id="cpf" name="cpf">
                </div>
                <div class="form-group" id="cpsa-group">
                    <label for="cpsa">CPSA</label>
                    <input type="text" id="cpsa" name="cpsa">
                </div>
                <div class="form-group" id="tipo-pagamento-direto-group" style="display: none;">
                    <label for="tipo_pagamento_direto">Tipo de Pagamento</label>
                    <select id="tipo_pagamento_direto" name="tipo_pagamento_direto">
                        <option value="cartao">Cartão</option>
                        <option value="cheque">Cheque</option>
                        <option value="dinheiro">Dinheiro</option>
                        <option value="pix">Pix</option>
                        <option value="transferencia">Transferência</option>
                        <option value="boleto">Boleto</option>
                    </select>
                </div>
            </div>

            <!-- Despesas fields -->
            <div id="despesas-fields">
                <div class="form-group">
                    <label for="descricao">Descrição</label>
                    <input type="text" id="descricao" name="descricao" required>
                </div>
                <div class="form-group">
                    <label for="valor">Valor</label>
                    <input type="text" class="money-input" id="valor" name="valor" required>
                </div>
                <div class="form-group">
                    <label for="data">Data</label>
                    <input type="date" id="data" name="data" required>
                </div>
                <div class="form-group">
                    <label>
                        Pago
                        <input type="checkbox" id="pago" name="pago">
                    </label>
                </div>
                               
            </div>

            <div class="modal-actions">
                <button type="submit" class="btn btn-primary">Salvar Alterações</button>
            </div>
        </form>
    </div>
</div>

<div id="conciliation-modal" class="modal">
    <div class="modal-content">
        <span class="close" data-modal-id="conciliation-modal">&times;</span>
        <h2>Conciliação de Dados</h2>
        
        <div id="conciliation-cards">
            <!-- Cards will be inserted here -->
        </div>
        
        <div id="no-matches" style="display: none;">
            <p>Não há dados para conciliar no momento.</p>
        </div>
    </div>
</div>

<!-- New Modal for Unmatched Guides -->
<div id="unmatched-guias-modal" class="modal">
    <div class="modal-content">
        <span class="close" data-modal-id="unmatched-guias-modal">&times;</span>
        <h2>Guias da API Não Encontradas no Coopahub</h2>
        <p>Para que os procedimentos a seguir sejam conciliados, eles precisam estar registrados no módulo Agendamento e depois finalizados no módulo de Qualidade</p>
        <div id="unmatched-guias-list">
            <!-- Unmatched guides will be listed here -->
            <table>
                <thead>
                    <tr>
                        <th>CPSA ID</th>
                        <th>Paciente</th>
                        <th>Data</th>
                        <th>Valor</th>
                        <th>Status</th>
                        <th>Hospital</th>
                        <th>Cooperado</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows will be added dynamically -->
                </tbody>
            </table>
        </div>
        
        <div id="no-unmatched-guias" style="display: none;">
            <p>Não há guias não encontradas para exibir.</p>
        </div>
    </div>
</div>

<button id="unmatched-guias-fab" onclick="showUnmatchedGuiasModal()" title="Ver Guias Não Encontradas">
    <i class="fas fa-question-circle"></i>
</button>

<script src="https://unpkg.com/imask"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('edit-finance-form');
    const editModal = document.getElementById('edit-finance-modal'); // Keep reference if needed elsewhere

    // --- REMOVE THIS OLD Specific Close Logic ---
    // const closeBtn = editModal.querySelector('.close');
    // closeBtn.onclick = function() {
    //     editModal.style.display = "none";
    // }
    // -------------------------------------------
    
    // --- ADD THIS Generalized Modal Close Logic ---
    document.querySelectorAll('.modal .close').forEach(closeBtn => {
        closeBtn.onclick = function() {
            const modalId = this.getAttribute('data-modal-id');
            if (modalId) {
                const modalToClose = document.getElementById(modalId);
                if (modalToClose) {
                    modalToClose.style.display = "none";
                }
            }
        }
    });
    // ----------------------------------------------

    // Close modal when clicking outside (for all modals) - Keep this
    window.onclick = function(event) {
        if (event.target.classList.contains('modal')) {
            event.target.style.display = "none";
        }
    }

    function toggleFields() {
        const tipoCobranca = document.getElementById('tipo_cobranca').value;
        const cpsaGroup = document.getElementById('cpsa-group');
        const tipoPagamentoDiretoGroup = document.getElementById('tipo-pagamento-direto-group');

        console.log("toggleFields() called. Current tipo_cobranca:", tipoCobranca);

        // Hide both fields by default
        cpsaGroup.style.display = 'none';
        tipoPagamentoDiretoGroup.style.display = 'none';

        console.log("Initially hid both #cpsa-group and #tipo-pagamento-direto-group.");

        // Show appropriate fields based on selection
        if (tipoCobranca === 'cooperativa') {
            cpsaGroup.style.display = 'block';
            console.log("tipo_cobranca is cooperativa → showing #cpsa-group.");
        } else if (tipoCobranca === 'particular') {
            tipoPagamentoDiretoGroup.style.display = 'block';
            console.log("tipo_cobranca is particular → showing #tipo-pagamento-direto-group.");
        }
    }

    const tipoCobrancaSelect = document.getElementById('tipo_cobranca');
    tipoCobrancaSelect.addEventListener('change', toggleFields);

    // Handle edit button clicks
    document.querySelectorAll('.edit-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            const row = this.closest('tr');
            const viewType = '{{ view_type }}';
            const financeId = row.dataset.id;
            toggleFields();
            
            // Show appropriate fields and set required attributes
            if (viewType === 'receitas') {
                document.getElementById('receitas-fields').style.display = 'block';
                document.getElementById('despesas-fields').style.display = 'none';
                
                // Remove required attribute from despesas fields
                const despesasFields = document.getElementById('despesas-fields').querySelectorAll('[required]');
                despesasFields.forEach(field => field.removeAttribute('required'));
                
                // Set required for relevant receitas fields
                document.getElementById('valor_faturado').setAttribute('required', '');
                document.getElementById('valor_recebido').setAttribute('required', '');
                document.getElementById('valor_recuperado').setAttribute('required', '');
                document.getElementById('valor_acatado').setAttribute('required', '');
                document.getElementById('status_pagamento').setAttribute('required', '');
            } else {
                document.getElementById('receitas-fields').style.display = 'none';
                document.getElementById('despesas-fields').style.display = 'block';
                // Set required for despesas fields
                document.getElementById('descricao').required = true;
                document.getElementById('valor').required = true;
                // Remove required from receitas fields
                document.getElementById('valor_faturado').required = false;
                document.getElementById('valor_recebido').required = false;
                document.getElementById('valor_recuperado').required = false;
                document.getElementById('valor_acatado').required = false;
                document.getElementById('status_pagamento').required = false;
                document.getElementById('data_pagamento').required = false;
            }
            
            document.getElementById('modal-title-type').textContent = viewType === 'receitas' ? 'Receita' : 'Despesa';
            
            // Fetch item data
            fetch(`/financas/get-item/${viewType}/${financeId}/`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('Received data:', data);
                    document.getElementById('finance_id').value = financeId;
                    document.getElementById('finance_type').value = viewType;
                    
                    if (viewType === 'receitas') {
                        // Apply mask to money inputs
                        const valorInputs = [
                            document.getElementById('valor_faturado'),
                            document.getElementById('valor_recebido'),
                            document.getElementById('valor_recuperado'),
                            document.getElementById('valor_acatado')
                        ];
                        
                        // Initialize IMask for each valor input if not already initialized
                        valorInputs.forEach((input, index) => {
                            const fieldNames = ['valor_faturado', 'valor_recebido', 'valor_recuperado', 'valor_acatado'];
                            const fieldValue = data[fieldNames[index]];
                            
                            // Create mask if not already created
                            if (!input.maskRef) {
                                input.maskRef = IMask(input, {
                                    mask: 'R$ num',
                                    blocks: {
                                        num: {
                                            mask: Number,
                                            thousandsSeparator: '.',
                                            radix: ',',
                                            scale: 2,
                                            padFractionalZeros: true,
                                            normalizeZeros: true,
                                            mapToRadix: ['.']
                                        }
                                    }
                                });
                            }
                            
                            // Set the value through the mask
                            if (fieldValue) {
                                input.maskRef.unmaskedValue = String(fieldValue);
                            } else {
                                input.maskRef.unmaskedValue = '0';
                            }
                        });
                        
                        document.getElementById('status_pagamento').value = data.status_pagamento;
                        document.getElementById('data_pagamento').value = data.data_pagamento || '';
                        document.getElementById('tipo_cobranca').value = data.tipo_cobranca || 'cooperativa';
                        toggleFields();
                        document.getElementById('cpf').value = data.cpf || '';
                        document.getElementById('cpsa').value = data.cpsa || '';
                        toggleDataPagamento();
                        if (data.tipo_pagamento_direto) {
                            document.getElementById('tipo_pagamento_direto').value = data.tipo_pagamento_direto;
                        }
                    } else {
                        document.getElementById('descricao').value = data.descricao;
                        const valorInput = document.getElementById('valor');
                        valorInput.value = data.valor ? 
                            `R$ ${parseFloat(data.valor).toLocaleString('pt-BR', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            })}` : 'R$ 0,00';
                    }
                    
                    editModal.style.display = "block";
                })
                .catch(error => {
                    console.error('Error fetching data:', error);
                    alert('Erro ao carregar os dados');
                });
        });
    });

    // Handle form submission
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const formData = new FormData(this);
        const viewType = formData.get('finance_type');
        const isNew = formData.get('is_new') === 'true';
        
        // Remove required attribute from hidden fields
        if (viewType === 'receitas') {
            const despesasFields = document.getElementById('despesas-fields').querySelectorAll('[required]');
            despesasFields.forEach(field => field.removeAttribute('required'));
        } else {
            const receitasFields = document.getElementById('receitas-fields').querySelectorAll('[required]');
            receitasFields.forEach(field => field.removeAttribute('required'));
        }
        
        // Validate required fields based on view type
        if (viewType === 'receitas') {
            if (!formData.get('valor_faturado') || !formData.get('valor_recebido') || !formData.get('valor_recuperado') || !formData.get('valor_acatado') || !formData.get('status_pagamento')) {
                alert('Por favor, preencha todos os campos obrigatórios');
                return;
            }
            
            // If status is 'pago' or 'glosa', data_pagamento is required
            if ((formData.get('status_pagamento') === 'pago' || formData.get('status_pagamento') === 'glosa') 
                && !formData.get('data_pagamento')) {
                alert('Data de pagamento é obrigatória para status Pago ou Glosa');
                return;
            }
        } else {
            // Validate despesas fields
            if (!formData.get('descricao') || !formData.get('valor') || !formData.get('data')) {
                alert('Por favor, preencha todos os campos obrigatórios');
                return;
            }
        }
        
        // Convert money values from "R$ 1.234,56" to "1234.56"
        if (viewType === 'receitas') {
            const valorInputs = [
                { elem: document.getElementById('valor_faturado'), name: 'valor_faturado' },
                { elem: document.getElementById('valor_recebido'), name: 'valor_recebido' },
                { elem: document.getElementById('valor_recuperado'), name: 'valor_recuperado' },
                { elem: document.getElementById('valor_acatado'), name: 'valor_acatado' }
            ];
            
            valorInputs.forEach(({elem, name}) => {
                if (elem.maskRef) {
                    // Get the unmasked value directly from IMask
                    // Parse it as a float first to ensure it's in correct format
                    const rawValue = elem.maskRef.unmaskedValue;
                    // Convert to decimal format with dot as decimal separator
                    const valor = parseFloat(rawValue).toString();
                    // Set the value in the FormData
                    formData.set(name, valor);
                } else {
                    // Fallback to manual conversion if maskRef is not available
                    let valor = elem.value.replace('R$ ', '').replace(/\./g, '').replace(',', '.');
                    formData.set(name, valor);
                }
            });
        } else {
            // For despesas
            const valorInput = document.getElementById('valor');
            if (valorInput && valorInput.maskRef) {
                const rawValue = valorInput.maskRef.unmaskedValue;
                const valor = parseFloat(rawValue).toString();
                formData.set('valor', valor);
            } else if (valorInput) {
                const valor = valorInput.value.replace('R$ ', '').replace(/\./g, '').replace(',', '.');
                formData.set('valor', valor);
            }
        }
        
        // Determine if this is a new item or an update
        const url = isNew ? '/financas/create-item/' : '/financas/update-item/';
        
        fetch(url, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                window.location.reload();
            } else {
                alert('Erro ao ' + (isNew ? 'criar' : 'atualizar') + ': ' + (data.error || 'Erro desconhecido'));
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Erro ao ' + (isNew ? 'criar' : 'atualizar') + ' os dados');
        });
    });

    // Add status change handler for receitas
    const statusSelect = document.getElementById('status_pagamento');
    const dataPagamentoGroup = document.getElementById('data_pagamento').closest('.form-group');
    
    function toggleDataPagamento() {
        const status = statusSelect.value;
        if (status === 'pago' || status === 'glosa') {
            dataPagamentoGroup.style.display = 'block';
            document.getElementById('data_pagamento').required = true;
        } else {
            dataPagamentoGroup.style.display = 'none';
            document.getElementById('data_pagamento').required = false;
        }
    }

    statusSelect.addEventListener('change', toggleDataPagamento);

    // Initialize money mask for all money inputs
    const moneyInputMasks = [];
    document.querySelectorAll('.money-input').forEach(element => {
        const mask = IMask(element, {
            mask: 'R$ num',
            blocks: {
                num: {
                    mask: Number,
                    thousandsSeparator: '.',
                    radix: ',',
                    scale: 2,
                    padFractionalZeros: true,
                    normalizeZeros: true,
                    mapToRadix: ['.']
                }
            }
        });
        element.maskRef = mask;
        moneyInputMasks.push(mask);
    });

    // Add CPF mask
    const cpfInput = document.getElementById('cpf');
    IMask(cpfInput, {
        mask: '000.000.000-00'
    });

    // Add back the period filter functionality
    const periodFilterBtn = document.getElementById('periodFilterBtn');
    const periodFilter = document.getElementById('periodFilter');
    
    // Toggle period filter dropdown
    periodFilterBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        periodFilter.style.display = periodFilter.style.display === 'none' ? 'block' : 'none';
    });
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(e) {
        if (!periodFilter.contains(e.target) && e.target !== periodFilterBtn) {
            periodFilter.style.display = 'none';
        }
    });
    
    // Handle period option clicks
    document.querySelectorAll('.period-option').forEach(option => {
        option.addEventListener('click', function() {
            const value = this.dataset.value;
            if (value === 'custom') {
                document.getElementById('customRangeContainer').style.display = 'block';
            } else {
                window.location.href = `?view={{ view_type }}&period=${value}`;
            }
        });
    });
    
    // Handle custom range
    const applyCustomRangeBtn = document.getElementById('applyCustomRangeBtn');
    if (applyCustomRangeBtn) {
        applyCustomRangeBtn.addEventListener('click', function() {
            const startDate = document.getElementById('customStart').value;
            const endDate = document.getElementById('customEnd').value;
            if (startDate && endDate) {
                window.location.href = `?view={{ view_type }}&period=custom&start=${startDate}&end=${endDate}`;
            }
        });
    }

    // Add dynamic search functionality
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;

    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        
        searchTimeout = setTimeout(() => {
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('search', this.value);
            
            // Preserve other parameters
            const view = currentUrl.searchParams.get('view') || 'receitas';
            const period = currentUrl.searchParams.get('period');
            const status = currentUrl.searchParams.get('status');
            
            // Update URL and reload page
            window.location.href = currentUrl.toString();
        }, 500); // Wait 500ms after user stops typing before searching
    });

    function openAddDespesaModal() {
        // Reset form
        form.reset();
        
        // Set up modal for new despesa
        document.getElementById('modal-action-type').textContent = 'Adicionar';
        document.getElementById('modal-title-type').textContent = 'Despesa';
        document.getElementById('finance_type').value = 'despesas';
        document.getElementById('is_new').value = 'true';
        
        // Show appropriate fields
        document.getElementById('receitas-fields').style.display = 'none';
        document.getElementById('despesas-fields').style.display = 'block';
        
        // Set today's date as default for the data field
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('data').value = today;
        
        // Show modal
        editModal.style.display = "block";
    }
    
    // Make the function available globally
    window.openAddDespesaModal = openAddDespesaModal;

    // Add event listeners for cancel buttons
    document.querySelectorAll('.cancel-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            if (confirm('Deseja realmente cancelar este item?')) {
                const row = this.closest('tr');
                const financeId = row.dataset.id;
                const viewType = '{{ view_type }}';
                
                const formData = new FormData();
                formData.append('finance_type', viewType);
                formData.append('finance_id', financeId);
                
                fetch('/financas/delete-item/', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the row from the table
                        row.remove();
                    } else {
                        alert('Erro ao cancelar: ' + (data.error || 'Erro desconhecido'));
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Erro ao cancelar o item');
                });
            }
        });
    });
});
</script>
<script>
    function exportFinances() {
        const view = '{{ view_type }}';
        const status = '{{ selected_status|default_if_none:"" }}';
        const searchQuery = '{{ search_query|default_if_none:"" }}';
        const period = '{{ selected_period|default_if_none:"" }}';
        const startDate = '{{ custom_start_date|default_if_none:"" }}';
        const endDate = '{{ custom_end_date|default_if_none:"" }}';
    
        // Construct the URL with query parameters
        let url = new URL('{% url "export_finances" %}', window.location.origin);
        if (view) {
            url.searchParams.append('view', view);
        }
        if (status) {
            url.searchParams.append('status', status);
        }
        if (searchQuery) {
            url.searchParams.append('search', searchQuery);
        }
        if (period) {
            url.searchParams.append('period', period);
        }
        if (startDate) {
            url.searchParams.append('start_date', startDate);
        }
        if (endDate) {
            url.searchParams.append('end_date', endDate);
        }
    
        // Redirect to the constructed URL
        window.location.href = url.toString();
    }
    </script>
<script>
function loadConciliationData() {
    fetch('/financas/conciliar/')
        .then(response => response.json())
        .then(data => {
            console.log('Conciliation data:', data); // Debug output
            const container = document.getElementById('conciliation-cards');
            container.innerHTML = '';
            
            let showModal = true;
            
            // Show auto-matched count if any
            if (data.auto_matched && data.auto_matched.length > 0) {
                alert(`${data.auto_matched.length} guias foram automaticamente conciliadas.`);
                
                // If there's only auto_matched items and nothing to manually conciliate,
                // don't show the empty conciliation modal and refresh the page
                if (!data.needs_confirmation || data.needs_confirmation.length === 0) {
                    showModal = false;
                    // Reload the page after alert is dismissed
                    setTimeout(() => {
                        window.location.reload();
                    }, 500);
                }
            }
            
            // Check for data that needs confirmation
            if (data.needs_confirmation && data.needs_confirmation.length > 0) {
                data.needs_confirmation.forEach(match => {
                    const card = createConciliationCard(match);
                    container.appendChild(card);
                });
                document.getElementById('no-matches').style.display = 'none';
            } else {
                document.getElementById('no-matches').style.display = 'block';
            }
            
            // Open the modal only if needed
            if (showModal) {
                document.getElementById('conciliation-modal').style.display = 'block';
            }
            
            // Update the unmatched guias button visibility
            if (data.not_found_in_system && data.not_found_in_system.length > 0) {
                document.getElementById('unmatched-guias-fab').style.display = 'flex';
                // Store the data for later use
                window.unmatchedGuiasData = data.not_found_in_system;
            } else {
                document.getElementById('unmatched-guias-fab').style.display = 'none';
            }
        })
        .catch(error => {
            console.error('Error loading conciliation data:', error);
            alert('Erro ao carregar dados para conciliação');
        });
}

function createConciliationCard(match) {
    const card = document.createElement('div');
    card.className = 'conciliation-card';
    card.setAttribute('data-financa-id', match.financa_id);
    
    card.innerHTML = `
        <div class="comparison">
            <div class="system-data">
                <h3>Dados do Sistema</h3>
                <p>Paciente: ${match.sistema_data.paciente}</p>
                <p>Data: ${match.sistema_data.data}</p>
                <p>Hospital: ${match.sistema_data.hospital || 'Não informado'}</p>
                <p>Anestesista: ${match.sistema_data.anestesista || 'Não informado'}</p>
            </div>
            <div class="api-data">
                <h3>Dados da API</h3>
                <p>Paciente: ${match.api_data.paciente}</p>
                <p>Data: ${match.api_data.data || 'Não informada'}</p>
                <p>Valor: R$ ${match.api_data.valor || '0.00'}</p>
                <p>Status: ${match.api_data.status || 'Não informado'}</p>
                <p>Hospital: ${match.api_data.hospital || 'Não informado'}</p>
                <p>Cooperado: ${match.api_data.cooperado || 'Não informado'}</p>
            </div>
        </div>
        <div class="actions">
            <button onclick="confirmConciliation(${match.financa_id}, '${match.cpsa_id}', true)">
                Confirmar Match
            </button>
            <button onclick="confirmConciliation(${match.financa_id}, '${match.cpsa_id}', false)">
                Não é o Mesmo
            </button>
            <button onclick="skipConciliation(${match.financa_id}, '${match.cpsa_id}')">
                Pular
            </button>
        </div>
    `;
    
    return card;
}

function confirmConciliation(financaId, cpsaId, conciliado) {
    fetch('/financas/confirmar-conciliacao/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            financa_id: financaId,
            cpsa_id: cpsaId,
            conciliado: conciliado
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the card
            const card = document.querySelector(`[data-financa-id="${financaId}"]`);
            if (card) card.remove();
            
            // Check if there are more cards
            if (document.querySelectorAll('.conciliation-card').length === 0) {
                document.getElementById('no-matches').style.display = 'block';
            }
            
            // Show success message
            if (data.action === 'conciliado') {
                alert('Conciliação realizada com sucesso!');
                // Reload the page after success message is dismissed
                setTimeout(() => {
                    window.location.reload();
                }, 500);
            } else if (data.action === 'rejeitado') {
                alert('Item rejeitado com sucesso.');
            }
        } else {
            alert('Erro ao processar conciliação: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Error during conciliation:', error);
        alert('Erro ao processar conciliação');
    });
}

function skipConciliation(financaId, cpsaId) {
    fetch('/financas/confirmar-conciliacao/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': '{{ csrf_token }}'
        },
        body: JSON.stringify({
            financa_id: financaId,
            cpsa_id: cpsaId,
            pular: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Remove the card
            const card = document.querySelector(`[data-financa-id="${financaId}"]`);
            if (card) card.remove();
            
            // Check if there are more cards
            if (document.querySelectorAll('.conciliation-card').length === 0) {
                document.getElementById('no-matches').style.display = 'block';
            }
        } else {
            alert('Erro ao pular item: ' + (data.error || 'Erro desconhecido'));
        }
    })
    .catch(error => {
        console.error('Error skipping conciliation:', error);
        alert('Erro ao pular item');
    });
}

function showUnmatchedGuiasModal() {
    // Get data from window storage or re-fetch if needed
    const unmatchedData = window.unmatchedGuiasData || [];
    
    // Get the modal and table body
    const modal = document.getElementById('unmatched-guias-modal');
    const tableBody = modal.querySelector('tbody');
    const noDataMessage = document.getElementById('no-unmatched-guias');
    
    // Clear the table
    tableBody.innerHTML = '';
    
    // Populate table with data
    if (unmatchedData.length > 0) {
        unmatchedData.forEach(guia => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${guia.cpsa_id || '-'}</td>
                <td>${guia.paciente || '-'}</td>
                <td>${guia.data || '-'}</td>
                <td>R$ ${guia.valor || '0.00'}</td>
                <td>${guia.status || '-'}</td>
                <td>${guia.hospital || '-'}</td>
                <td>${guia.cooperado || '-'}</td>
            `;
            tableBody.appendChild(row);
        });
        noDataMessage.style.display = 'none';
    } else {
        noDataMessage.style.display = 'block';
    }
    
    // Show the modal
    modal.style.display = 'block';
}

// Replace the button with floating action buttons
document.body.insertAdjacentHTML('beforeend', `
    <button id="conciliate-fab" onclick="loadConciliationData()" title="Conciliar Dados">
        <i class="fas fa-sync"></i>
    </button>
    <button id="unmatched-guias-fab" onclick="showUnmatchedGuiasModal()" title="Ver Guias Não Encontradas">
        <i class="fas fa-question-circle"></i>
    </button>
`);
</script>

{% endblock %}
