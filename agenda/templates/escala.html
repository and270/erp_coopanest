{% extends 'layout.html' %}
{% load static %}

{% block title %}Escala{% endblock %}

{% block content %}
<div class="agenda-container escala-view">
    <div class="agenda-header">
        <div class="left-controls">
            Escala
        </div>

        <div class="center-controls">

        </div>

        <div class="right-controls">
            <div class="agenda-scale">
                <input type="radio" id="scale-view" name="view-toggle" checked>
                <label for="scale-view"><b>Escala</b></label>
                <input type="radio" id="agenda-view" name="view-toggle">
                <label for="agenda-view"><b>Agenda</b></label>
            </div>
        </div>
    </div>

    <div class="calendar-container">
        <div class="calendar-sidebar">
            <div class="event-types-container">
                <div class="event-types-legend">Legenda</div>
                <ul class="event-types">
                    <li><button class="btn-plantonista">Plantonista</button></li>
                    <li><button class="btn-substituto">Substituto</button></li>
                    <li><button class="btn-ferias">Férias/Licença</button></li>
                </ul>
            </div>
        </div>
        <div class="calendar-main">
            <div class="sub-controls">
                <div class="view-switcher">
                    <a href="#" id="prev-btn" class="btn btn-link">&lt;</a>
                    <a href="#" id="next-btn" class="btn btn-link">&gt;</a>
                    <h3 id="current-date-range" class="escala-date-range">{{ start_date|date:"d/m" }} até {{ end_date|date:"d/m" }}</h3>
                </div>
            </div>
            <div class="escala-grid">
                <div class="escala-days">
                    <span>DOM</span>
                    <span>SEG</span>
                    <span>TER</span>
                    <span>QUA</span>
                    <span>QUI</span>
                    <span>SEX</span>
                    <span>SÁB</span>
                </div>
                {% for week in weeks %}
                    <div class="escala-week-row">
                        <div class="escala-week-dates">{{ week.start_date|date:"d/m" }} - {{ week.end_date|date:"d/m" }}</div>
                        {% for day in week.days %}
                            <div class="escala-day-cell" data-date="{{ day|date:'Y-m-d' }}">
                                {% for escala in escalas %}
                                    {% if escala.data == day %}
                                        <div class="escala-item {{ escala.escala_type }}" data-id="{{ escala.id }}" data-original-date="{{ escala.data|date:'Y-m-d' }}">
                                            <p><b>{{ escala.anestesiologista.name }}</b></p>
                                            <p>{{ escala.hora_inicio|time:"H:i" }} - {{ escala.hora_fim|time:"H:i" }}</p>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}

            </div>
        </div>
    </div>    
</div>

<!-- Escala Details Modal -->
<div id="escala-details-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <span id="modal-escala-type"></span>
        <span id="modal-anestesiologista"></span>
        <p><span id="modal-data"></span></p>
        <p>De <span id="modal-hora-inicio"></span> até <span id="modal-hora-fim"></span></p>
        <p><strong>Observações:</strong> <span id="modal-observacoes"></span></p>
        <div class="modal-actions">
            <button class="btn btn-primary edit-escala">Editar</button>
            <button class="btn btn-danger delete-escala">Excluir</button>
        </div>
    </div>
</div>

<div id="edit-escala-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Editar Escala</h2>
        <br>
        <form id="edit-escala-form">
            {% csrf_token %}
            <input type="hidden" id="edit_escala_id" name="escala_id">
            <div class="form-group">
                <label for="edit_escala_type">Tipo de Escala:</label>
                <select id="edit_escala_type" name="escala_type" class="form-control" required>
                    <option value="{{ PLANTONISTA_ESCALA }}">Plantonista</option>
                    <option value="{{ SUBSTITUTO_ESCALA }}">Substituto</option>
                    <option value="{{ FERIAS_ESCALA }}">Férias/Licença</option>
                </select>
            </div>
            <div class="form-group">
                <label for="edit_anestesiologista">Anestesiologista:</label>
                <select id="edit_anestesiologista" name="anestesiologista" class="form-control" required>
                    <!-- Options will be populated dynamically -->
                </select>
            </div>
            <div class="form-group">
                <label for="edit_data">Data:</label>
                <input type="date" id="edit_data" name="data" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit_hora_inicio">Hora Início:</label>
                <input type="time" id="edit_hora_inicio" name="hora_inicio" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit_hora_fim">Hora Fim:</label>
                <input type="time" id="edit_hora_fim" name="hora_fim" class="form-control" required>
            </div>
            <div class="form-group">
                <label for="edit_observacoes">Observações:</label>
                <textarea id="edit_observacoes" name="observacoes" class="form-control"></textarea>
            </div>
            <button type="submit" class="btn btn-primary">Salvar Alterações</button>
        </form>
    </div>
</div>

<button class="btn btn-primary" id="criar-escala-btn">Nova Escala</button>
<div id="escala-form-modal" class="modal" style="display: {% if form_errors %}block{% else %}none{% endif %};">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <h2>Nova Escala</h2>
                    <br>
                    <form method="POST" enctype="multipart/form-data" id="escala-form">
                        {% csrf_token %}
                        <input type="hidden" name="escala_id" id="escala_id">
                        <div class="form-group">
                            <label for="{{ form.escala_type.id_for_label }}">{{ form.escala_type.label }}</label>
                            {{ form.escala_type }}
                            {% if form.escala_type.errors %}
                                <div class="error-message">
                                    {{ form.escala_type.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            <label for="{{ form.anestesiologista.id_for_label }}">{{ form.anestesiologista.label }}</label>
                            {{ form.anestesiologista }}
                            {% if form.anestesiologista.errors %}
                                <div class="error-message">
                                    {{ form.anestesiologista.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-row">
                            <div class="form-group half-width">
                                {{ form.data_inicio.label_tag }} {{ form.data_inicio }}
                                {% if form.data_inicio.errors %}
                                    <div class="error-message">
                                        {{ form.data_inicio.errors }}
                                    </div>
                                {% endif %}
                            </div>
                            <div class="form-group half-width">
                                {{ form.data_fim.label_tag }} {{ form.data_fim }}
                                {% if form.data_fim.errors %}
                                    <div class="error-message">
                                        {{ form.data_fim.errors }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="form-group">
                            {{ form.dias_da_semana.label_tag }}
                            <div id="dias-da-semana-container">
                                {% for value, label in form.dias_da_semana.field.choices %}
                                    <div class="checkbox">
                                        <label>
                                            <input type="checkbox" name="{{ form.dias_da_semana.name }}" value="{{ value }}"
                                                   {% if value in form.dias_da_semana.value %}checked{% endif %}
                                                   {% if value == 'todos' %}id="todos-os-dias"{% endif %}>
                                            {{ label }}
                                        </label>
                                    </div>
                                {% endfor %}
                            </div>
                            {% if form.dias_da_semana.errors %}
                                <div class="error-message">
                                    {{ form.dias_da_semana.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.hora_inicio.label_tag }} {{ form.hora_inicio }}
                            {% if form.hora_inicio.errors %}
                                <div class="error-message">
                                    {{ form.hora_inicio.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.hora_fim.label_tag }} {{ form.hora_fim }}
                            {% if form.hora_fim.errors %}
                                <div class="error-message">
                                    {{ form.hora_fim.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <div class="form-group">
                            {{ form.observacoes.label_tag }} {{ form.observacoes }}
                            {% if form.observacoes.errors %}
                                <div class="error-message">
                                    {{ form.observacoes.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <button type="submit" class="cadastrar-btn" id="form-submit-btn">Criar Escala</button>
                    </form>
                </div>
</div>

<div id="customAlert" class="custom-alert"></div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.6/jquery.inputmask.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/interact.js/1.10.11/interact.min.js"></script>

<script>
    function showCustomAlert(message, type) {
        const alertElement = document.getElementById('customAlert');
        if (!alertElement) {
            console.error('Custom alert element not found');
            alert(message); // Fallback
            return;
        }
        alertElement.textContent = message;
        alertElement.className = `custom-alert ${type}`;
        alertElement.style.display = 'block';
        
        setTimeout(() => {
            alertElement.style.display = 'none';
        }, 3500);
    }

    function hideNovaEscalaButton() {
        document.getElementById('criar-escala-btn').style.display = 'none';
    }

    function showNovaEscalaButton() {
        document.getElementById('criar-escala-btn').style.display = '';
    }

    $(document).ready(function(){
        // AJAX form submission for creating a new Escala
        $('#escala-form').on('submit', function(e) {
            e.preventDefault();
            var formData = new FormData(this);

            $.ajax({
                url: '{% url "create_escala" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(data) {
                    if(data.success) {
                        $('#escala-form-modal').hide();
                        showCustomAlert(data.message || 'Escala criada com sucesso!', 'success');
                        setTimeout(function() {
                            location.reload();
                        }, 1500);
                    } else {
                        $('.error-message').remove();
                        if (data.errors) {
                            var errors = JSON.parse(data.errors);
                            for (var field in errors) {
                                var field_element = $('[name=' + field + ']');
                                var error_html = '<div class="error-message">';
                                errors[field].forEach(function(error) {
                                    error_html += '<p>' + error.message + '</p>';
                                });
                                error_html += '</div>';
                                field_element.closest('.form-group, .form-row').append(error_html);
                            }
                        }
                        showCustomAlert(data.message || 'Erro ao criar escala.', 'error');
                    }
                },
                error: function() {
                    showCustomAlert('Ocorreu um erro no servidor.', 'error');
                }
            });
        });

        // Input masks
        $("input[name='data_inicio'], input[name='data_fim']").inputmask("99/99/9999");
        $("input[name='hora_inicio'], input[name='hora_fim']").inputmask("99:99");

        // "Todos os dias" checkbox logic
        $('#todos-os-dias').on('change', function() {
            var isChecked = $(this).is(':checked');
            $('#dias-da-semana-container input[type="checkbox"]').prop('checked', isChecked);
        });

        $('#dias-da-semana-container input[type="checkbox"]').not('#todos-os-dias').on('change', function() {
            if (!$(this).is(':checked')) {
                $('#todos-os-dias').prop('checked', false);
            }
        });

        // Modal controls
        $('#criar-escala-btn').on('click', function() {
            $('#escala-form-modal').show();
            hideNovaEscalaButton();
        });

        $('#escala-form-modal .close').on('click', function() {
            $('#escala-form-modal').hide();
            showNovaEscalaButton();
        });

        // View switching
        $('#agenda-view').on('change', function() {
            if ($(this).is(':checked')) {
                window.location.href = "{% url 'agenda' %}";
            }
        });
        $('#scale-view').on('change', function() {
            if ($(this).is(':checked')) {
                window.location.href = "{% url 'escala' %}";
            }
        });

        // Date navigation
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        // Use a more reliable way to get the date parts
        const dateParts = "{{ first_of_month|date:'Y-m-d' }}".split('-');
        let currentStartDate = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]);

        prevBtn.addEventListener('click', function(e) {
            e.preventDefault();
            currentStartDate.setMonth(currentStartDate.getMonth() - 1);
            const year = currentStartDate.getFullYear();
            const month = currentStartDate.getMonth() + 1;
            window.location.href = `?start_date=${year}-${month.toString().padStart(2, '0')}-01`;
        });

        nextBtn.addEventListener('click', function(e) {
            e.preventDefault();
            currentStartDate.setMonth(currentStartDate.getMonth() + 1);
            const year = currentStartDate.getFullYear();
            const month = currentStartDate.getMonth() + 1;
            window.location.href = `?start_date=${year}-${month.toString().padStart(2, '0')}-01`;
        });

        // Drag and Drop functionality
        interact('.escala-item')
            .draggable({
                listeners: {
                    start (event) {
                        const item = event.target;
                        item.classList.add('dragging');
                    },
                    move (event) {
                        const item = event.target;
                        const x = (parseFloat(item.getAttribute('data-x')) || 0) + event.dx;
                        const y = (parseFloat(item.getAttribute('data-y')) || 0) + event.dy;
                        item.style.transform = `translate(${x}px, ${y}px)`;
                        item.setAttribute('data-x', x);
                        item.setAttribute('data-y', y);
                    },
                    end (event) {
                        const item = event.target;
                        item.classList.remove('dragging');
                        item.style.transform = 'none';
                        item.removeAttribute('data-x');
                        item.removeAttribute('data-y');
                    }
                }
            })
            .on('tap', function(event) {
                const item = event.currentTarget;
                currentEscalaId = $(item).data('id');
                const url = `/get-escala/${currentEscalaId}/`;
                $.get(url, function(data) {
                    $('#modal-anestesiologista').text(data.anestesiologista_name);
                    $('#modal-data').text(new Date(data.data + 'T00:00:00').toLocaleDateString('pt-BR'));
                    $('#modal-hora-inicio').text(data.hora_inicio);
                    $('#modal-hora-fim').text(data.hora_fim);
                    $('#modal-observacoes').text(data.observacoes || 'N/A');
                    
                    const escalaTypeMap = {
                        '{{ PLANTONISTA_ESCALA }}': 'Plantonista',
                        '{{ SUBSTITUTO_ESCALA }}': 'Substituto',
                        '{{ FERIAS_ESCALA }}': 'Férias/Licença'
                    };
                    $('#modal-escala-type').text(escalaTypeMap[data.escala_type] || 'N/A');
                    $('#escala-details-modal').show();
                });
            });

        interact('.escala-day-cell').dropzone({
            accept: '.escala-item',
            ondrop: function (event) {
                const item = event.relatedTarget;
                const dropzone = event.target;
                const newDate = dropzone.dataset.date;
                const escalaId = item.dataset.id;
                
                const csrfToken = $('input[name=csrfmiddlewaretoken]').val();

                $.ajax({
                    url: `/update-escala-date/${escalaId}/`,
                    type: 'POST',
                    data: {
                        'new_date': newDate,
                        'csrfmiddlewaretoken': csrfToken
                    },
                    success: function(data) {
                        if (data.success) {
                            dropzone.appendChild(item);
                            item.dataset.originalDate = newDate;
                            showCustomAlert('Escala atualizada com sucesso!', 'success');
                        } else {
                            showCustomAlert(data.message || 'Erro ao atualizar escala.', 'error');
                        }
                    },
                    error: function() {
                        showCustomAlert('Ocorreu um erro no servidor.', 'error');
                    }
                });
            }
        });
        
        let currentEscalaId = null;

        // Close details modal
        $('#escala-details-modal .close').on('click', function() {
            $('#escala-details-modal').hide();
        });

        // Open edit modal from details
        $('.edit-escala').on('click', function() {
            $('#escala-details-modal').hide();
            const url = `/get-escala/${currentEscalaId}/`;
            $.get(url, function(data) {
                $('#edit_escala_id').val(data.id);
                $('#edit_escala_type').val(data.escala_type);
                
                const anestesiologistaSelect = $('#edit_anestesiologista');
                anestesiologistaSelect.empty();
                data.anesthesiologists.forEach(function(anest) {
                    anestesiologistaSelect.append(new Option(anest.name, anest.id, false, anest.id === data.anestesiologista));
                });

                $('#edit_data').val(data.data);
                $('#edit_hora_inicio').val(data.hora_inicio);
                $('#edit_hora_fim').val(data.hora_fim);
                $('#edit_observacoes').val(data.observacoes);

                $('#edit-escala-modal').show();
            });
        });

        // Close edit modal
        $('#edit-escala-modal .close').on('click', function() {
            $('#edit-escala-modal').hide();
        });

        // Submit edit form
        $('#edit-escala-form').on('submit', function(e) {
            e.preventDefault();
            const escalaId = $('#edit_escala_id').val();
            const url = `/edit-single-day-escala/${escalaId}/`;
            const formData = $(this).serialize();

            $.ajax({
                url: url,
                type: 'POST',
                data: formData,
                success: function(data) {
                    if(data.success) {
                        $('#edit-escala-modal').hide();
                        showCustomAlert(data.message || 'Escala atualizada com sucesso!', 'success');
                        setTimeout(function() { location.reload(); }, 1500);
                    } else {
                        showCustomAlert(data.message || 'Erro ao atualizar escala.', 'error');
                    }
                },
                error: function() {
                    showCustomAlert('Ocorreu um erro no servidor.', 'error');
                }
            });
        });
        
        // Delete escala
        $('.delete-escala').on('click', function() {
            if (confirm('Tem certeza que deseja excluir esta escala?')) {
                const url = `/delete-escala/${currentEscalaId}/`;
                const csrfToken = $('input[name=csrfmiddlewaretoken]').val();

                $.ajax({
                    url: url,
                    type: 'POST',
                    data: {'csrfmiddlewaretoken': csrfToken},
                    success: function(data) {
                        if(data.success) {
                            $('#escala-details-modal').hide();
                            $(`.escala-item[data-id="${currentEscalaId}"]`).remove();
                            showCustomAlert('Escala excluída com sucesso!', 'success');
                        } else {
                            showCustomAlert('Erro ao excluir escala.', 'error');
                        }
                    },
                    error: function() {
                        showCustomAlert('Ocorreu um erro no servidor.', 'error');
                    }
                });
            }
        });
    });
</script>

{% endblock %}
