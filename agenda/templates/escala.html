{% extends 'layout.html' %}
{% load static %}

{% block title %}Escala{% endblock %}

{% block content %}
<div class="agenda-container escala-view">
    <div class="agenda-header escala-header">
        <div class="left-controls">
            <button class="btn btn-primary" id="criar-escala-btn">+ CRIAR ESCALA</button>
            <div id="escala-form-modal" class="modal" style="display: {% if form_errors %}block{% else %}none{% endif %};">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <br>
                    <form method="POST" enctype="multipart/form-data" id="escala-form">
                        {% csrf_token %}
                        <input type="hidden" name="escala_id" id="escala_id">
                        <div class="form-group">
                            {{ form.escala_type.label_tag }} {{ form.escala_type }}
                            {% if form.escala_type.errors %}
                                <div class="error-message">
                                    {{ form.escala_type.errors }}
                                </div>
                            {% endif %}
                        </div>
                    
                        <div class="form-group">
                            {{ form.anestesiologista.label_tag }} {{ form.anestesiologista }}
                            {% if form.anestesiologista.errors %}
                                <div class="error-message">
                                    {{ form.anestesiologista.errors }}
                                </div>
                            {% endif %}
                        </div>
                    
                        <div class="form-group">
                            {{ form.data_inicio.label_tag }} {{ form.data_inicio }}
                            {% if form.data_inicio.errors %}
                                <div class="error-message">
                                    {{ form.data_inicio.errors }}
                                </div>
                            {% endif %}
                        </div>
                    
                        <div class="form-group">
                            {{ form.data_fim.label_tag }} {{ form.data_fim }}
                            {% if form.data_fim.errors %}
                                <div class="error-message">
                                    {{ form.data_fim.errors }}
                                </div>
                            {% endif %}
                        </div>
                    
                        <div class="form-group">
                            {{ form.dias_da_semana.label_tag }} {{ form.dias_da_semana }}
                            {% if form.dias_da_semana.errors %}
                                <div class="error-message">
                                    {{ form.dias_da_semana.errors }}
                                </div>
                            {% endif %}
                        </div>
                    
                        <div class="form-group">
                            {{ form.hora_inicio.label_tag }} {{ form.hora_inicio }}
                            {% if form.hora_inicio.errors %}
                                <div class="error-message">
                                    {{ form.hora_inicio.errors }}
                                </div>
                            {% endif %}
                        </div>
                    
                        <div class="form-group">
                            {{ form.hora_fim.label_tag }} {{ form.hora_fim }}
                            {% if form.hora_fim.errors %}
                                <div class="error-message">
                                    {{ form.hora_fim.errors }}
                                </div>
                            {% endif %}
                        </div>
                        <button type="submit" class="cadastrar-btn" id="form-submit-btn">Criar Escala</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="center-controls">
            <div class="view-switcher">
                <a href="#" id="prev-btn" class="btn btn-link">&lt;</a>
                <h3 id="current-date-range" class="escala-date-range">{{ start_date|date:"d/m" }} até {{ start_date|add:"27 days"|date:"d/m" }}</h3>
                <a href="#" id="next-btn" class="btn btn-link">&gt;</a>
            </div>
            <ul class="escala-types">
                <li class="plantonista">PLANTONISTA</li>
                <li class="substituto">SUBSTITUTO</li>
                <li class="ferias">FÉRIAS/LICENÇA</li>
            </ul>
        </div>

        <div class="right-controls">
            <div class="agenda-scale">
                <input type="radio" id="agenda-view" name="view-toggle">
                <label for="agenda-view"><b>AGENDA</b></label>
                <input type="radio" id="scale-view" name="view-toggle" checked>
                <label for="scale-view"><b>ESCALA</b></label>
            </div>
        </div>
    </div>

    <div class="calendar-container">
        <div class="calendar-main">
            <div class="escala-grid">
                <div class="escala-days">
                    <span>DOM</span>
                    <span>SEG</span>
                    <span>TER</span>
                    <span>QUA</span>
                    <span>QUI</span>
                    <span>SEX</span>
                    <span>SÁB</span>
                </div>
                {% for week in weeks %}
                    <div class="escala-week-row">
                        <div class="escala-week-dates">{{ week.start_date|date:"d/m" }} - {{ week.end_date|date:"d/m" }}</div>
                        {% for day in week.days %}
                            <div class="escala-day-cell" data-date="{{ day|date:'Y-m-d' }}">
                                {% for escala in escalas %}
                                    {% with day_of_week=day|date:"w" %}
                                        {% if escala.data_inicio <= day and escala.data_fim >= day and day_of_week in escala.dias_da_semana %}
                                            <div class="escala-item {{ escala.escala_type }}" data-id="{{ escala.id }}">
                                                <p><b>{{ escala.anestesiologista.name }}</b></p>
                                                <p>{{ escala.hora_inicio|time:"H:i" }} - {{ escala.hora_fim|time:"H:i" }}</p>
                                            </div>
                                        {% endif %}
                                    {% endwith %}
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>    
</div>

<!-- Escala Details Modal -->
<div id="escala-details-modal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Detalhes da Escala</h2>
        <p><strong>Anestesiologista:</strong> <span id="modal-anestesiologista"></span></p>
        <p><strong>Tipo:</strong> <span id="modal-escala-type"></span></p>
        <p><strong>Data Início:</strong> <span id="modal-data-inicio"></span></p>
        <p><strong>Data Fim:</strong> <span id="modal-data-fim"></span></p>
        <p><strong>Hora Início:</strong> <span id="modal-hora-inicio"></span></p>
        <p><strong>Hora Fim:</strong> <span id="modal-hora-fim"></span></p>
        <p><strong>Dias da Semana:</strong> <span id="modal-dias-da-semana"></span></p>
        <p><strong>Observações:</strong> <span id="modal-observacoes"></span></p>
        <div class="modal-actions">
            <button class="btn btn-primary edit-escala">Editar</button>
            <button class="btn btn-danger delete-escala">Excluir</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.6/jquery.inputmask.min.js"></script>
<script>
    $(document).ready(function(){
        // Apply masks
        $("#id_data_inicio, #id_data_fim").inputmask("99/99/9999");  // dd/mm/yyyy
        $("#id_hora_inicio, #id_hora_fim").inputmask("99:99");  // hh:mm
    });
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const criarEscalaBtn = document.getElementById('criar-escala-btn');
    const escalaFormModal = document.getElementById('escala-form-modal');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const currentDateRange = document.getElementById('current-date-range');
    
    // Parse the start date string into year, month, and day components
    const [year, month, day] = '{{ start_date|date:"Y-m-d" }}'.split('-').map(Number);
    
    // Create a Date object using UTC to avoid timezone issues
    let currentStartDate = new Date(Date.UTC(year, month - 1, day));

    function updateDateRange() {
        const endDate = new Date(currentStartDate);
        endDate.setUTCDate(endDate.getUTCDate() + 27); // 4 weeks - 1 day
        currentDateRange.textContent = `${formatDate(currentStartDate)} até ${formatDate(endDate)}`;
    }

    function formatDate(date) {
        return `${date.getUTCDate().toString().padStart(2, '0')}/${(date.getUTCMonth() + 1).toString().padStart(2, '0')}`;
    }

    updateDateRange();

    prevBtn.addEventListener('click', function(e) {
        e.preventDefault();
        currentStartDate.setUTCDate(currentStartDate.getUTCDate() - 28);
        updateDateRange();
        loadEscalas(currentStartDate);
    });

    nextBtn.addEventListener('click', function(e) {
        e.preventDefault();
        currentStartDate.setUTCDate(currentStartDate.getUTCDate() + 28);
        updateDateRange();
        loadEscalas(currentStartDate);
    });

    function loadEscalas(startDate) {
        window.location.href = `/escala/?start_date=${startDate.toISOString().split('T')[0]}`;
    }

    criarEscalaBtn.addEventListener('click', function() {
        escalaFormModal.style.display = 'block';
        document.getElementById('escala-form').reset();
        document.getElementById('escala_id').value = '';
        document.getElementById('form-submit-btn').textContent = 'Criar Escala';
    });
    
    document.querySelector('.close').addEventListener('click', function() {
        escalaFormModal.style.display = 'none';
    });
    
    // desativa clickout
    // window.addEventListener('click', function(event) {
    //     if (event.target == escalaFormModal) {
    //         escalaFormModal.style.display = 'none';
    //     }
    // });

    const escalaItems = document.querySelectorAll('.escala-item');
    const escalaDetailsModal = document.getElementById('escala-details-modal');
    const escalaForm = document.getElementById('escala-form');
    const formSubmitBtn = document.getElementById('form-submit-btn');

    escalaItems.forEach(item => {
        item.addEventListener('click', function() {
            const escalaId = this.getAttribute('data-id');
            fetchEscalaDetails(escalaId);
        });
    });

    function fetchEscalaDetails(escalaId) {
        fetch(`/get-escala/${escalaId}/`)
            .then(response => response.json())
            .then(data => {
                populateEscalaModal(data);
                escalaDetailsModal.style.display = 'block';
            });
    }

    function populateEscalaModal(data) {
        document.getElementById('modal-anestesiologista').textContent = data.anestesiologista_name;
        document.getElementById('modal-escala-type').textContent = data.escala_type;
        document.getElementById('modal-data-inicio').textContent = formatDateFull(data.data_inicio);
        document.getElementById('modal-data-fim').textContent = formatDateFull(data.data_fim);
        document.getElementById('modal-hora-inicio').textContent = data.hora_inicio;
        document.getElementById('modal-hora-fim').textContent = data.hora_fim;
        document.getElementById('modal-dias-da-semana').textContent = formatDiasDaSemana(data.dias_da_semana);
        document.getElementById('modal-observacoes').textContent = data.observacoes || 'Nenhuma observação';

        escalaDetailsModal.setAttribute('data-escala-id', data.id);

        // Add event listener for the edit button
        const editButton = escalaDetailsModal.querySelector('.edit-escala');
        editButton.onclick = function() {
            console.log('Edit button clicked');
            openEditForm(data.id);
        };

        // Add event listener for the delete button
        const deleteButton = escalaDetailsModal.querySelector('.delete-escala');
        deleteButton.addEventListener('click', function() {
            if (confirm('Tem certeza que deseja excluir esta escala?')) {
                deleteEscala(data.id);
            }
        });
    }

    function formatDateFull(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString('pt-BR');
    }

    function formatDiasDaSemana(dias) {
        const diasMap = {
            '0': 'Domingo',
            '1': 'Segunda-feira',
            '2': 'Terça-feira',
            '3': 'Quarta-feira',
            '4': 'Quinta-feira',
            '5': 'Sexta-feira',
            '6': 'Sábado'
        };
        return dias.map(dia => diasMap[dia]).join(', ');
    }

    function openEditForm(escalaId) {
        console.log('Opening edit form for escala id:', escalaId);
        loadEscalaDataIntoForm(escalaId);
    }

    function loadEscalaDataIntoForm(escalaId) {
        console.log('Loading escala data for id:', escalaId);
        fetch(`/get-escala/${escalaId}/`)
            .then(response => response.json())
            .then(data => {
                console.log('Received escala data:', data);
                
                // Helper function to safely set input values
                function setInputValue(id, value) {
                    const element = document.getElementById(id);
                    if (element) {
                        if (element.inputmask) {
                            $(element).inputmask("setvalue", value);
                        } else {
                            element.value = value;
                        }
                    } else {
                        console.warn(`Element with id '${id}' not found`);
                    }
                }

                setInputValue('escala_id', data.id);
                setInputValue('id_escala_type', data.escala_type);
                setInputValue('id_anestesiologista', data.anestesiologista);
                setInputValue('id_data_inicio', formatDateForInput(data.data_inicio));
                setInputValue('id_data_fim', formatDateForInput(data.data_fim));
                setInputValue('id_hora_inicio', data.hora_inicio);
                setInputValue('id_hora_fim', data.hora_fim);
                setInputValue('id_observacoes', data.observacoes);

                // Handle dias_da_semana (assuming it's rendered as checkboxes or multiple inputs)
                const diasDaSemana = data.dias_da_semana || [];
                diasDaSemana.forEach(dia => {
                    const checkbox = document.getElementById(`id_dias_da_semana_${dia}`);
                    if (checkbox) {
                        checkbox.checked = true;
                    }
                });

                console.log('Form populated, showing form modal');
                escalaDetailsModal.style.display = 'none';
                escalaFormModal.style.display = 'block';
                formSubmitBtn.textContent = 'Editar Escala';
            })
            .catch(error => {
                console.error('Error loading escala data:', error);
            });
    }

    function formatDateForInput(dateString) {
        const date = new Date(dateString);
        const day = date.getDate().toString().padStart(2, '0');
        const month = (date.getMonth() + 1).toString().padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
    }

    function deleteEscala(escalaId) {
        fetch(`/delete-escala/${escalaId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Falha ao excluir a escala. Por favor, tente novamente.');
            }
        });
    }

    escalaForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const escalaId = document.getElementById('escala_id').value;
        
        fetch(escalaId ? `/update-escala/${escalaId}/` : '/create-escala/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Erro ao salvar a escala. Verifique os campos e tente novamente.');
            }
        });
    });

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // Close modal when clicking on the close button or outside the modal
    document.querySelector('#escala-details-modal .close').addEventListener('click', function() {
        escalaDetailsModal.style.display = 'none';
    });

    window.addEventListener('click', function(e) {
        if (e.target == escalaDetailsModal) {
            escalaDetailsModal.style.display = 'none';
        }
    });

    // Reset form when opening for a new escala
    document.getElementById('criar-escala-btn').addEventListener('click', function() {
        escalaForm.reset();
        document.getElementById('escala_id').value = '';
        formSubmitBtn.textContent = 'Criar Escala';
        escalaFormModal.style.display = 'block';
    });
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const agendaRadio = document.getElementById('agenda-view');
        const escalaRadio = document.getElementById('scale-view');
        
        // Add an event listener for the "ESCALA" view
        escalaRadio.addEventListener('change', function() {
            if (escalaRadio.checked) {
                window.location.href = "{% url 'escala' %}";  // Redirect to escala view
            }
        });

        // Add an event listener for the "AGENDA" view, in case you need to toggle back
        agendaRadio.addEventListener('change', function() {
            if (agendaRadio.checked) {
                window.location.href = "{% url 'agenda' %}";  // Redirect to agenda view
            }
        });
    });
</script>
{% endblock %}
