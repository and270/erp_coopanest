{% extends 'layout.html' %}
{% load static %}
{% load tz %}

{% block title %}Agenda{% endblock %}

{% block content %}
<!--
<div>
    <h3>Detailed Debug Info:</h3>
    <p>Number of procedimentos: {{ procedimentos|length }}</p>
    {% for proc in procedimentos %}
        <p>Procedimento: {{ proc.nome_paciente }} - {{ proc.data_horario|date:"Y-m-d H:i" }}</p>
        {% for date in week_dates %}
            <p>Comparing with: {{ date.full_date|date:"Y-m-d" }} - Date Match: {% if proc.data_horario|date:"Y-m-d" == date.full_date|date:"Y-m-d" %}Yes{% else %}No{% endif %}</p>
            {% if proc.data_horario|date:"Y-m-d" == date.full_date|date:"Y-m-d" %}
                {% for hour in hours %}
                    <p>Hour comparison: Procedure hour: {{ proc.data_horario|date:"H" }}, Comparing with: {{ hour }} - Hour Match: {% if proc.data_horario|date:"H" == hour %}Yes{% else %}No{% endif %}</p>
                {% endfor %}
            {% endif %}
        {% endfor %}
    {% endfor %}
    <p>Current week dates:</p>
    {% for date in week_dates %}
        <p>{{ date.full_date|date:"Y-m-d" }} ({{ date.day_name }})</p>
    {% endfor %}
    <p>Hours being checked:</p>
    <p>{{ hours|join:", " }}</p>
</div>
-->
<div class="agenda-container">
    <div class="agenda-header">
        <div class="left-controls">
            Agenda
        </div>

        <div class="center-controls">
            <!-- This div is now empty but still maintains the space -->
        </div>

        <div class="right-controls">
            <div class="agenda-scale">
                <input type="radio" id="scale-view" name="view-toggle">
                <label for="scale-view"><b>Escala</b></label>
                <input type="radio" id="agenda-view" name="view-toggle" checked>
                <label for="agenda-view"><b>Agenda</b></label>
            </div>
            <button id="open-import-modal" class="btn btn-secondary" style="margin-left: 10px;">Importar</button>
        </div>
    </div>

    <div class="calendar-container">
        <div class="calendar-sidebar">
            <div class="mini-calendar">
                <div class="mini-calendar-header">
                    <span id="mini-current-month"></span>
                    <button id="mini-prev-btn" class="btn-link">&lt;</button>
                    <button id="mini-next-btn" class="btn-link">&gt;</button>
                </div>
                <div class="mini-calendar-weekdays">
                    <span>D</span><span>S</span><span>T</span><span>Q</span><span>Q</span><span>S</span><span>S</span>
                </div>
                <div class="mini-calendar-dates" id="mini-calendar-dates">
                    <!-- Dates will be populated here by JavaScript -->
                </div>
            </div>
            <div class="event-types-container">
                <div class="event-types-legend">Legenda</div>
                <ul class="event-types">
                    <li><button class="btn-consultas">Consulta</button></li>
                    <li><button class="btn-procedimentos">Cirurgia / Procedimento ambulatorial</button></li>
                </ul>
            </div>
        </div>
        <div class="calendar-main">
            <div class="sub-controls">
                <div class="view-switcher">
                    <a href="#" id="prev-btn" class="btn btn-link">&lt;</a>
                    <a href="#" id="next-btn" class="btn btn-link">&gt;</a>
                    <h2 id="current-date-range"></h2>
                </div>
                <div class="view-type-switcher">
                    <select id="view-select" class="btn">
                        <option value="mes" {% if view_type == 'month' %}selected{% endif %}>Mês</option>
                        <option value="semana" {% if view_type == 'week' %}selected{% endif %}>Semana</option>
                    </select>
                </div>
                <div class="search-bar">
                    <div class="input-group">
                        <input type="text" id="search-patient-input" placeholder="Paciente">
                        <button id="search-patient-btn"><i class="fas fa-search"></i></button>
                    </div>
                    <div class="input-group">
                        <input type="text" id="search-date-input" placeholder="Data">
                        <button id="search-date-btn"><i class="fas fa-search"></i></button>
                    </div>
                </div>
            </div>
            <div class="calendar-grid month-view">
                <div class="calendar-days">
                    <span>DOM</span>
                    <span>SEG</span>
                    <span>TER</span>
                    <span>QUA</span>
                    <span>QUI</span>
                    <span>SEX</span>
                    <span>SÁB</span>
                </div>
                {% for date in calendar_dates %}
                    <div class="day" data-date="{{ date.day|date:'Y-m-d' }}">
                        <span>{{ date.day.day }}</span>
                        {% for procedimento in procedimentos %}
                            {% with local_time=procedimento.data_horario|localtime %}
                            {% if local_time|date:'Y-m-d' == date.day|date:'Y-m-d' %}
                                <div class="procedure-card {% if procedimento.procedimento_type == 'consulta' %}consulta{% elif procedimento.procedimento_type == 'cirurgia_procedimento_ambulatorial' %}cirurgia-ambulatorial{% endif %}" data-id="{{ procedimento.id }}" data-date="{{ local_time|date:'Y-m-d' }}">
                                    <span class="procedure-time-patient">{{ local_time|date:"H:i" }} <b>{{ procedimento.nome_paciente }}</b></span>
                                    <span class="procedure-name">{{ procedimento.procedimento_principal.name|truncatechars:20 }}</span>
                                    <span class="procedure-anesthesiologist">
                                        {% if procedimento.cooperado %}{{ procedimento.cooperado.name }}{% endif %}
                                        {% if procedimento.anestesistas_livres %}{% if procedimento.cooperado %}, {% endif %}{{ procedimento.anestesistas_livres }}{% endif %}
                                    </span>
                                </div>
                                <div id="procedure-details-modal-{{ procedimento.id }}" class="procedure-modal" style="display:none;">
                                    <div class="procedure-modal-content">
                                        <span class="close-modal">&times;</span>
                                        <p><span class="modal-patient-name">{{ procedimento.nome_paciente }}</span></p>
                                        <p><span class="modal-date">{{ local_time|date:"d/m/Y" }}</span></p>
                                        <p><span class="modal-start-time">{{ local_time|date:"H:i" }}</span>{% if procedimento.data_horario_fim %}<span> - </span><span class="modal-end-time">{{ procedimento.data_horario_fim|localtime|date:"H:i" }}</span>{% endif %}</p>
                                        <br>
                                        <p>Procedimento principal: <strong><span class="modal-procedure">{{ procedimento.procedimento_principal.name }}</span></strong></p>
                                        <p>Eletiva ou Urgência: <strong><span>{{ procedimento.get_tipo_procedimento_display }}</span></strong></p>
                                        <p>Email: <span class="modal-email"><strong>{{ procedimento.email_paciente|default:"Não informado" }}</strong></span></p>
                                        <p>Convênio: <span class="modal-convenio"><strong>{{ procedimento.convenio.name|default:"Não informado" }}</strong></span></p>
                                        <p>Local: <strong><span class="modal-hospital">{{ procedimento.hospital.name|default:procedimento.outro_local|default:"Não informado" }}</span></strong></p>
                                        <p>Cirurgião: <strong><span class="modal-surgeon">
                                            {% if procedimento.cirurgiao %}
                                                {{ procedimento.cirurgiao.name }}
                                            {% else %}
                                                {{ procedimento.cirurgiao_nome|default:"Não informado" }}
                                            {% endif %}
                                        </span></strong></p>
                                        <p>Cooperado: <strong><span class="modal-cooperado">{% if procedimento.cooperado %}{{ procedimento.cooperado.name }}{% else %}--{% endif %}</span></strong></p>
                                        <p>Anestesistas: <strong><span class="modal-anesthesiologists">{{ procedimento.anestesistas_livres|default:"--" }}</span></strong></p>
                                        <p>Visita Pré-Anestésica: <strong><span class="modal-pre-anesthetic-visit">{{ procedimento.visita_pre_anestesica|yesno:"Sim,Não" }}</span></strong></p>
                                        <p>Data da Visita Pré-Anestésica: <strong><span class="modal-pre-anesthetic-visit-date">{{ procedimento.data_visita_pre_anestesica|date:"d/m/Y"|default:"Não realizada" }}</span></strong></p>
                                        <p>Responsável pela Visita: <strong><span class="modal-visit-responsible">{{ procedimento.nome_responsavel_visita|default:"Não informado" }}</span></strong></p>
                                        <p>Anexo Visita Pré-Anestésica:
                                            {% if procedimento.foto_anexo %}
                                                <a href="{% url 'protected_file' procedimento.foto_anexo.name %}" target="_blank" class="modal-attachment">Ver anexo</a>
                                            {% else %}
                                                <span class="modal-attachment">Nenhum anexo disponível</span>
                                            {% endif %}
                                        </p>
                                        <div class="modal-actions">
                                            <button class="btn btn-primary edit-procedure">Editar</button>
                                            <button class="btn btn-danger delete-procedure">Excluir</button>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                            {% endwith %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <div class="calendar-grid week-view">
                <div class="calendar-days">
                    <span class="time-column"></span>
                    {% for date in week_dates %}
                        <span class="day-column" data-date="{{ date.full_date|date:'Y-m-d' }}">
                            {{ date.day_name }}<br>
                            ({{ date.date }})
                        </span>
                    {% endfor %}
                </div>
                <div class="time-slots">
                    {% for hour in hours %}
                        <div class="time-slot">{{ hour }}:00</div>
                    {% endfor %}
                </div>
                {% for date in week_dates %}
                    <div class="day-column" data-date="{{ date.full_date|date:'Y-m-d' }}">
                        {% for hour in hours %}
                            <div class="hour-slot" data-hour="{{ hour }}">
                                {% for procedimento in procedimentos %}
                                    {% with local_time=procedimento.data_horario|localtime %}
                                    {% if local_time|date:"Y-m-d H" == date.full_date|date:"Y-m-d"|add:" "|add:hour %}
                                        <div class="procedure-card week-view-card {% if procedimento.procedimento_type == 'consulta' %}consulta{% elif procedimento.procedimento_type == 'cirurgia_procedimento_ambulatorial' %}cirurgia-ambulatorial{% endif %}" data-id="{{ procedimento.id }}" data-date="{{ local_time|date:'Y-m-d' }}">
                                            <div class="procedure-first-row">
                                                <span class="procedure-time">{{ local_time|date:"H:i" }}</span>
                                                <span class="procedure-patient">{{ procedimento.nome_paciente }}</span>
                                            </div>
                                            <span class="procedure-name">{{ procedimento.procedimento_principal.name|truncatechars:15 }}</span>
                                            <span class="procedure-anesthesiologist">
                                                {% if procedimento.cooperado %}{{ procedimento.cooperado.name|truncatechars:15 }}{% endif %}
                                                {% if procedimento.anestesistas_livres %}{% if procedimento.cooperado %}, {% endif %}{{ procedimento.anestesistas_livres|truncatechars:30 }}{% endif %}
                                            </span>
                                        </div>
                                        <div id="procedure-details-modal-{{ procedimento.id }}" class="procedure-modal" style="display:none;">
                                            <div class="procedure-modal-content">
                                                <span class="close-modal">&times;</span>
                                                <p><span class="modal-patient-name">{{ procedimento.nome_paciente }}</span></p>
                                                <p><span class="modal-date">{{ local_time|date:"d/m/Y" }}</span></p>
                                                <p><span class="modal-start-time">{{ local_time|date:"H:i" }}</span>{% if procedimento.data_horario_fim %}<span> - </span><span class="modal-end-time">{{ procedimento.data_horario_fim|localtime|date:"H:i" }}</span>{% endif %}</p>
                                                <br>
                                                <p>Procedimento principal: <strong><span class="modal-procedure">{{ procedimento.procedimento_principal.name }}</span></strong></p>
                                                <p>Eletiva ou Urgência: <strong><span>{{ procedimento.get_tipo_procedimento_display }}</span></strong></p>
                                                <p>Email: <span class="modal-email"><strong>{{ procedimento.email_paciente|default:"Não informado" }}</strong></span></p>
                                                <p>Convênio: <span class="modal-convenio"><strong>{{ procedimento.convenio.name|default:"Não informado" }}</strong></span></p>
                                                <p>Local: <strong><span class="modal-hospital">{{ procedimento.hospital.name|default:procedimento.outro_local|default:"Não informado" }}</span></strong></p>
                                                <p>Cirurgião: <strong><span class="modal-surgeon">
                                                    {% if procedimento.cirurgiao %}
                                                        {{ procedimento.cirurgiao.name }}
                                                    {% else %}
                                                        {{ procedimento.cirurgiao_nome|default:"Não informado" }}
                                                    {% endif %}
                                                </span></strong></p>
                                                <p>Cooperado: <strong><span class="modal-cooperado">{% if procedimento.cooperado %}{{ procedimento.cooperado.name }}{% else %}--{% endif %}</span></strong></p>
                                                <p>Anestesistas: <strong><span class="modal-anesthesiologists">{{ procedimento.anestesistas_livres|default:"--" }}</span></strong></p>
                                                <p>Visita Pré-Anestésica: <strong><span class="modal-pre-anesthetic-visit">{{ procedimento.visita_pre_anestesica|yesno:"Sim,Não" }}</span></strong></p>
                                                <p>Data da Visita Pré-Anestésica: <strong><span class="modal-pre-anesthetic-visit-date">{{ procedimento.data_visita_pre_anestesica|date:"d/m/Y"|default:"Não realizada" }}</span></strong></p>
                                                <p>Responsável pela Visita: <strong><span class="modal-visit-responsible">{{ procedimento.nome_responsavel_visita|default:"Não informado" }}</span></strong></p>
                                                <p>Anexo Visita Pré-Anestésica:
                                                    {% if procedimento.foto_anexo %}
                                                        <a href="{% url 'protected_file' procedimento.foto_anexo.name %}" target="_blank" class="modal-attachment">Ver anexo</a>
                                                    {% else %}
                                                        <span class="modal-attachment">Nenhum anexo disponível</span>
                                                    {% endif %}
                                                </p>
                                                <div class="modal-actions">
                                                    <button class="btn btn-primary edit-procedure">Editar</button>
                                                    <button class="btn btn-danger delete-procedure">Excluir</button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                    {% endwith %}
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<button class="btn btn-primary" id="agendar-btn">Agendar</button>
<div id="procedimento-form-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h2>Agendamento</h2>
        <span class="required-field-text"><span class="required-asterisk">*</span>Campo de preenchimento obrigatório</span><br><br>
        <form method="POST" enctype="multipart/form-data" id="procedimento-form">
            {% csrf_token %}
            <input type="hidden" name="procedure_id" id="procedure_id">
            {{ form.non_field_errors }}
            
            <div class="form-group">
                <label for="{{ form.data.id_for_label }}">{{ form.data.label }}<span class="required-asterisk">*</span></label>
                {{ form.data }}
            </div>
            
            <div class="time-inputs">
                <div class="form-group">
                    <label for="{{ form.time.id_for_label }}">{{ form.time.label }}<span class="required-asterisk">*</span></label>
                    {{ form.time }}
                </div>
                
                <div class="form-group">
                    <label for="{{ form.end_time.id_for_label }}">{{ form.end_time.label }}</label>
                    {{ form.end_time }}
                </div>
            </div>
            
            <div class="form-group">
                <label for="{{ form.nome_paciente.id_for_label }}">{{ form.nome_paciente.label }}<span class="required-asterisk">*</span></label>
                {{ form.nome_paciente }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.email_paciente.id_for_label }}">{{ form.email_paciente.label }}</label>
                {{ form.email_paciente }}
            </div>

            <div class="form-group">
                <label for="{{ form.convenio.id_for_label }}">{{ form.convenio.label }}</label>
                {{ form.convenio }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.convenio_nome_novo.id_for_label }}">{{ form.convenio_nome_novo.label }}</label>
                {{ form.convenio_nome_novo }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.cpf_paciente.id_for_label }}">{{ form.cpf_paciente.label }}</label>
                {{ form.cpf_paciente }}
            </div>
            
            
            <div class="form-group">
                <label for="{{ form.procedimento_principal.id_for_label }}">{{ form.procedimento_principal.label }}<span class="required-asterisk">*</span></label>
                {{ form.procedimento_principal }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.tipo_procedimento.id_for_label }}">{{ form.tipo_procedimento.label }}</label>
                {{ form.tipo_procedimento }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.tipo_clinica.id_for_label }}">{{ form.tipo_clinica.label }}</label>
                {{ form.tipo_clinica }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.hospital.id_for_label }}">{{ form.hospital.label }}</label>
                {{ form.hospital }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.outro_local.id_for_label }}">{{ form.outro_local.label }}</label>
                {{ form.outro_local }}
            </div>
            
            <div class="form-group">
                <label for="{{ form.cirurgiao.id_for_label }}">{{ form.cirurgiao.label }}</label>
                {{ form.cirurgiao }}
                <div class="mt-2">
                    <label for="{{ form.cirurgiao_nome.id_for_label }}">{{ form.cirurgiao_nome.label }}</label>
                    {{ form.cirurgiao_nome }}
                </div>
            </div>

            <div class="form-group">
                <label for="{{ form.cooperado.id_for_label }}">{{ form.cooperado.label }}</label>
                {{ form.cooperado }}
            </div>

            <div class="form-group">
                <label>Anestesista(s)</label>
                <div class="input-group">
                    <input type="text" id="anest-free-input" class="form-control" placeholder="Nome do anestesista">
                    <button type="button" id="add-free-anest" class="btn btn-secondary btn-sm mt-2">+ Adicionar</button>
                </div>
                {{ form.anestesistas_livres }}
                
            </div>

            <div id="selected-anesthesiologists-container" class="mt-2">
                <!-- Free-text anesthesiologists will be added here -->
            </div>
            
            <div class="form-group-inline">
                <label for="{{ form.visita_pre_anestesica.id_for_label }}">{{ form.visita_pre_anestesica.label }}</label>
                {{ form.visita_pre_anestesica }}
            </div>
            
            <div class="conditional-container" style="display:none;">
                <div class="form-group">
                    <label for="{{ form.data_visita_pre_anestesica.id_for_label }}">{{ form.data_visita_pre_anestesica.label }}</label>
                    {{ form.data_visita_pre_anestesica }}
                </div>
                <div class="form-group">
                    <label for="{{ form.foto_anexo.id_for_label }}">{{ form.foto_anexo.label }}</label>
                    {{ form.foto_anexo }}
                </div>
                <div class="form-group">
                    <label for="{{ form.nome_responsavel_visita.id_for_label }}">{{ form.nome_responsavel_visita.label }}</label>
                    {{ form.nome_responsavel_visita }}
                </div>
            </div>
            
            <button type="submit" class="cadastrar-btn" id="form-submit-btn">Criar Agendamento</button>
        </form>
    </div>
</div>
<div id="customAlert" class="custom-alert"></div>

<!-- Import Modal (same structure/styles as other modals) -->
<div id="import-modal" class="modal" style="display:none;">
    <div class="modal-content">
        <span class="close" id="close-import-modal">&times;</span>
        <h2>Importar Agendamentos (.xlsx)</h2>
        <p class="required-field-text" style="margin-bottom: 10px;">Use planilha com as colunas suportadas: <strong>Obrigatórias:</strong> Data, Paciente. <strong>Opcionais:</strong> Hora início, Hora fim, N° CPSA, Plano de saúde, Hospital/Clínica, Eletivo/Urgência, CPF, Cirurgia/Códigos, Anestesista/Cooperado, Cirurgião, Forma Pagamento, Valor, Data Recebimento, Valor Recebido, Observação.</p>
        <form>
            <div class="form-group">
                <label for="import-file">Arquivo .xlsx</label>
                <input type="file" id="import-file" accept=".xlsx">
            </div>
            <button type="button" class="cadastrar-btn" id="run-import-btn">Importar</button>
        </form>
        <div id="import-results" style="margin-top: 15px; max-height: 300px; overflow: auto;"></div>
    </div>
    
</div>

{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.6/jquery.inputmask.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>

<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<!-- Initialize Select2 -->
<script>
    $(document).ready(function() {
        $('#{{ form.procedimento_principal.auto_id }}').select2({
            placeholder: 'Digite para buscar...',
            minimumInputLength: 2,
            language: 'pt-BR',
            ajax: {
                url: '{% url "procedure-autocomplete" %}',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return {
                        q: params.term,
                        page: params.page
                    };
                },
                processResults: function(data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            }
        });

        $('#{{ form.convenio.auto_id }}').select2({
            placeholder: 'Digite para buscar convênio...',
            minimumInputLength: 2,
            language: 'pt-BR',
            ajax: {
                url: '{% url "convenio-autocomplete" %}',
                dataType: 'json',
                delay: 250,
                data: function(params) {
                    return {
                        q: params.term,
                        page: params.page
                    };
                },
                processResults: function(data) {
                    return {
                        results: data.results
                    };
                },
                cache: true
            }
        });
    });
</script>

<!-- Portuguese language for Select2 -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/pt-BR.js"></script>

<script>
    $(document).ready(function() {
        $('#{{ form.cpf_paciente.id_for_label }}').mask('000.000.000-00', {reverse: true});
    });
</script>
<script>
    function openFormModal(date, time) {
    const formModal = document.getElementById('procedimento-form-modal');
    const dateField = document.getElementById('id_data');
    const timeField = document.getElementById('id_time');
    const formSubmitBtn = document.getElementById('form-submit-btn');  // Define formSubmitBtn here

    // Reset the form and clear procedure_id
    document.querySelector('#procedimento-form-modal form').reset();
    document.getElementById('procedure_id').value = '';
    formSubmitBtn.textContent = 'Criar Agendamento'; // Reset button text to default

    // Pre-fill the date and time fields
    $(dateField).inputmask("setvalue", date);
    if (time) {
        $(timeField).inputmask("setvalue", time);
    } else {
        $(timeField).inputmask("setvalue", "");
    }

    // Show the form modal
    formModal.style.display = 'block';
    hideAgendarButton();
}

</script>
<script>
    function showCustomAlert(message, type) {
        const alertElement = document.getElementById('customAlert');
        alertElement.textContent = message;
        alertElement.className = `custom-alert ${type}`;
        alertElement.style.display = 'block';
        
        setTimeout(() => {
            alertElement.style.display = 'none';
        }, 3500);  // Hide after 5 seconds
    }
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const semanaBtn = document.getElementById('semana-view');
    const mesBtn = document.getElementById('mes-view');
    const monthView = document.querySelector('.month-view');
    const weekView = document.querySelector('.week-view');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const currentDateRange = document.getElementById('current-date-range');

    let currentView = '{{ view_type }}';
    let currentYear = parseInt("{{ current_year }}");
    let currentMonth = parseInt("{{ current_month }}");
    let currentWeekStart = new Date('{{ current_week_start|date:"Y-m-d" }}T00:00:00');

    const MONTH_NAMES_PT = {
        1: 'Janeiro', 2: 'Fevereiro', 3: 'Março', 4: 'Abril',
        5: 'Maio', 6: 'Junho', 7: 'Julho', 8: 'Agosto',
        9: 'Setembro', 10: 'Outubro', 11: 'Novembro', 12: 'Dezembro'
    };

    function updateDateRange() {
        if (currentView === 'month') {
            currentDateRange.textContent = `${MONTH_NAMES_PT[currentMonth]} de ${currentYear}`;
        } else {
            const weekStartCopy = new Date(currentWeekStart.getTime());
            const weekEnd = new Date(currentWeekStart.getTime());
            weekEnd.setDate(weekEnd.getDate() + 6);
            const startDateFormatted = weekStartCopy.toLocaleDateString('pt-BR', { day: 'numeric', month: 'numeric' });
            const endDateFormatted = weekEnd.toLocaleDateString('pt-BR', { day: 'numeric', month: 'numeric' });

            currentDateRange.textContent = `${startDateFormatted} a ${endDateFormatted}`;
        }
    }

    function loadView(year, month, weekStart) {
        const base_url = "{% url 'agenda' %}";
        const url = new URL(window.location.origin + base_url);
        url.searchParams.set('year', year);
        url.searchParams.set('month', month);
        if (weekStart) {
            url.searchParams.set('week_start', weekStart.toISOString().split('T')[0]);
        } else {
            url.searchParams.delete('week_start');
        }
        window.location.href = url.toString();
    }

    function updateViewDisplay() {
        if (currentView === 'week') {
            monthView.style.display = 'none';
            weekView.style.display = 'grid';
        } else {
            monthView.style.display = 'grid';
            weekView.style.display = 'none';
        }
    }

    updateViewDisplay();
    updateDateRange();

    function getFirstDayOfWeek(date) {
        const dateCopy = new Date(date.getTime());
        const day = dateCopy.getDay(); // 0 for Sunday
        const diff = dateCopy.getDate() - day;
        dateCopy.setDate(diff);
        return dateCopy;
    }

    const viewSelect = document.getElementById('view-select');
    // Event listener for the dropdown
    viewSelect.addEventListener('change', function() {
        const selectedView = this.value;
        if (selectedView === 'semana') {
            currentView = 'week';
            currentWeekStart = getFirstDayOfWeek(new Date());
            currentYear = currentWeekStart.getFullYear();
            currentMonth = currentWeekStart.getMonth() + 1; // months are zero-based
        } else if (selectedView === 'mes') {
            currentView = 'month';
        }
        updateViewDisplay();
        updateDateRange();
        loadView(currentYear, currentMonth, currentView === 'week' ? currentWeekStart : null);
    });

    prevBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (currentView === 'month') {
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
        } else {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
            currentYear = currentWeekStart.getFullYear();
            currentMonth = currentWeekStart.getMonth() + 1; // months are zero-based
        }
        updateDateRange();
        loadView(currentYear, currentMonth, currentView === 'week' ? currentWeekStart : null);
    });

    nextBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (currentView === 'month') {
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
        } else {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
            currentYear = currentWeekStart.getFullYear();
            currentMonth = currentWeekStart.getMonth() + 1; // months are zero-based
        }
        updateDateRange();
        loadView(currentYear, currentMonth, currentView === 'week' ? currentWeekStart : null);
    });

    function formatDate(dateString) {
        const date = new Date(dateString);
        // Adjust for local time zone
        date.setMinutes(date.getMinutes() + date.getTimezoneOffset());
        return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
    }

    // Month view event listener
    document.querySelectorAll('.calendar-grid.month-view .day').forEach(cell => {
        cell.addEventListener('click', function() {
            const date = this.getAttribute('data-date');
            if (date) {
                const formattedDate = formatDate(date);
                openFormModal(formattedDate);
            }
        });
    });

    // Week view event listener
    document.querySelectorAll('.calendar-grid.week-view .hour-slot').forEach(cell => {
        cell.addEventListener('click', function(e) {
            if (!e.target.closest('.procedure-card')) {
                const dayColumn = this.closest('.day-column');
                const date = dayColumn.getAttribute('data-date');
                const hour = this.getAttribute('data-hour');
                if (date && hour) {
                    const formattedDate = formatDate(date);
                    const formattedTime = `${hour}:00`;
                    openFormModal(formattedDate, formattedTime);
                }
            }
        });
    });
    
});

</script>

<script>
    document.getElementById('agendar-btn').addEventListener('click', function() {
        document.getElementById('procedimento-form-modal').style.display = 'block';
    }); 
    document.querySelector('.close').addEventListener('click', function() {
        document.getElementById('procedimento-form-modal').style.display = 'none';
        showAgendarButton();
    });
</script>
<script>
    // Import modal open/close
    (function(){
        const openBtn = document.getElementById('open-import-modal');
        const modal = document.getElementById('import-modal');
        const closeBtn = document.getElementById('close-import-modal');
        const runBtn = document.getElementById('run-import-btn');
        const fileInput = document.getElementById('import-file');
        const resultsDiv = document.getElementById('import-results');

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        function renderResults(data){
            const container = document.createElement('div');
            const summary = document.createElement('p');
            summary.innerHTML = `<strong>Criados:</strong> ${data.created} | <strong>CPSA vinculados:</strong> ${data.financas_linked}`;
            container.appendChild(summary);

            if (data.results && data.results.length){
                const list = document.createElement('div');
                data.results.forEach(r => {
                    const row = document.createElement('div');
                    row.style.padding = '6px 0';
                    const msgs = (r.errors || r.warnings || []).join('; ');
                    row.textContent = `Linha ${r.row} — ${r.status}${msgs ? ' — ' + msgs : ''}`;
                    list.appendChild(row);
                });
                container.appendChild(list);
            }

            const btn = document.createElement('button');
            btn.className = 'cadastrar-btn';
            btn.id = 'reload-after-import';
            btn.textContent = 'Recarregar página';
            btn.addEventListener('click', () => window.location.reload());
            container.appendChild(btn);

            resultsDiv.innerHTML = '';
            resultsDiv.appendChild(container);
        }

        if (openBtn){
            openBtn.addEventListener('click', function(){
                resultsDiv.innerHTML = '';
                fileInput.value = '';
                modal.style.display = 'block';
            });
        }
        if (closeBtn){
            closeBtn.addEventListener('click', function(){
                modal.style.display = 'none';
            });
        }
        window.addEventListener('click', function(e){
            if (e.target === modal){ modal.style.display = 'none'; }
        });

        if (runBtn){
            runBtn.addEventListener('click', function(){
                const file = fileInput.files && fileInput.files[0];
                if (!file){
                    showCustomAlert('Selecione um arquivo .xlsx para importar.', 'error');
                    return;
                }
                const formData = new FormData();
                formData.append('file', file);
                runBtn.disabled = true;
                runBtn.textContent = 'Importando...';
                fetch('/agenda/import/', {
                    method: 'POST',
                    headers: { 'X-CSRFToken': getCookie('csrftoken') },
                    body: formData
                })
                .then(r => r.json())
                .then(data => {
                    if (!data.success){
                        showCustomAlert(data.message || 'Falha na importação.', 'error');
                    } else {
                        showCustomAlert('Importação concluída.', 'success');
                        renderResults(data);
                    }
                })
                .catch(err => {
                    console.error(err);
                    showCustomAlert('Erro ao importar. Tente novamente.', 'error');
                })
                .finally(() => {
                    runBtn.disabled = false;
                    runBtn.textContent = 'Importar';
                });
            });
        }
    })();
</script>
<script>
    $(document).ready(function(){
        // Apply masks
        $("input[name='data']").inputmask("99/99/9999");  // dd/mm/yyyy
        $("input[name='time'], input[name='end_time']").inputmask("99:99");  // hh:mm
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const visitaPreAnestesicaCheckbox = document.getElementById('id_visita_pre_anestesica');
        const conditionalContainer = document.querySelector('.conditional-container'); // Change this line

        function toggleConditionalFields() {
            if (visitaPreAnestesicaCheckbox.checked) {
                conditionalContainer.style.display = 'block';  // Show the container when checked
            } else {
                conditionalContainer.style.display = 'none';  // Hide the container when unchecked
            }
        }

        visitaPreAnestesicaCheckbox.addEventListener('change', toggleConditionalFields);
        toggleConditionalFields(); // Initial call to set the correct state on page load
    });

</script>

<script>
    // This script is used to hide the "Agendar" button when the form modal is open
    function hideAgendarButton() {
        document.getElementById('agendar-btn').style.display = 'none';
    }

    function showAgendarButton() {
        document.getElementById('agendar-btn').style.display = '';
    }
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const procedureCards = document.querySelectorAll('.calendar-grid .procedure-card');
    const procedureFormModal = document.getElementById('procedimento-form-modal');
    const formSubmitBtn = document.getElementById('form-submit-btn');
    const procedimentoForm = document.getElementById('procedimento-form');
    const selectedAnesthesiologistsContainer = document.getElementById('selected-anesthesiologists-container');
    const anestFreeInput = document.getElementById('anest-free-input');
    const addFreeAnestBtn = document.getElementById('add-free-anest');
    const hiddenAnestLivres = document.getElementById('id_anestesistas_livres');

    function syncHiddenFromChips() {
        const names = Array.from(selectedAnesthesiologistsContainer.querySelectorAll('.selected-anesthesiologist'))
            .map(div => div.dataset.name)
            .filter(Boolean);
        hiddenAnestLivres.value = names.join(', ');
    }

    function addFreeAnesthesiologist(name) {
        const trimmed = (name || '').trim();
        if (!trimmed) {
            showCustomAlert('Digite o nome do anestesista para adicionar.', 'error');
            return;
        }
        const exists = selectedAnesthesiologistsContainer.querySelector(`[data-name="${trimmed}"]`);
        if (exists) {
            showCustomAlert(`${trimmed} já foi adicionado.`, 'error');
            return;
        }
        const div = document.createElement('div');
        div.className = 'selected-anesthesiologist';
        div.dataset.name = trimmed;
        div.innerHTML = `${trimmed} <button type="button" class="btn btn-danger btn-sm remove-free-anest" data-name="${trimmed}">Remover</button>`;
        selectedAnesthesiologistsContainer.appendChild(div);
        anestFreeInput.value = '';
        syncHiddenFromChips();
    }

    function removeFreeAnesthesiologist(name) {
        const div = selectedAnesthesiologistsContainer.querySelector(`[data-name="${name}"]`);
        if (div) {
            div.remove();
            syncHiddenFromChips();
        }
    }

    if (addFreeAnestBtn) {
        addFreeAnestBtn.addEventListener('click', function() {
            addFreeAnesthesiologist(anestFreeInput.value);
        });
    }

    selectedAnesthesiologistsContainer.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('remove-free-anest')) {
            const name = e.target.dataset.name;
            removeFreeAnesthesiologist(name);
        }
    });
    
    procedimentoForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Change button text to spinner
        const originalText = formSubmitBtn.textContent;
        formSubmitBtn.innerHTML = '<span class="spinner"></span> Processando...';
        formSubmitBtn.disabled = true;

        const formData = new FormData(this);
        const procedureId = document.getElementById('procedure_id').value;

        // Debug: Log all form data being submitted
        console.log("FORM SUBMISSION - FormData contents:");
        for (const pair of formData.entries()) {
            console.log(pair[0] + ': ' + pair[1]);
        }

        // Reset previous error messages
        document.querySelectorAll('.error-message').forEach(el => el.remove());
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

        fetch(procedureId ? `/update-procedure/${procedureId}/` : '/create-procedure/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                let message = procedureId ? 'Procedimento editado com sucesso.' : 'Procedimento criado com sucesso.'
                if (data.email_sent === false && data.email_try === true) {
                    message += ` Porém, não foi possível enviar o link de pesquisa para o email do paciente devido a: ${data.email_error}`;
                } else if (data.email_sent === true) {
                    message += ' O link de pesquisa foi enviado para o email do paciente.';
                }
                showCustomAlert(message, 'success');
                showAgendarButton();
                setTimeout(() => {
                    location.reload();
                }, 2000);
            } else {
                // Error handling (display errors, reset button)
                const errors = JSON.parse(data.errors);
                Object.keys(errors).forEach(fieldName => {
                    // Handle field errors for 'anestesistas_responsaveis' specifically if needed
                    let field = document.getElementById(`id_${fieldName}`);
                    if (!field && fieldName === 'anestesistas_responsaveis') {
                        // If error is for the hidden field, show it near the selector
                        field = document.getElementById('id_anestesista_selector');
                    }

                    if (field) {
                        field.classList.add('is-invalid');
                        // Avoid adding multiple error messages
                        let errorMsgElement = field.parentNode.querySelector(`.invalid-feedback.error-message[data-field="${fieldName}"]`);
                        if (!errorMsgElement) {
                            errorMsgElement = document.createElement('div');
                            errorMsgElement.className = 'invalid-feedback error-message';
                            errorMsgElement.dataset.field = fieldName; // Mark which field it's for
                            field.parentNode.appendChild(errorMsgElement);
                        }
                        // Update or set the error message text
                        errorMsgElement.textContent = errors[fieldName][0].message;
                    } else if (fieldName === '__all__') {
                         // Handle non-field errors if necessary
                         showCustomAlert(errors[fieldName][0].message, 'error');
                    }
                });
                 if (!data.errors || Object.keys(JSON.parse(data.errors)).length === 0) {
                    // Show generic error if no specific field errors were returned
                    showCustomAlert(data.message || 'Erro ao salvar o procedimento. Verifique os campos e tente novamente.', 'error');
                } else {
                     showCustomAlert('Erro ao salvar o procedimento. Verifique os campos destacados.', 'error');
                }

                // Reset button state
                formSubmitBtn.innerHTML = originalText;
                formSubmitBtn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showCustomAlert('Ocorreu um erro ao processar a solicitação. Por favor, tente novamente.', 'error');
            
            // Reset button state
            formSubmitBtn.innerHTML = originalText;
            formSubmitBtn.disabled = false;
        });
    });

    procedureCards.forEach(card => {
        card.addEventListener('click', function(e) {
            e.stopPropagation();
            const procedureId = this.getAttribute('data-id');
            const modal = document.getElementById(`procedure-details-modal-${procedureId}`);

            if (modal) {
                modal.style.display = 'block'; // Show the modal
            }
        });
    });
    
    // Edit button click handler
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('edit-procedure')) {
            const modal = e.target.closest('.procedure-modal');
            const procedureId = modal.id.split('-').pop();
            
            // Hide the details modal
            modal.style.display = 'none';
            
            // Load the procedure data into the form
            loadProcedureDataIntoForm(procedureId);
        }
    });
    
    // Delete button click handler
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('delete-procedure')) {
            const modal = e.target.closest('.procedure-modal');
            const procedureId = modal.getAttribute('id').split('-').pop();
            
            if (confirm('Tem certeza que deseja excluir este agendamento?')) {
                deleteProcedure(procedureId);
            }
        }
    });

    
    // Function to load procedure data into the form
    function loadProcedureDataIntoForm(procedureId) {
        fetch(`/get-procedure/${procedureId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('procedure_id').value = procedureId;
                document.getElementById('id_data').value = data.data;
                
                // Directly use the time strings from the server
                document.getElementById('id_time').value = data.time;
                document.getElementById('id_end_time').value = data.end_time;
                
                document.getElementById('id_nome_paciente').value = data.nome_paciente;
                document.getElementById('id_email_paciente').value = data.email_paciente;
                document.getElementById('id_convenio_nome_novo').value = data.convenio_nome_novo;
                document.getElementById('id_cpf_paciente').value = data.cpf_paciente;
                document.getElementById('id_hospital').value = data.hospital;
                document.getElementById('id_outro_local').value = data.outro_local;
                document.getElementById('id_cirurgiao').value = data.cirurgiao;
                document.getElementById('id_cirurgiao_nome').value = data.cirurgiao_nome;
                document.getElementById('id_visita_pre_anestesica').checked = data.visita_pre_anestesica;
                document.getElementById('id_data_visita_pre_anestesica').value = data.data_visita_pre_anestesica;
                document.getElementById('id_nome_responsavel_visita').value = data.nome_responsavel_visita;
                document.getElementById('id_tipo_procedimento').value = data.tipo_procedimento;
                // Ensure tipo_clinica is set and option exists
                (function populateTipoClinica(){
                    const select = document.getElementById('id_tipo_clinica');
                    if (!select) return;
                    const key = data.tipo_clinica || '';
                    const label = data.tipo_clinica_label || '';
                    if (key){
                        let hasOption = false;
                        for (let i=0;i<select.options.length;i++){
                            if (select.options[i].value === key){ hasOption = true; break; }
                        }
                        if (!hasOption){
                            const opt = document.createElement('option');
                            opt.value = key;
                            opt.text = label || key;
                            select.appendChild(opt);
                        }
                        select.value = key;
                    } else {
                        select.value = '';
                    }
                })();
                
                // Fix for procedimento_principal (Select2)
                if (data.procedimento_principal) {
                    // Create a new option and append it to the select
                    const newOption = new Option(
                        data.procedimento_principal.text,
                        data.procedimento_principal.id,
                        true,
                        true
                    );
                    $('#id_procedimento_principal').empty().append(newOption).trigger('change');
                }

                // Fix for convenio (Select2)
                if (data.convenio) {
                    // Create a new option and append it to the select
                    const newOption = new Option(
                        data.convenio.text,
                        data.convenio.id,
                        true,
                        true
                    );
                    $('#id_convenio').empty().append(newOption).trigger('change');
                }

                // Populate Cooperado (ensure option exists and is selected)
                (function populateCooperado() {
                    const coopSelect = document.getElementById('id_cooperado');
                    console.log('Cooperado select element:', coopSelect);
                    console.log('Data cooperado:', data.cooperado);
                    if (!coopSelect) {
                        console.error('Cooperado select not found!');
                        return;
                    }

                    console.log('Current options count:', coopSelect.options.length);
                    for (let i = 0; i < coopSelect.options.length; i++) {
                        console.log(`Option ${i}: value="${coopSelect.options[i].value}", text="${coopSelect.options[i].text}"`);
                    }

                    if (data.cooperado && data.cooperado.id) {
                        const targetValue = String(data.cooperado.id);
                        console.log('Target cooperado value:', targetValue);
                        let hasOption = false;
                        for (let i = 0; i < coopSelect.options.length; i++) {
                            if (coopSelect.options[i].value === targetValue) { 
                                hasOption = true; 
                                console.log('Found existing option at index', i);
                                break; 
                            }
                        }
                        if (!hasOption) {
                            console.log('Option not found, adding new option');
                            const opt = document.createElement('option');
                            opt.value = targetValue;
                            opt.text = data.cooperado.name || `ID ${targetValue}`;
                            coopSelect.appendChild(opt);
                        }
                        coopSelect.value = targetValue;
                        console.log('Set cooperado select value to:', coopSelect.value);
                    } else {
                        console.log('No cooperado data, clearing selection');
                        coopSelect.value = '';
                    }
                })();

                // Populate Anestesistas Livres
                selectedAnesthesiologistsContainer.innerHTML = '';
                hiddenAnestLivres.value = '';
                if (data.anestesistas_livres) {
                    data.anestesistas_livres.split(',').forEach(n => {
                        const name = n.trim();
                        if (name) addFreeAnesthesiologist(name);
                    });
                }

                procedureFormModal.style.display = 'block';
                formSubmitBtn.textContent = 'Salvar Alterações';
                hideAgendarButton();

                // Ensure conditional fields for visita pre-anestesica are shown/hidden correctly
                toggleConditionalFields();
            });
    }
    
    // Function to delete a procedure
    function deleteProcedure(procedureId) {
        if (!procedureId) {
            console.error('Invalid procedure ID');
            return;
        }

        fetch(`/delete-procedure/${procedureId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                showCustomAlert('Procedimento excluído com sucesso.', 'success');
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                showCustomAlert('Falha ao excluir o procedimento. Por favor, tente novamente.', 'error');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showCustomAlert('Ocorreu um erro ao excluir o procedimento. Por favor, tente novamente.', 'error');
        });
    }
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Reset form when opening for a new procedure
    document.getElementById('agendar-btn').addEventListener('click', function() {
        document.querySelector('#procedimento-form-modal form').reset();
        // Clear Select2 fields
        $('#id_procedimento_principal').val(null).trigger('change');
        $('#id_convenio').val(null).trigger('change');
        // Clear anesthesiologists free-text list and cooperado
        const selectedAnesthesiologistsContainer = document.getElementById('selected-anesthesiologists-container');
        if (selectedAnesthesiologistsContainer) selectedAnesthesiologistsContainer.innerHTML = '';
        const hiddenAnestLivres = document.getElementById('id_anestesistas_livres');
        if (hiddenAnestLivres) hiddenAnestLivres.value = '';
        const coopSelect = document.getElementById('id_cooperado');
        if (coopSelect) coopSelect.value = '';

        document.getElementById('procedure_id').value = '';
        formSubmitBtn.textContent = 'Criar Agendamento';
        procedureFormModal.style.display = 'block';
        hideAgendarButton();
        toggleConditionalFields(); // Set initial state for conditional fields
    });
});
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const procedureModals = document.querySelectorAll('.procedure-modal');
        const procedureFormModal = document.getElementById('procedimento-form-modal');
        
        // Close modal when clicking the "X"
        procedureModals.forEach(modal => {
            modal.querySelector('.close-modal').addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent further event propagation
                modal.style.display = 'none';
            });
        });

        // Close modal when clicking outside of it
        window.addEventListener('click', function(e) {
            procedureModals.forEach(modal => {
                if (e.target == modal) {
                    modal.style.display = 'none';
                }
            });
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const agendaRadio = document.getElementById('agenda-view');
        const escalaRadio = document.getElementById('scale-view');
        
        // Add an event listener for the "ESCALA" view
        escalaRadio.addEventListener('change', function() {
            if (escalaRadio.checked) {
                window.location.href = "{% url 'escala' %}";  // Redirect to escala view
            }
        });

        // Add an event listener for the "AGENDA" view, in case you need to toggle back
        agendaRadio.addEventListener('change', function() {
            if (agendaRadio.checked) {
                window.location.href = "{% url 'agenda' %}";  // Redirect to agenda view
            }
        });
    });
</script>
<script>
// Mini calendar: Implements functionality for the small calendar in the sidebar
document.addEventListener('DOMContentLoaded', function() {
    const miniPrevBtn = document.getElementById('mini-prev-btn');
    const miniNextBtn = document.getElementById('mini-next-btn');
    const miniCurrentMonth = document.getElementById('mini-current-month');
    const miniCalendarDates = document.getElementById('mini-calendar-dates');

    let miniCurrentYear = new Date().getFullYear();
    let miniCurrentMonthIndex = new Date().getMonth();

    const MONTH_NAMES_PT = {
        0: 'Janeiro', 1: 'Fevereiro', 2: 'Março', 3: 'Abril',
        4: 'Maio', 5: 'Junho', 6: 'Julho', 7: 'Agosto',
        8: 'Setembro', 9: 'Outubro', 10: 'Novembro', 11: 'Dezembro'
    };

    // Add event listeners to month view cells
    const monthViewCells = document.querySelectorAll('.calendar-grid.month-view .day');
    monthViewCells.forEach(cell => {
        cell.addEventListener('click', function() {
            const date = this.querySelector('span').textContent.trim().padStart(2, '0');
            const month = currentMonth.toString().padStart(2, '0');
            const year = currentYear;
            const formattedDate = `${date}/${month}/${year}`;
            openFormModal(formattedDate);
        });
    });

    // Add event listeners to week view cells
    const weekViewCells = document.querySelectorAll('.calendar-grid.week-view .hour-slot');
    weekViewCells.forEach(cell => {
        cell.addEventListener('click', function(e) {
            // Prevent opening the form if clicking on an existing procedure card
            if (!e.target.closest('.procedure-card')) {
                const dayColumn = this.closest('.day-column');
                const date = dayColumn.getAttribute('data-date');
                const hour = this.closest('.time-slot').textContent.trim().split(':')[0];
                const formattedDate = new Date(date).toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                const formattedTime = `${hour}:00`;
                openFormModal(formattedDate, formattedTime);
            }
        });
    });

    // Add event listeners to mini calendar dates
    function addMiniCalendarEventListeners() {
        const miniCalendarDates = document.querySelectorAll('.mini-calendar-date');
        miniCalendarDates.forEach(cell => {
            cell.addEventListener('click', function() {
                const date = this.textContent.trim().padStart(2, '0');
                const month = (miniCurrentMonthIndex + 1).toString().padStart(2, '0');
                const year = miniCurrentYear;
                const formattedDate = `${date}/${month}/${year}`;
                console.log(`Mini calendar date clicked: ${formattedDate}`); // Debugging line
                openFormModal(formattedDate);
            });
        });
    }

    // Call the function to add event listeners to mini calendar dates
    addMiniCalendarEventListeners();

    // Update mini calendar function to re-attach event listeners after updating the calendar
    function updateMiniCalendar() {
        const monthName = MONTH_NAMES_PT[miniCurrentMonthIndex];
        miniCurrentMonth.textContent = `${monthName} ${miniCurrentYear}`;

        const firstDayOfMonth = new Date(miniCurrentYear, miniCurrentMonthIndex, 1);
        const lastDayOfMonth = new Date(miniCurrentYear, miniCurrentMonthIndex + 1, 0);
        const firstDayWeekday = firstDayOfMonth.getDay();
        const lastDate = lastDayOfMonth.getDate();

        miniCalendarDates.innerHTML = '';

        // Fill in the days from the previous month
        for (let i = 0; i < firstDayWeekday; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.classList.add('mini-calendar-date', 'empty');
            miniCalendarDates.appendChild(emptyCell);
        }

        // Fill in the days of the current month
        for (let date = 1; date <= lastDate; date++) {
            const dateCell = document.createElement('div');
            dateCell.classList.add('mini-calendar-date');
            dateCell.textContent = date;
            miniCalendarDates.appendChild(dateCell);
        }

        // Re-attach event listeners to the new mini calendar dates
        addMiniCalendarEventListeners();
    }

    miniPrevBtn.addEventListener('click', function() {
        miniCurrentMonthIndex--;
        if (miniCurrentMonthIndex < 0) {
            miniCurrentMonthIndex = 11;
            miniCurrentYear--;
        }
        updateMiniCalendar();
    });

    miniNextBtn.addEventListener('click', function() {
        miniCurrentMonthIndex++;
        if (miniCurrentMonthIndex > 11) {
            miniCurrentMonthIndex = 0;
            miniCurrentYear++;
        }
        updateMiniCalendar();
    });

    updateMiniCalendar();
});
</script>

<script>
    $(document).ready(function(){
    $("input[name='data'], #search-date-input").inputmask("99/99/9999");  // dd/mm/yyyy
    $("input[name='time'], input[name='end_time']").inputmask("99:99");  // hh:mm
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const searchDateBtn = document.getElementById('search-date-btn');
    const searchPatientBtn = document.getElementById('search-patient-btn');
    const searchDateInput = document.getElementById('search-date-input');
    const searchPatientInput = document.getElementById('search-patient-input');

    function performDateSearch() {
        const query = searchDateInput.value.trim();
        if (!query) return;

        const dateParts = query.split('/');
        if (dateParts.length === 3) {
            const day = dateParts[0].padStart(2, '0');
            const month = dateParts[1].padStart(2, '0');
            const year = dateParts[2];
            const formattedDate = `${year}-${month}-${day}`;
            window.location.href = `/agenda/search?date=${formattedDate}`;
        } else {
            showCustomAlert('Formato de data inválido. Use DD/MM/YYYY.', 'error');
        }
    }

    function performPatientSearch() {
        const query = searchPatientInput.value.trim();
        if (!query) return;

        window.location.href = `/agenda/search?paciente=${encodeURIComponent(query)}`;
    }

    searchDateBtn.addEventListener('click', performDateSearch);
    searchPatientBtn.addEventListener('click', performPatientSearch);

    searchDateInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            performDateSearch();
        }
    });

    searchPatientInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            performPatientSearch();
        }
    });
});
</script>

<script>
// Date highlighting: Highlights the searched date in the calendar view
    const highlightDate = '{{ highlight_date|date:"Y-m-d" }}';
    
    document.addEventListener('DOMContentLoaded', function() {
        if (highlightDate) {
            // Highlight the day columns
            const dayElements = document.querySelectorAll(`.day[data-date="${highlightDate}"], .day-column[data-date="${highlightDate}"]`);
            dayElements.forEach(el => {
                el.classList.add('highlight');
            });
    
            // Highlight the procedure cards
            const procedureCards = document.querySelectorAll(`.procedure-card[data-date="${highlightDate}"]`);
            procedureCards.forEach(card => {
                card.classList.add('highlight');
            });
        }
    });
</script>

<script>
// Autocomplete: Implements autocomplete for patient search
document.addEventListener('DOMContentLoaded', function() {
    const searchPatientInput = document.getElementById('search-patient-input');

    let timeoutId;

    searchPatientInput.addEventListener('input', function() {
        clearTimeout(timeoutId);
        timeoutId = setTimeout(() => {
            const query = this.value.trim();
            if (query.length >= 2) {
                fetch(`/search-pacientes/?query=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(data => {
                        const existingResults = document.getElementById('autocomplete-results');
                        if (existingResults) {
                            existingResults.remove();
                        }

                        const resultsDiv = document.createElement('div');
                        resultsDiv.id = 'autocomplete-results';
                        resultsDiv.style.position = 'absolute';
                        resultsDiv.style.zIndex = '1000';
                        resultsDiv.style.backgroundColor = 'white';
                        resultsDiv.style.border = '1px solid #ddd';
                        resultsDiv.style.maxHeight = '200px';
                        resultsDiv.style.overflowY = 'auto';

                        data.forEach(paciente => {
                            const item = document.createElement('div');
                            item.textContent = paciente;
                            item.style.padding = '5px';
                            item.style.cursor = 'pointer';
                            item.addEventListener('click', function() {
                                searchPatientInput.value = this.textContent;
                                resultsDiv.remove();
                            });
                            resultsDiv.appendChild(item);
                        });

                        searchPatientInput.parentNode.appendChild(resultsDiv);
                    });
            }
        }, 300);  // Debounce for 300ms
    });

    document.addEventListener('click', function(e) {
        if (e.target !== searchPatientInput) {
            const results = document.getElementById('autocomplete-results');
            if (results) {
                results.remove();
            }
        }
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const cirurgiaoSelect = document.getElementById('id_cirurgiao');
    const cirurgiaoNomeInput = document.getElementById('id_cirurgiao_nome');

    // When one field is filled, clear the other
    cirurgiaoSelect.addEventListener('change', function() {
        if (this.value) {
            cirurgiaoNomeInput.value = '';
        }
    });

    cirurgiaoNomeInput.addEventListener('input', function() {
        if (this.value) {
            cirurgiaoSelect.value = '';
        }
    });

    const convenioSelect = $('#id_convenio');
    const convenioNomeNovoInput = document.getElementById('id_convenio_nome_novo');

    convenioSelect.on('change', function() {
        if ($(this).val()) {
            convenioNomeNovoInput.value = '';
        }
    });

    convenioNomeNovoInput.addEventListener('input', function() {
        if (this.value) {
            convenioSelect.val(null).trigger('change');
        }
    });
});
</script>
{% endblock %}
