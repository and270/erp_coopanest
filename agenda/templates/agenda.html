{% extends 'layout.html' %}
{% load static %}

{% block title %}Agenda{% endblock %}

{% block content %}
<!--
<div>
    <h3>Detailed Debug Info:</h3>
    <p>Number of procedimentos: {{ procedimentos|length }}</p>
    {% for proc in procedimentos %}
        <p>Procedimento: {{ proc.nome_paciente }} - {{ proc.data_horario|date:"Y-m-d H:i" }}</p>
        {% for date in week_dates %}
            <p>Comparing with: {{ date.full_date|date:"Y-m-d" }} - Date Match: {% if proc.data_horario|date:"Y-m-d" == date.full_date|date:"Y-m-d" %}Yes{% else %}No{% endif %}</p>
            {% if proc.data_horario|date:"Y-m-d" == date.full_date|date:"Y-m-d" %}
                {% for hour in hours %}
                    <p>Hour comparison: Procedure hour: {{ proc.data_horario|date:"H" }}, Comparing with: {{ hour }} - Hour Match: {% if proc.data_horario|date:"H" == hour %}Yes{% else %}No{% endif %}</p>
                {% endfor %}
            {% endif %}
        {% endfor %}
    {% endfor %}
    <p>Current week dates:</p>
    {% for date in week_dates %}
        <p>{{ date.full_date|date:"Y-m-d" }} ({{ date.day_name }})</p>
    {% endfor %}
    <p>Hours being checked:</p>
    <p>{{ hours|join:", " }}</p>
</div>
-->
<div class="agenda-container">
    <div class="agenda-header">
        <div class="left-controls">
            <button class="btn btn-primary" id="agendar-btn">+ AGENDAR</button>
            <div id="procedimento-form-modal" class="modal" style="display:none;">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <br>
                    <form method="POST" enctype="multipart/form-data">
                        {% csrf_token %}
                        {{ form.non_field_errors }}
                        <div class="form-group">
                            {{ form.procedimento_type.label_tag }} {{ form.procedimento_type }}
                        </div>
                        <div class="form-group">
                            {{ form.data.label_tag }} {{ form.data }}
                        </div>
                        <div class="form-group">
                            {{ form.time.label_tag }} {{ form.time }}
                        </div>
                        <div class="form-group">
                            {{ form.nome_paciente.label_tag }} {{ form.nome_paciente }}
                        </div>
                        <div class="form-group">
                            {{ form.contato_pacinete.label_tag }} {{ form.contato_pacinete }}
                        </div>
                        <div class="form-group">
                            {{ form.procedimento.label_tag }} {{ form.procedimento }}
                        </div>
                        <div class="form-group">
                            {{ form.hospital.label_tag }} {{ form.hospital }}
                        </div>
                        <div class="form-group">
                            {{ form.outro_local.label_tag }} {{ form.outro_local }}
                        </div>
                        <div class="form-group">
                            {{ form.cirurgiao.label_tag }} {{ form.cirurgiao }}
                        </div>
                        <div class="form-group">
                            {{ form.anestesista_responsavel.label_tag }} {{ form.anestesista_responsavel }}
                        </div>
                        <div class="form-group">
                            {{ form.link_nps.label_tag }} {{ form.link_nps }}
                        </div>
                        <div class="form-group-inline">
                            {{ form.visita_pre_anestesica.label_tag }} {{ form.visita_pre_anestesica }}
                        </div>
                        <div class="conditional-container" style="display:none;">
                            <div class="form-group">
                                {{ form.data_visita_pre_anestesica.label_tag }} {{ form.data_visita_pre_anestesica }}
                            </div>
                            <div class="form-group">
                                {{ form.foto_anexo.label_tag }} {{ form.foto_anexo }}
                            </div>
                            <div class="form-group">
                                {{ form.nome_responsavel_visita.label_tag }} {{ form.nome_responsavel_visita }}
                            </div>
                        </div>
                        <button type="submit" class="cadastrar-btn">Criar Agendamento</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="center-controls">
            <div class="view-switcher">
                <a href="#" id="prev-btn" class="btn btn-link">&lt;</a>
                <h2 id="current-date-range"></h2>
                <a href="#" id="next-btn" class="btn btn-link">&gt;</a>
            </div>
            <div class="view-type-switcher">
                <button id="semana-view" class="btn">SEMANA</button>
                <button id="mes-view" class="btn active">MÊS</button>
            </div>
        </div>

        <div class="right-controls">
            <div class="agenda-scale">
                <input type="checkbox" id="agenda-view" name="agenda-view">
                <label for="agenda-scale"><b>AGENDA</b></label>
                <input type="checkbox" id="scale-view" name="scale-view">
                <label for="scale-view"><b>ESCALA</b></label>
            </div>
        </div>
    </div>

    <div class="calendar-top-bar">
        
        <!-- buscar por data, paciente, procedimento
        <div class="calendar-search">
            <input type="radio" id="search-data" name="search-type" checked>
            <label for="search-data">DATA</label>
            <input type="radio" id="search-paciente" name="search-type">
            <label for="search-paciente">PACIENTE</label>
            <input type="radio" id="search-procedimento" name="search-type">
            <label for="search-procedimento">PROCEDIMENTO</label>
            <input type="text" placeholder="Buscar...">
        </div>
        -->
    </div>

    <div class="calendar-container">
        <div class="calendar-sidebar">
            <!-- Mini calendar implementation goes here
            <div class="mini-calendar">
                 
            </div>
            -->
            <ul class="event-types">
                <li><button class="btn-cirurgias">CIRURGIAS</button></li>
                <li><button class="btn-procedimentos">PROCEDIMENTOS FORA DO CENTRO CIRÚRGICO</button></li>
                <li><button class="btn-exames">EXAMES</button></li>
            </ul>
        </div>
        <div class="calendar-main">
            <div class="calendar-grid month-view">
                <div class="calendar-days">
                    <span>DOM</span>
                    <span>SEG</span>
                    <span>TER</span>
                    <span>QUA</span>
                    <span>QUI</span>
                    <span>SEX</span>
                    <span>SÁB</span>
                </div>
                {% for date in calendar_dates %}
                    <div class="day {% if not date.is_current_month %}other-month{% endif %}">
                        <span>{{ date.day.day }}</span>
                        {% for procedimento in procedimentos %}
                            {% if procedimento.data_horario.date == date.day.date %}
                                <div class="procedure-card" data-id="{{ procedimento.id }}">
                                    <span>{{ procedimento.nome_paciente }}</span>
                                    <span>{{ procedimento.procedimento }}</span>
                                </div>
                                <div id="procedure-details-modal" class="procedure-modal" style="display:none;">
                                    <div class="procedure-modal-content">
                                        <span class="close-modal">&times;</span>
                                        <p>Nome do Paciente: <span class="modal-patient-name">{{ procedimento.nome_paciente }}</span></p>
                                        <p>Contato do Paciente: <span class="modal-contact">{{ procedimento.contato_pacinete }}</span></p>
                                        <p>Procedimento: <span class="modal-procedure">{{ procedimento.procedimento }}</span></p>
                                        <p>Local: <span class="modal-hospital">{{ procedimento.hospital.name|default:procedimento.outro_local }}</span></p>
                                        <p>Data e Horário: <span class="modal-time">{{ procedimento.data_horario|date:"d/m/Y H:i" }}</span></p>
                                        <p>Cirurgião: <span class="modal-surgeon">{{ procedimento.cirurgiao.name }}</span></p>
                                        <p>Anestesista Responsável: <span class="modal-anesthesiologist">{{ procedimento.anestesista_responsavel.name }}</span></p>
                                        <p>Link NPS: <span class="modal-nps-link">{{ procedimento.link_nps|default:"Não disponível" }}</span></p>
                                        <p>Visita Pré-Anestésica: <span class="modal-pre-anesthetic-visit">{{ procedimento.visita_pre_anestesica|yesno:"Sim,Não" }}</span></p>
                                        <p>Data da Visita Pré-Anestésica: <span class="modal-pre-anesthetic-visit-date">{{ procedimento.data_visita_pre_anestesica|date:"d/m/Y"|default:"Não realizada" }}</span></p>
                                        <p>Nome do Responsável pela Visita: <span class="modal-visit-responsible">{{ procedimento.nome_responsavel_visita|default:"Não informado" }}</span></p>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <div class="calendar-grid week-view">
                <div class="calendar-days">
                    <span class="time-column"></span>
                    {% for date in week_dates %}
                        <span class="day-column">
                            {{ date.day_name }}<br>
                            ({{ date.date }})
                        </span>
                    {% endfor %}
                </div>
                <div class="time-slots">
                    {% for hour in hours %}
                        <div class="time-slot">{{ hour }}:00</div>
                    {% endfor %}
                </div>
                {% for date in week_dates %}
                    <div class="day-column">
                        {% for hour in hours %}
                            <div class="hour-slot">
                                {% for procedimento in procedimentos %}
                                    {% if procedimento.data_horario|date:"Y-m-d" == date.full_date|date:"Y-m-d" and procedimento.data_horario|date:"H" == hour %}
                                        <div class="procedure-card" data-id="{{ procedimento.id }}">
                                            <span>{{ procedimento.nome_paciente }}</span>
                                            <span>{{ procedimento.procedimento }}</span>
                                        </div>
                                        <div id="procedure-details-modal" class="procedure-modal" style="display:none;">
                                            <div class="procedure-modal-content">
                                                <span class="close-modal">&times;</span>
                                                <p>Nome do Paciente: <span class="modal-patient-name">{{ procedimento.nome_paciente }}</span></p>
                                                <p>Contato do Paciente: <span class="modal-contact">{{ procedimento.contato_pacinete }}</span></p>
                                                <p>Procedimento: <span class="modal-procedure">{{ procedimento.procedimento }}</span></p>
                                                <p>Local: <span class="modal-hospital">{{ procedimento.hospital.name|default:procedimento.outro_local }}</span></p>
                                                <p>Data e Horário: <span class="modal-time">{{ procedimento.data_horario|date:"d/m/Y H:i" }}</span></p>
                                                <p>Cirurgião: <span class="modal-surgeon">{{ procedimento.cirurgiao.name }}</span></p>
                                                <p>Anestesista Responsável: <span class="modal-anesthesiologist">{{ procedimento.anestesista_responsavel.name }}</span></p>
                                                <p>Link NPS: <span class="modal-nps-link">{{ procedimento.link_nps|default:"Não disponível" }}</span></p>
                                                <p>Visita Pré-Anestésica: <span class="modal-pre-anesthetic-visit">{{ procedimento.visita_pre_anestesica|yesno:"Sim,Não" }}</span></p>
                                                <p>Data da Visita Pré-Anestésica: <span class="modal-pre-anesthetic-visit-date">{{ procedimento.data_visita_pre_anestesica|date:"d/m/Y"|default:"Não realizada" }}</span></p>
                                                <p>Nome do Responsável pela Visita: <span class="modal-visit-responsible">{{ procedimento.nome_responsavel_visita|default:"Não informado" }}</span></p>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const semanaBtn = document.getElementById('semana-view');
    const mesBtn = document.getElementById('mes-view');
    const monthView = document.querySelector('.month-view');
    const weekView = document.querySelector('.week-view');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const currentDateRange = document.getElementById('current-date-range');

    let currentView = '{{ view_type }}';
    let currentYear = {{ current_year }};
    let currentMonth = {{ current_month }};
    let currentWeekStart = new Date('{{ current_week_start|date:"Y-m-d" }}');

    const MONTH_NAMES_PT = {
        1: 'Janeiro', 2: 'Fevereiro', 3: 'Março', 4: 'Abril',
        5: 'Maio', 6: 'Junho', 7: 'Julho', 8: 'Agosto',
        9: 'Setembro', 10: 'Outubro', 11: 'Novembro', 12: 'Dezembro'
    };

    function updateDateRange() {
        if (currentView === 'month') {
            currentDateRange.textContent = `${currentYear} - ${MONTH_NAMES_PT[currentMonth]}`;
        } else {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            const startDateFormatted = currentWeekStart.toLocaleDateString('pt-BR', { day: 'numeric', month: 'numeric' });
            const endDateFormatted = weekEnd.toLocaleDateString('pt-BR', { day: 'numeric', month: 'numeric' });

            currentDateRange.textContent = `${startDateFormatted} a ${endDateFormatted}`;
        }
    }

    function loadView(year, month, weekStart) {
        const url = new URL(window.location);
        url.searchParams.set('year', year);
        url.searchParams.set('month', month);
        if (weekStart) {
            url.searchParams.set('week_start', weekStart.toISOString().split('T')[0]);
        } else {
            url.searchParams.delete('week_start');
        }
        window.location.href = url.toString();
    }

    function updateViewDisplay() {
        if (currentView === 'week') {
            semanaBtn.classList.add('active');
            mesBtn.classList.remove('active');
            monthView.style.display = 'none';
            weekView.style.display = 'grid';
        } else {
            mesBtn.classList.add('active');
            semanaBtn.classList.remove('active');
            monthView.style.display = 'grid';
            weekView.style.display = 'none';
        }
    }

    updateViewDisplay();
    updateDateRange();

    function getFirstDayOfWeek(date) {
        const day = date.getDay();
        const diff = date.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
        return new Date(date.setDate(diff));
    }

    semanaBtn.addEventListener('click', function() {
        currentView = 'week';
        const firstDayOfMonth = new Date(currentYear, currentMonth - 1, 1);
        currentWeekStart = getFirstDayOfWeek(firstDayOfMonth);
        updateViewDisplay();
        updateDateRange();
        loadView(currentYear, currentMonth, currentWeekStart);
    });

    mesBtn.addEventListener('click', function() {
        currentView = 'month';
        updateViewDisplay();
        updateDateRange();
        loadView(currentYear, currentMonth, null);
    });

    prevBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (currentView === 'month') {
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
        } else {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        }
        updateDateRange();
        loadView(currentYear, currentMonth, currentView === 'week' ? currentWeekStart : null);
    });

    nextBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (currentView === 'month') {
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
        } else {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        }
        updateDateRange();
        loadView(currentYear, currentMonth, currentView === 'week' ? currentWeekStart : null);
    });
});
</script>

<script>
    document.getElementById('agendar-btn').addEventListener('click', function() {
        document.getElementById('procedimento-form-modal').style.display = 'block';
    }); 
    document.querySelector('.close').addEventListener('click', function() {
        document.getElementById('procedimento-form-modal').style.display = 'none';
    });
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.6/jquery.inputmask.min.js"></script>
<script>
    $(document).ready(function(){
        // Apply masks
        $("input[name='data']").inputmask("99/99/9999");  // dd/mm/yyyy
        $("input[name='time']").inputmask("99:99");  // hh:mm
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const visitaPreAnestesicaCheckbox = document.getElementById('id_visita_pre_anestesica');
        const conditionalContainer = document.querySelector('.conditional-container'); // Change this line

        function toggleConditionalFields() {
            if (visitaPreAnestesicaCheckbox.checked) {
                conditionalContainer.style.display = 'block';  // Show the container when checked
            } else {
                conditionalContainer.style.display = 'none';  // Hide the container when unchecked
            }
        }

        visitaPreAnestesicaCheckbox.addEventListener('change', toggleConditionalFields);
        toggleConditionalFields(); // Initial call to set the correct state on page load
    });

</script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const procedureCards = document.querySelectorAll('.procedure-card');
        procedureCards.forEach(card => {
            card.addEventListener('click', function() {
                const procedimentoId = this.getAttribute('data-id');
            });
        });

        // Close the modal
        document.querySelector('.close-modal').addEventListener('click', function() {
            document.getElementById('procedure-details-modal').style.display = 'none';
        });
    });
</script>

{% endblock %}
