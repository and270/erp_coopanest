{% extends 'layout.html' %}
{% load static %}

{% block title %}Agenda{% endblock %}

{% block content %}
<!--
<div>
    <h3>Detailed Debug Info:</h3>
    <p>Number of procedimentos: {{ procedimentos|length }}</p>
    {% for proc in procedimentos %}
        <p>Procedimento: {{ proc.nome_paciente }} - {{ proc.data_horario|date:"Y-m-d H:i" }}</p>
        {% for date in week_dates %}
            <p>Comparing with: {{ date.full_date|date:"Y-m-d" }} - Date Match: {% if proc.data_horario|date:"Y-m-d" == date.full_date|date:"Y-m-d" %}Yes{% else %}No{% endif %}</p>
            {% if proc.data_horario|date:"Y-m-d" == date.full_date|date:"Y-m-d" %}
                {% for hour in hours %}
                    <p>Hour comparison: Procedure hour: {{ proc.data_horario|date:"H" }}, Comparing with: {{ hour }} - Hour Match: {% if proc.data_horario|date:"H" == hour %}Yes{% else %}No{% endif %}</p>
                {% endfor %}
            {% endif %}
        {% endfor %}
    {% endfor %}
    <p>Current week dates:</p>
    {% for date in week_dates %}
        <p>{{ date.full_date|date:"Y-m-d" }} ({{ date.day_name }})</p>
    {% endfor %}
    <p>Hours being checked:</p>
    <p>{{ hours|join:", " }}</p>
</div>
-->
<div class="agenda-container">
    <div class="agenda-header">
        <div class="left-controls">
            <button class="btn btn-primary" id="agendar-btn">+ AGENDAR</button>
            <div id="procedimento-form-modal" class="modal" style="display:none;">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <br>
                    <form method="POST" enctype="multipart/form-data" id="procedimento-form">
                        {% csrf_token %}
                        <input type="hidden" name="procedure_id" id="procedure_id">
                        {{ form.non_field_errors }}
                        <div class="form-group">
                            {{ form.procedimento_type.label_tag }} {{ form.procedimento_type }}
                        </div>
                        <div class="form-group">
                            {{ form.data.label_tag }} {{ form.data }}
                        </div>
                        <div class="form-group">
                            {{ form.time.label_tag }} {{ form.time }}
                        </div>
                        <div class="form-group">
                            {{ form.end_time.label_tag }} {{ form.end_time }}
                        </div>
                        <div class="form-group">
                            {{ form.nome_paciente.label_tag }} {{ form.nome_paciente }}
                        </div>
                        <div class="form-group">
                            {{ form.email_paciente.label_tag }} {{ form.email_paciente }}
                        </div>
                        <div class="form-group">
                            {{ form.procedimento.label_tag }} {{ form.procedimento }}
                        </div>
                        <div class="form-group">
                            {{ form.hospital.label_tag }} {{ form.hospital }}
                        </div>
                        <div class="form-group">
                            {{ form.outro_local.label_tag }} {{ form.outro_local }}
                        </div>
                        <div class="form-group">
                            {{ form.cirurgiao.label_tag }} {{ form.cirurgiao }}
                        </div>
                        <div class="form-group">
                            {{ form.anestesista_responsavel.label_tag }} {{ form.anestesista_responsavel }}
                        </div>
                        <div class="form-group">
                            {{ form.link_nps.label_tag }} {{ form.link_nps }}
                        </div>
                        <div class="form-group-inline">
                            {{ form.visita_pre_anestesica.label_tag }} {{ form.visita_pre_anestesica }}
                        </div>
                        <div class="conditional-container" style="display:none;">
                            <div class="form-group">
                                {{ form.data_visita_pre_anestesica.label_tag }} {{ form.data_visita_pre_anestesica }}
                            </div>
                            <div class="form-group">
                                {{ form.foto_anexo.label_tag }} {{ form.foto_anexo }}
                            </div>
                            <div class="form-group">
                                {{ form.nome_responsavel_visita.label_tag }} {{ form.nome_responsavel_visita }}
                            </div>
                        </div>
                        <button type="submit" class="cadastrar-btn" id="form-submit-btn">Criar Agendamento</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="center-controls">
            <div class="view-switcher">
                <a href="#" id="prev-btn" class="btn btn-link">&lt;</a>
                <h2 id="current-date-range"></h2>
                <a href="#" id="next-btn" class="btn btn-link">&gt;</a>
            </div>
            <div class="view-type-switcher">
                <button id="semana-view" class="btn">SEMANA</button>
                <button id="mes-view" class="btn active">MÊS</button>
            </div>
            <div class="search-bar">
                <div class="radio-group">
                    <i class="fa fa-search search-icon"></i>
                    <input type="radio" id="search-data" name="search-type">
                    <label for="search-data">DATA</label>
                    <input type="radio" id="search-paciente" name="search-type">
                    <label for="search-paciente">PACIENTE</label>
                </div>
                <div class="input-container">
                    <input type="text" id="search-input" placeholder="Buscar...">
                    <button id="search-btn"><i class="fa fa-search"></i></button>
                </div>
            </div>
        </div>

        <div class="right-controls">
            <div class="agenda-scale">
                <input type="radio" id="agenda-view" name="view-toggle" checked>
                <label for="agenda-view"><b>AGENDA</b></label>
                <input type="radio" id="scale-view" name="view-toggle">
                <label for="scale-view"><b>ESCALA</b></label>
            </div>
        </div>
    </div>

    <div class="calendar-top-bar">
        
        <!-- buscar por data, paciente, procedimento
        <div class="calendar-search">
            <input type="radio" id="search-data" name="search-type" checked>
            <label for="search-data">DATA</label>
            <input type="radio" id="search-paciente" name="search-type">
            <label for="search-paciente">PACIENTE</label>
            <input type="radio" id="search-procedimento" name="search-type">
            <label for="search-procedimento">PROCEDIMENTO</label>
            <input type="text" placeholder="Buscar...">
        </div>
        -->
    </div>

    <div class="calendar-container">
        <div class="calendar-sidebar">
            <div class="mini-calendar">
                <div class="mini-calendar-header">
                    <span id="mini-current-month"></span>
                    <button id="mini-prev-btn" class="btn-link">&lt;</button>
                    <button id="mini-next-btn" class="btn-link">&gt;</button>
                </div>
                <div class="mini-calendar-weekdays">
                    <span>D</span><span>S</span><span>T</span><span>Q</span><span>Q</span><span>S</span><span>S</span>
                </div>
                <div class="mini-calendar-dates" id="mini-calendar-dates">
                    <!-- Dates will be populated here by JavaScript -->
                </div>
            </div>
            <ul class="event-types">
                <li><button class="btn-cirurgias">CIRURGIAS</button></li>
                <li><button class="btn-procedimentos">PROCEDIMENTOS FORA DO CENTRO CIRÚRGICO</button></li>
                <li><button class="btn-exames">EXAMES</button></li>
            </ul>
        </div>
        <div class="calendar-main">
            <div class="calendar-grid month-view">
                <div class="calendar-days">
                    <span>DOM</span>
                    <span>SEG</span>
                    <span>TER</span>
                    <span>QUA</span>
                    <span>QUI</span>
                    <span>SEX</span>
                    <span>SÁB</span>
                </div>
                {% for date in calendar_dates %}
                    <div class="day {% if not date.is_current_month %}other-month{% endif %}" data-date="{{ date.day|date:'Y-m-d' }}">
                        <span>{{ date.day.day }}</span>
                        {% for procedimento in procedimentos %}
                            {% if procedimento.data_horario.date == date.day.date %}
                                <div class="procedure-card {% if procedimento.procedimento_type == 'cirurgia_procedimento' %}cirurgia{% elif procedimento.procedimento_type == 'fora_centro_procedimento' %}fora-centro{% elif procedimento.procedimento_type == 'exame_procedimento' %}exame{% endif %}" data-id="{{ procedimento.id }}" data-date="{{ procedimento.data_horario|date:'Y-m-d' }}">
                                    <span class="procedure-patient">{{ procedimento.nome_paciente }}</span>
                                    <span class="procedure-time">{{ procedimento.data_horario|date:"H:i" }}</span>
                                    <span class="procedure-name">{{ procedimento.procedimento }}</span>
                                    <span class="procedure-anesthesiologist">{{ procedimento.anestesista_responsavel.name }}</span>
                                </div>
                                <div id="procedure-details-modal-{{ procedimento.id }}" class="procedure-modal" style="display:none;">
                                    <div class="procedure-modal-content">
                                        <span class="close-modal">&times;</span>
                                        <p><strong>Paciente:</strong> <span class="modal-patient-name">{{ procedimento.nome_paciente }}</span></p>
                                        <p><strong>Email:</strong> <span class="modal-email">{{ procedimento.email_paciente|default:"Não informado" }}</span></p>
                                        <p><strong>Procedimento:</strong> <span class="modal-procedure">{{ procedimento.procedimento }}</span></p>
                                        <p><strong>Local:</strong> <span class="modal-hospital">{{ procedimento.hospital.name|default:procedimento.outro_local }}</span></p>
                                        <p><strong>Data:</strong> <span class="modal-date">{{ procedimento.data_horario|date:"d/m/Y" }}</span></p>
                                        <p><strong>Hora de Ínicio:</strong> <span class="modal-start-time">{{ procedimento.data_horario|date:"H:i" }}</span></p>
                                        <p><strong>Previsão de Término:</strong> <span class="modal-end-time">{{ procedimento.data_horario_fim|date:"H:i" }}</span></p>
                                        <p><strong>Cirurgião:</strong> <span class="modal-surgeon">{{ procedimento.cirurgiao.name }}</span></p>
                                        <p><strong>Anestesista:</strong> <span class="modal-anesthesiologist">{{ procedimento.anestesista_responsavel.name }}</span></p>
                                        <p><strong>Link NPS:</strong> <span class="modal-nps-link">{{ procedimento.link_nps|default:"Não disponível" }}</span></p>
                                        <p><strong>Visita Pré-Anestésica:</strong> <span class="modal-pre-anesthetic-visit">{{ procedimento.visita_pre_anestesica|yesno:"Sim,Não" }}</span></p>
                                        <p><strong>Data da Visita Pré-Anestésica:</strong> <span class="modal-pre-anesthetic-visit-date">{{ procedimento.data_visita_pre_anestesica|date:"d/m/Y"|default:"Não realizada" }}</span></p>
                                        <p><strong>Responsável pela Visita:</strong> <span class="modal-visit-responsible">{{ procedimento.nome_responsavel_visita|default:"Não informado" }}</span></p>
                                        <p><strong>Anexo Visita Pré-Anestésica:</strong> 
                                            {% if procedimento.foto_anexo %}
                                                <a href="{% url 'protected_file' procedimento.foto_anexo.name %}" target="_blank" class="modal-attachment">Ver anexo</a>
                                            {% else %}
                                                <span class="modal-attachment">Nenhum anexo disponível</span>
                                            {% endif %}
                                        </p>
                                        <div class="modal-actions">
                                            <button class="btn btn-primary edit-procedure">Editar</button>
                                            <button class="btn btn-danger delete-procedure">Cancelar</button>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
            <div class="calendar-grid week-view">
                <div class="calendar-days">
                    <span class="time-column"></span>
                    {% for date in week_dates %}
                        <span class="day-column" data-date="{{ date.full_date|date:'Y-m-d' }}">
                            {{ date.day_name }}<br>
                            ({{ date.date }})
                        </span>
                    {% endfor %}
                </div>
                <div class="time-slots">
                    {% for hour in hours %}
                        <div class="time-slot">{{ hour }}:00</div>
                    {% endfor %}
                </div>
                {% for date in week_dates %}
                    <div class="day-column" data-date="{{ date.full_date|date:'Y-m-d' }}">
                        {% for hour in hours %}
                            <div class="hour-slot">
                                {% for procedimento in procedimentos %}
                                    {% if procedimento.data_horario|date:"Y-m-d" == date.full_date|date:"Y-m-d" and procedimento.data_horario|date:"H" <= hour and procedimento.data_horario_fim|date:"H" > hour %}
                                        <div class="procedure-card week-view-card {% if procedimento.procedimento_type == 'cirurgia_procedimento' %}cirurgia{% elif procedimento.procedimento_type == 'fora_centro_procedimento' %}fora-centro{% elif procedimento.procedimento_type == 'exame_procedimento' %}exame{% endif %}" data-id="{{ procedimento.id }}" data-date="{{ procedimento.data_horario|date:'Y-m-d' }}">
                                            <span class="procedure-patient">{{ procedimento.nome_paciente }}</span>
                                            <span class="procedure-time">{{ procedimento.data_horario|date:"H:i" }}</span>
                                            <span class="procedure-name">{{ procedimento.procedimento }}</span>
                                            <span class="procedure-anesthesiologist">{{ procedimento.anestesista_responsavel.name }}</span>
                                        </div>
                                        <div id="procedure-details-modal-{{ procedimento.id }}" class="procedure-modal" style="display:none;">
                                            <div class="procedure-modal-content">
                                                <span class="close-modal">&times;</span>
                                                <p><strong>Paciente:</strong> <span class="modal-patient-name">{{ procedimento.nome_paciente }}</span></p>
                                                <p><strong>Email:</strong> <span class="modal-email">{{ procedimento.email_paciente|default:"Não informado" }}</span></p>
                                                <p><strong>Procedimento:</strong> <span class="modal-procedure">{{ procedimento.procedimento }}</span></p>
                                                <p><strong>Local:</strong> <span class="modal-hospital">{{ procedimento.hospital.name|default:procedimento.outro_local }}</span></p>
                                                <p><strong>Data:</strong> <span class="modal-date">{{ procedimento.data_horario|date:"d/m/Y" }}</span></p>
                                                <p><strong>Hora de Ínicio:</strong> <span class="modal-start-time">{{ procedimento.data_horario|date:"H:i" }}</span></p>
                                                <p><strong>Previsão de Término:</strong> <span class="modal-end-time">{{ procedimento.data_horario_fim|date:"H:i" }}</span></p>
                                                <p><strong>Cirurgião:</strong> <span class="modal-surgeon">{{ procedimento.cirurgiao.name }}</span></p>
                                                <p><strong>Anestesista:</strong> <span class="modal-anesthesiologist">{{ procedimento.anestesista_responsavel.name }}</span></p>
                                                <p><strong>Link NPS:</strong> <span class="modal-nps-link">{{ procedimento.link_nps|default:"Não disponível" }}</span></p>
                                                <p><strong>Visita Pré-Anestésica:</strong> <span class="modal-pre-anesthetic-visit">{{ procedimento.visita_pre_anestesica|yesno:"Sim,Não" }}</span></p>
                                                <p><strong>Data da Visita Pré-Anestésica:</strong> <span class="modal-pre-anesthetic-visit-date">{{ procedimento.data_visita_pre_anestesica|date:"d/m/Y"|default:"Não realizada" }}</span></p>
                                                <p><strong>Responsável pela Visita:</strong> <span class="modal-visit-responsible">{{ procedimento.nome_responsavel_visita|default:"Não informado" }}</span></p>
                                                <p><strong>Anexo Visita Pré-Anestésica:</strong> 
                                                    {% if procedimento.foto_anexo %}
                                                        <a href="{% url 'protected_file' procedimento.foto_anexo.name %}" target="_blank" class="modal-attachment">Ver anexo</a>
                                                    {% else %}
                                                        <span class="modal-attachment">Nenhum anexo disponível</span>
                                                    {% endif %}
                                                </p>
                                                <div class="modal-actions">
                                                    <button class="btn btn-primary edit-procedure">Editar</button>
                                                    <button class="btn btn-danger delete-procedure">Cancelar</button>
                                                </div>
                                            </div>
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.inputmask/5.0.6/jquery.inputmask.min.js"></script>

<script>
// Main calendar functionality: Handles view switching, navigation, and date range display
document.addEventListener('DOMContentLoaded', function() {
    const semanaBtn = document.getElementById('semana-view');
    const mesBtn = document.getElementById('mes-view');
    const monthView = document.querySelector('.month-view');
    const weekView = document.querySelector('.week-view');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    const currentDateRange = document.getElementById('current-date-range');

    let currentView = '{{ view_type }}';
    let currentYear = {{ current_year }};
    let currentMonth = {{ current_month }};
    let currentWeekStart = new Date('{{ current_week_start|date:"Y-m-d" }}');

    const MONTH_NAMES_PT = {
        1: 'Janeiro', 2: 'Fevereiro', 3: 'Março', 4: 'Abril',
        5: 'Maio', 6: 'Junho', 7: 'Julho', 8: 'Agosto',
        9: 'Setembro', 10: 'Outubro', 11: 'Novembro', 12: 'Dezembro'
    };

    function updateDateRange() {
        if (currentView === 'month') {
            currentDateRange.textContent = `${currentYear} ${MONTH_NAMES_PT[currentMonth]}`;
        } else {
            const weekEnd = new Date(currentWeekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            const startDateFormatted = currentWeekStart.toLocaleDateString('pt-BR', { day: 'numeric', month: 'numeric' });
            const endDateFormatted = weekEnd.toLocaleDateString('pt-BR', { day: 'numeric', month: 'numeric' });

            currentDateRange.textContent = `${startDateFormatted} a ${endDateFormatted}`;
        }
    }

    function loadView(year, month, weekStart) {
    const base_url = '{% url 'agenda' %}';
    const url = new URL(window.location.origin + base_url);
    url.searchParams.set('year', year);
    url.searchParams.set('month', month);
    if (weekStart) {
        url.searchParams.set('week_start', weekStart.toISOString().split('T')[0]);
    } else {
        url.searchParams.delete('week_start');
    }
    window.location.href = url.toString();
}

    function updateViewDisplay() {
        if (currentView === 'week') {
            semanaBtn.classList.add('active');
            mesBtn.classList.remove('active');
            monthView.style.display = 'none';
            weekView.style.display = 'grid';
        } else {
            mesBtn.classList.add('active');
            semanaBtn.classList.remove('active');
            monthView.style.display = 'grid';
            weekView.style.display = 'none';
        }
    }

    updateViewDisplay();
    updateDateRange();

    function getFirstDayOfWeek(date) {
        const day = date.getDay();
        const diff = date.getDate() - day + (day === 0 ? -6 : 1); // adjust when day is sunday
        return new Date(date.setDate(diff));
    }

    semanaBtn.addEventListener('click', function() {
        currentView = 'week';
        const firstDayOfMonth = new Date(currentYear, currentMonth - 1, 1);
        currentWeekStart = getFirstDayOfWeek(firstDayOfMonth);
        updateViewDisplay();
        updateDateRange();
        loadView(currentYear, currentMonth, currentWeekStart);
    });

    mesBtn.addEventListener('click', function() {
        currentView = 'month';
        updateViewDisplay();
        updateDateRange();
        loadView(currentYear, currentMonth, null);
    });

    prevBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (currentView === 'month') {
            currentMonth--;
            if (currentMonth < 1) {
                currentMonth = 12;
                currentYear--;
            }
        } else {
            currentWeekStart.setDate(currentWeekStart.getDate() - 7);
        }
        updateDateRange();
        loadView(currentYear, currentMonth, currentView === 'week' ? currentWeekStart : null);
    });

    nextBtn.addEventListener('click', function(e) {
        e.preventDefault();
        if (currentView === 'month') {
            currentMonth++;
            if (currentMonth > 12) {
                currentMonth = 1;
                currentYear++;
            }
        } else {
            currentWeekStart.setDate(currentWeekStart.getDate() + 7);
        }
        updateDateRange();
        loadView(currentYear, currentMonth, currentView === 'week' ? currentWeekStart : null);
    });

    // Function to open the form modal with pre-filled data
    function openFormModal(date, time) {
        const formModal = document.getElementById('procedimento-form-modal');
        const dateField = document.getElementById('id_data');
        const timeField = document.getElementById('id_time');
        
        // Pre-fill the date and time fields
        $(dateField).inputmask("setvalue", date);
        if (time) {
            $(timeField).inputmask("setvalue", time);
        } else {
            $(timeField).inputmask("setvalue", "");
        }

        // Show the form modal
        formModal.style.display = 'block';
    }

    // Add event listeners to month view cells
    const monthViewCells = document.querySelectorAll('.calendar-grid.month-view .day');
    monthViewCells.forEach(cell => {
        cell.addEventListener('click', function() {
            const date = this.querySelector('span').textContent.trim().padStart(2, '0');
            const month = currentMonth.toString().padStart(2, '0');
            const year = currentYear;
            const formattedDate = `${date}/${month}/${year}`;
            openFormModal(formattedDate);
        });
    });

    const procedureCards = document.querySelectorAll('.calendar-grid .procedure-card');
    const procedureFormModal = document.getElementById('procedimento-form-modal');
    const formSubmitBtn = document.getElementById('form-submit-btn');
    const procedimentoForm = document.getElementById('procedimento-form');

    // Add event listeners to week view cells
    const weekViewCells = document.querySelectorAll('.calendar-grid.week-view .hour-slot');
    weekViewCells.forEach(cell => {
        cell.addEventListener('click', function(e) {
            // Prevent opening the form if clicking on an existing procedure card
            if (!e.target.closest('.procedure-card')) {
                procedureFormModal.style.display = 'block';
                procedimentoForm.reset();
                document.getElementById('procedure_id').value = '';
                formSubmitBtn.textContent = 'Criar Agendamento';
            }
        });
    });
});
</script>

<script>
// Modal display: Shows/hides the procedure form modal
    document.getElementById('agendar-btn').addEventListener('click', function() {
        document.getElementById('procedimento-form-modal').style.display = 'block';
    }); 
    document.querySelector('.close').addEventListener('click', function() {
        document.getElementById('procedimento-form-modal').style.display = 'none';
    });
</script>
<script>
// Input masking: Applies date and time masks to form inputs
    $(document).ready(function(){
        // Apply masks
        $("input[name='data']").inputmask("99/99/9999");  // dd/mm/yyyy
        $("input[name='time'], input[name='end_time']").inputmask("99:99");  // hh:mm
    });
</script>
<script>
// Conditional fields: Toggles visibility of pre-anesthetic visit fields based on checkbox
    document.addEventListener('DOMContentLoaded', function() {
        const visitaPreAnestesicaCheckbox = document.getElementById('id_visita_pre_anestesica');
        const conditionalContainer = document.querySelector('.conditional-container'); // Change this line

        function toggleConditionalFields() {
            if (visitaPreAnestesicaCheckbox.checked) {
                conditionalContainer.style.display = 'block';  // Show the container when checked
            } else {
                conditionalContainer.style.display = 'none';  // Hide the container when unchecked
            }
        }

        visitaPreAnestesicaCheckbox.addEventListener('change', toggleConditionalFields);
        toggleConditionalFields(); // Initial call to set the correct state on page load
    });

</script>

<script>
// CRUD operations: Handles creating, reading, updating, and deleting procedures
document.addEventListener('DOMContentLoaded', function() {
    const procedureCards = document.querySelectorAll('.calendar-grid .procedure-card');
    const procedureFormModal = document.getElementById('procedimento-form-modal');
    const formSubmitBtn = document.getElementById('form-submit-btn');
    const procedimentoForm = document.getElementById('procedimento-form');
    
    procedimentoForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const formData = new FormData(this);
        const procedureId = document.getElementById('procedure_id').value;
        
         // Reset previous error messages
        document.querySelectorAll('.error-message').forEach(el => el.remove());
        document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));

        fetch(procedureId ? `/update-procedure/${procedureId}/` : '/create-procedure/', {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();  // Reload the page to show the updated data
            } else {
                const errors = JSON.parse(data.errors);
                Object.keys(errors).forEach(fieldName => {
                    const field = document.getElementById(`id_${fieldName}`);
                    if (field) {
                        field.classList.add('is-invalid');
                        const errorMessage = document.createElement('div');
                        errorMessage.className = 'invalid-feedback error-message';
                        errorMessage.textContent = errors[fieldName][0].message;
                        field.parentNode.appendChild(errorMessage);
                    }
                });
                alert('Erro ao salvar o procedimento. Verifique os campos e tente novamente.');
            }
        });
    });
    
    procedureCards.forEach(card => {
        card.addEventListener('click', function(e) {
            e.stopPropagation();
            const procedureId = this.getAttribute('data-id');
            const modal = document.getElementById(`procedure-details-modal-${procedureId}`);
            
            if (modal) {
                // Get the position of the clicked card
                const rect = this.getBoundingClientRect();
                
                // Show the modal to get its dimensions
                modal.style.display = 'block';
                const modalRect = modal.getBoundingClientRect();
                
                // Calculate available space
                const spaceRight = window.innerWidth - rect.right;
                const spaceBottom = window.innerHeight - rect.bottom;
                
                // Determine horizontal position
                if (spaceRight >= modalRect.width) {
                    // Enough space on the right
                    modal.style.left = rect.left + 'px';
                    modal.style.right = 'auto';
                } else if (rect.left >= modalRect.width) {
                    // Not enough space on the right, but enough on the left
                    modal.style.left = (rect.right - modalRect.width) + 'px';
                    modal.style.right = 'auto';
                } else {
                    // Not enough space on either side, center it
                    modal.style.left = Math.max(0, (window.innerWidth - modalRect.width) / 2) + 'px';
                    modal.style.right = 'auto';
                }
                
                // Determine vertical position
                if (spaceBottom >= modalRect.height) {
                    // Enough space below
                    modal.style.top = (rect.bottom + window.scrollY) + 'px';
                } else if (rect.top >= modalRect.height) {
                    // Not enough space below, but enough above
                    modal.style.top = (rect.top + window.scrollY - modalRect.height) + 'px';
                } else {
                    // Not enough space above or below, position at top of viewport
                    modal.style.top = window.scrollY + 'px';
                }
                
                // Ensure the modal doesn't exceed viewport boundaries
                const updatedModalRect = modal.getBoundingClientRect();
                if (updatedModalRect.right > window.innerWidth) {
                    modal.style.left = (window.innerWidth - modalRect.width) + 'px';
                }
                if (updatedModalRect.bottom > window.innerHeight + window.scrollY) {
                    modal.style.top = (window.innerHeight + window.scrollY - modalRect.height) + 'px';
                }
                
                // Set the procedure ID as a data attribute on the modal
                modal.setAttribute('data-procedure-id', procedureId);
            }
        });
    });
    
    // Edit button click handler
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('edit-procedure')) {
            const modal = e.target.closest('.procedure-modal');
            const procedureId = modal.getAttribute('data-procedure-id');
            
            // Hide the details modal
            modal.style.display = 'none';
            
            // Load the procedure data into the form
            loadProcedureDataIntoForm(procedureId);
        }
    });
    
    // Delete button click handler
    document.addEventListener('click', function(e) {
        if (e.target && e.target.classList.contains('delete-procedure')) {
            const modal = e.target.closest('.procedure-modal');
            const procedureId = modal.getAttribute('data-procedure-id');
            
            if (confirm('Tem certeza que deseja cancelar este procedimento?')) {
                deleteProcedure(procedureId);
            }
        }
    });
    
    // Function to load procedure data into the form
    function loadProcedureDataIntoForm(procedureId) {
        fetch(`/get-procedure/${procedureId}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('procedure_id').value = procedureId;
                document.getElementById('id_procedimento_type').value = data.procedimento_type;
                document.getElementById('id_data').value = data.data;
                
                // Directly use the time strings from the server
                document.getElementById('id_time').value = data.time;
                document.getElementById('id_end_time').value = data.end_time;
                
                document.getElementById('id_nome_paciente').value = data.nome_paciente;
                document.getElementById('id_email_paciente').value = data.email_paciente;
                document.getElementById('id_procedimento').value = data.procedimento;
                document.getElementById('id_hospital').value = data.hospital;
                document.getElementById('id_outro_local').value = data.outro_local;
                document.getElementById('id_cirurgiao').value = data.cirurgiao;
                document.getElementById('id_anestesista_responsavel').value = data.anestesista_responsavel;
                document.getElementById('id_link_nps').value = data.link_nps;
                document.getElementById('id_visita_pre_anestesica').checked = data.visita_pre_anestesica;
                document.getElementById('id_data_visita_pre_anestesica').value = data.data_visita_pre_anestesica;
                document.getElementById('id_nome_responsavel_visita').value = data.nome_responsavel_visita;
                
                procedureFormModal.style.display = 'block';
                formSubmitBtn.textContent = 'Editar Agendamento';
            });
    }
    
    // Function to delete a procedure
    function deleteProcedure(procedureId) {
        fetch(`/delete-procedure/${procedureId}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Failed to delete the procedure. Please try again.');
            }
        });
    }
    
    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Reset form when opening for a new procedure
    document.getElementById('agendar-btn').addEventListener('click', function() {
        document.querySelector('#procedimento-form-modal form').reset();
        document.getElementById('procedure_id').value = '';
        formSubmitBtn.textContent = 'Criar Agendamento';
        procedureFormModal.style.display = 'block';
    });
});
</script>

<script>
// Modal closing: Adds functionality to close procedure detail modals
    document.addEventListener('DOMContentLoaded', function() {
        const procedureModals = document.querySelectorAll('.procedure-modal');
        const procedureFormModal = document.getElementById('procedimento-form-modal');
        
        // Close modal when clicking the "X"
        procedureModals.forEach(modal => {
            modal.querySelector('.close-modal').addEventListener('click', function(e) {
                e.stopPropagation(); // Prevent further event propagation
                modal.style.display = 'none';
            });
        });

        // Close modal when clicking outside of it
        window.addEventListener('click', function(e) {
            procedureModals.forEach(modal => {
                if (e.target == modal) {
                    modal.style.display = 'none';
                }
            });
        });
    });
</script>

<script>
// View switching: Handles switching between agenda and scale views
    document.addEventListener('DOMContentLoaded', function() {
        const agendaRadio = document.getElementById('agenda-view');
        const escalaRadio = document.getElementById('scale-view');
        
        // Add an event listener for the "ESCALA" view
        escalaRadio.addEventListener('change', function() {
            if (escalaRadio.checked) {
                window.location.href = "{% url 'escala' %}";  // Redirect to escala view
            }
        });

        // Add an event listener for the "AGENDA" view, in case you need to toggle back
        agendaRadio.addEventListener('change', function() {
            if (agendaRadio.checked) {
                window.location.href = "{% url 'agenda' %}";  // Redirect to agenda view
            }
        });
    });
</script>
<script>
// Mini calendar: Implements functionality for the small calendar in the sidebar
document.addEventListener('DOMContentLoaded', function() {
    const miniPrevBtn = document.getElementById('mini-prev-btn');
    const miniNextBtn = document.getElementById('mini-next-btn');
    const miniCurrentMonth = document.getElementById('mini-current-month');
    const miniCalendarDates = document.getElementById('mini-calendar-dates');

    let miniCurrentYear = new Date().getFullYear();
    let miniCurrentMonthIndex = new Date().getMonth();

    const MONTH_NAMES_PT = {
        0: 'Janeiro', 1: 'Fevereiro', 2: 'Março', 3: 'Abril',
        4: 'Maio', 5: 'Junho', 6: 'Julho', 7: 'Agosto',
        8: 'Setembro', 9: 'Outubro', 10: 'Novembro', 11: 'Dezembro'
    };

    function updateMiniCalendar() {
        const monthName = MONTH_NAMES_PT[miniCurrentMonthIndex];
        miniCurrentMonth.textContent = `${monthName} ${miniCurrentYear}`;

        const firstDayOfMonth = new Date(miniCurrentYear, miniCurrentMonthIndex, 1);
        const lastDayOfMonth = new Date(miniCurrentYear, miniCurrentMonthIndex + 1, 0);
        const firstDayWeekday = firstDayOfMonth.getDay();
        const lastDate = lastDayOfMonth.getDate();

        miniCalendarDates.innerHTML = '';

        // Fill in the days from the previous month
        for (let i = 0; i < firstDayWeekday; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.classList.add('mini-calendar-date', 'empty');
            miniCalendarDates.appendChild(emptyCell);
        }

        // Fill in the days of the current month
        for (let date = 1; date <= lastDate; date++) {
            const dateCell = document.createElement('div');
            dateCell.classList.add('mini-calendar-date');
            dateCell.textContent = date;
            miniCalendarDates.appendChild(dateCell);
        }
    }

    miniPrevBtn.addEventListener('click', function() {
        miniCurrentMonthIndex--;
        if (miniCurrentMonthIndex < 0) {
            miniCurrentMonthIndex = 11;
            miniCurrentYear--;
        }
        updateMiniCalendar();
    });

    miniNextBtn.addEventListener('click', function() {
        miniCurrentMonthIndex++;
        if (miniCurrentMonthIndex > 11) {
            miniCurrentMonthIndex = 0;
            miniCurrentYear++;
        }
        updateMiniCalendar();
    });

    // Function to open the form modal with pre-filled data
    function openFormModal(date, time) {
        const formModal = document.getElementById('procedimento-form-modal');
        const dateField = document.getElementById('id_data');
        const timeField = document.getElementById('id_time');
        
        // Pre-fill the date and time fields
        $(dateField).inputmask("setvalue", date);
        if (time) {
            $(timeField).inputmask("setvalue", time);
        } else {
            $(timeField).inputmask("setvalue", "");
        }

        // Show the form modal
        formModal.style.display = 'block';
    }

    // Add event listeners to month view cells
    const monthViewCells = document.querySelectorAll('.calendar-grid.month-view .day');
    monthViewCells.forEach(cell => {
        cell.addEventListener('click', function() {
            if (e.target.closest('.procedure-modal')) {
                return;
            }
            const date = this.querySelector('span').textContent.trim().padStart(2, '0');
            const month = currentMonth.toString().padStart(2, '0');
            const year = currentYear;
            const formattedDate = `${date}/${month}/${year}`;
            openFormModal(formattedDate);
        });
    });

    // Add event listeners to mini calendar dates
    function addMiniCalendarEventListeners() {
        const miniCalendarDates = document.querySelectorAll('.mini-calendar-date');
        miniCalendarDates.forEach(cell => {
            cell.addEventListener('click', function() {
                const date = this.textContent.trim().padStart(2, '0');
                const month = (miniCurrentMonthIndex + 1).toString().padStart(2, '0');
                const year = miniCurrentYear;
                const formattedDate = `${date}/${month}/${year}`;
                console.log(`Mini calendar date clicked: ${formattedDate}`); // Debugging line
                openFormModal(formattedDate);
            });
        });
    }

    // Call the function to add event listeners to mini calendar dates
    addMiniCalendarEventListeners();

    // Update mini calendar function to re-attach event listeners after updating the calendar
    function updateMiniCalendar() {
        const monthName = MONTH_NAMES_PT[miniCurrentMonthIndex];
        miniCurrentMonth.textContent = `${monthName} ${miniCurrentYear}`;

        const firstDayOfMonth = new Date(miniCurrentYear, miniCurrentMonthIndex, 1);
        const lastDayOfMonth = new Date(miniCurrentYear, miniCurrentMonthIndex + 1, 0);
        const firstDayWeekday = firstDayOfMonth.getDay();
        const lastDate = lastDayOfMonth.getDate();

        miniCalendarDates.innerHTML = '';

        // Fill in the days from the previous month
        for (let i = 0; i < firstDayWeekday; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.classList.add('mini-calendar-date', 'empty');
            miniCalendarDates.appendChild(emptyCell);
        }

        // Fill in the days of the current month
        for (let date = 1; date <= lastDate; date++) {
            const dateCell = document.createElement('div');
            dateCell.classList.add('mini-calendar-date');
            dateCell.textContent = date;
            miniCalendarDates.appendChild(dateCell);
        }

        // Re-attach event listeners to the new mini calendar dates
        addMiniCalendarEventListeners();
    }

    miniPrevBtn.addEventListener('click', function() {
        miniCurrentMonthIndex--;
        if (miniCurrentMonthIndex < 0) {
            miniCurrentMonthIndex = 11;
            miniCurrentYear--;
        }
        updateMiniCalendar();
    });

    miniNextBtn.addEventListener('click', function() {
        miniCurrentMonthIndex++;
        if (miniCurrentMonthIndex > 11) {
            miniCurrentMonthIndex = 0;
            miniCurrentYear++;
        }
        updateMiniCalendar();
    });

    updateMiniCalendar();
});
</script>
<script>
// Search functionality: Handles searching for procedures by date or patient name
document.addEventListener('DOMContentLoaded', function() {
    const searchBtn = document.getElementById('search-btn');
    const searchInput = document.getElementById('search-input');
    const searchTypeData = document.getElementById('search-data');
    const searchTypePaciente = document.getElementById('search-paciente');
    const searchTypeProcedimento = document.getElementById('search-procedimento');

    function performSearch() {
        const query = searchInput.value.trim();
        if (!query) return;

        if (searchTypeData.checked) {
            // Handle date search
            const dateParts = query.split('/');
            if (dateParts.length === 3) {
                const day = dateParts[0].padStart(2, '0');
                const month = dateParts[1].padStart(2, '0');
                const year = dateParts[2];
                const formattedDate = `${year}-${month}-${day}`;
                window.location.href = `/agenda/search?date=${formattedDate}`;
            } else {
                alert('Formato de data inválido. Use DD/MM/YYYY.');
            }
        } else if (searchTypePaciente.checked) {
            // Handle paciente search
            window.location.href = `/agenda/search?paciente=${query}`;
        } else if (searchTypeProcedimento.checked) {
            // Handle procedimento search
            window.location.href = `/agenda/search?procedimento=${query}`;
        }
    }

    searchBtn.addEventListener('click', performSearch);

    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault(); // Prevent form submission if inside a form
            performSearch();
        }
    });
});
</script>

<script>
// Date highlighting: Highlights the searched date in the calendar view
    const highlightDate = '{{ highlight_date|date:"Y-m-d" }}';
    
    document.addEventListener('DOMContentLoaded', function() {
        if (highlightDate) {
            // Highlight the day columns
            const dayElements = document.querySelectorAll(`.day[data-date="${highlightDate}"], .day-column[data-date="${highlightDate}"]`);
            dayElements.forEach(el => {
                el.classList.add('highlight');
            });
    
            // Highlight the procedure cards
            const procedureCards = document.querySelectorAll(`.procedure-card[data-date="${highlightDate}"]`);
            procedureCards.forEach(card => {
                card.classList.add('highlight');
            });
        }
    });
</script>

<script>
// Search input updates: Dynamically updates search input based on selected search type
document.addEventListener('DOMContentLoaded', function() {
    const searchDataRadio = document.getElementById('search-data');
    const searchPacienteRadio = document.getElementById('search-paciente');
    const inputContainer = document.querySelector('.search-bar .input-container');
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.getElementById('search-btn');

    function updateSearchInput() {
        if (searchDataRadio.checked || searchPacienteRadio.checked) {
            inputContainer.style.display = 'block';
            if (searchDataRadio.checked) {
                searchInput.placeholder = 'Digite a data (DD/MM/YYYY)';
                $(searchInput).inputmask("99/99/9999");  // Apply date mask
            } else {
                searchInput.placeholder = 'Digite o nome do paciente';
                $(searchInput).inputmask('remove');  // Remove any existing mask
            }
        } else {
            inputContainer.style.display = 'none';
        }
    }

    searchDataRadio.addEventListener('change', updateSearchInput);
    searchPacienteRadio.addEventListener('change', updateSearchInput);

    searchBtn.addEventListener('click', function() {
        const query = searchInput.value.trim();
        if (!query) return;

        if (searchDataRadio.checked) {
            // Handle date search
            const dateParts = query.split('/');
            if (dateParts.length === 3) {
                const day = dateParts[0].padStart(2, '0');
                const month = dateParts[1].padStart(2, '0');
                const year = dateParts[2];
                const formattedDate = `${year}-${month}-${day}`;
                window.location.href = `/agenda/search?date=${formattedDate}`;
            } else {
                alert('Formato de data inválido. Use DD/MM/YYYY.');
            }
        } else if (searchPacienteRadio.checked) {
            // Handle paciente search
            window.location.href = `/agenda/search?paciente=${query}`;
        }
    });

    updateSearchInput();
});
</script>

<script>
// Autocomplete: Implements autocomplete for patient search
document.addEventListener('DOMContentLoaded', function() {
    const searchInput = document.getElementById('search-input');
    const searchTypePaciente = document.getElementById('search-paciente');
    
    let timeoutId;

    searchInput.addEventListener('input', function() {
        if (searchTypePaciente.checked) {
            clearTimeout(timeoutId);
            timeoutId = setTimeout(() => {
                const query = this.value.trim();
                if (query.length >= 2) {
                    fetch(`/search-pacientes/?query=${encodeURIComponent(query)}`)
                        .then(response => response.json())
                        .then(data => {
                            // Clear previous results
                            const existingResults = document.getElementById('autocomplete-results');
                            if (existingResults) {
                                existingResults.remove();
                            }

                            // Create and populate results
                            const resultsDiv = document.createElement('div');
                            resultsDiv.id = 'autocomplete-results';
                            resultsDiv.style.position = 'absolute';
                            resultsDiv.style.zIndex = '1000';
                            resultsDiv.style.backgroundColor = 'white';
                            resultsDiv.style.border = '1px solid #ddd';
                            resultsDiv.style.maxHeight = '200px';
                            resultsDiv.style.overflowY = 'auto';

                            data.forEach(paciente => {
                                const item = document.createElement('div');
                                item.textContent = paciente;
                                item.style.padding = '5px';
                                item.style.cursor = 'pointer';
                                item.addEventListener('click', function() {
                                    searchInput.value = this.textContent;
                                    resultsDiv.remove();
                                });
                                resultsDiv.appendChild(item);
                            });

                            searchInput.parentNode.appendChild(resultsDiv);
                        });
                }
            }, 300);  // Debounce for 300ms
        }
    });

    // Close autocomplete results when clicking outside
    document.addEventListener('click', function(e) {
        if (e.target !== searchInput) {
            const results = document.getElementById('autocomplete-results');
            if (results) {
                results.remove();
            }
        }
    });
});
</script>
{% endblock %}
