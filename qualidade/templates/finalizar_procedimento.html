{% extends 'layout.html' %}
{% load static %}
{% load custom_filters %}

{% block title %}Finalizar Procedimento{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/formularios.css' %}">
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="container-info">
        <div class="info-section">
            <h2>Resumo do procedimento</h2>
            <div class="info-item">
                <div class="procedure-type">
                    <span class="type-indicator {% if procedimento.procedimento_type == 'cirurgia_procedimento' %}cirurgia{% elif procedimento.procedimento_type == 'fora_centro_procedimento' %}fora-centro{% else %}exame{% endif %}"></span>
                    {{ procedimento.get_procedimento_type_display }}
                </div>
                <div class="procedure-name">{{ procedimento.procedimento_principal.name }}</div>
                <div class="info-value">{{ procedimento.data_horario|date:"d/m/Y" }} - {{ procedimento.data_horario|time:"H:i" }} às {{ procedimento.data_horario_fim|time:"H:i" }}</div>
            </div>
        </div>

        <div class="info-section">
            <div class="info-item">
                <div class="info-label">Paciente</div>
                <div class="info-value">{{ procedimento.nome_paciente|default:"Não informado" }}</div>
            </div>
        </div>

        <div class="info-section">
            <div class="info-item">
                <div class="info-label">Local</div>
                <div class="info-value">{{ procedimento.hospital|default:"Não informado" }}</div>
            </div>
        </div>
    </div>

    <div class="container-form">
        <form method="post" id="finalizarProcedimentoForm">
            <h1>Finalizar Procedimento</h1>
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}
            
            <div class="time-inputs-row">
                <div class="radio-group">
                    <label for="{{ form.data_horario_inicio_efetivo.id_for_label }}">{{ form.data_horario_inicio_efetivo.label }}</label>
                    <div class="input-width-280">
                        {{ form.data_horario_inicio_efetivo }}
                        {% if form.data_horario_inicio_efetivo.errors %}
                        <div class="error-message">
                            {% for error in form.data_horario_inicio_efetivo.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>

                <div class="radio-group">
                    <label for="{{ form.data_horario_fim_efetivo.id_for_label }}">{{ form.data_horario_fim_efetivo.label }}</label>
                    <div class="input-width-280">
                        {{ form.data_horario_fim_efetivo }}
                        {% if form.data_horario_fim_efetivo.errors %}
                        <div class="error-message">
                            {% for error in form.data_horario_fim_efetivo.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <div class="radio-group">
                <label for="{{ form.procedimento_tipo_clinica.id_for_label }}">{{ form.procedimento_tipo_clinica.label }}</label>
                <div class="input-width-280">
                    {{ form.procedimento_tipo_clinica }}
                    {% if form.procedimento_tipo_clinica.errors %}
                    <div class="error-message">
                        {% for error in form.procedimento_tipo_clinica.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="radio-group">
                <label>{{ form.dor_pos_operatoria.label }}</label>
                <div class="radio-options-container">
                    {% for radio in form.dor_pos_operatoria %}
                        <div class="radio-option">
                            <label>{{ radio.tag }}</label>
                            {{ radio.choice_label }}
                        </div>
                    {% endfor %}
                </div>
                {% if form.dor_pos_operatoria.errors %}
                <div class="error-message">
                    {% for error in form.dor_pos_operatoria.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="radio-group scale-container">
                <label>{{ form.escala.label }}</label>
                <div class="radio-options-container">
                    {% for radio in form.escala %}
                        {% if radio.choice_label != '---------' %}
                            <div class="radio-option">
                                <label>{{ radio.tag }}</label>
                                {{ radio.choice_label }}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% if form.escala.errors %}
                <div class="error-message">
                    {% for error in form.escala.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- EVA specific fields -->
            <div id="eva-fields" class="radio-group scale-container">
                <label>{{ form.eva_score.label }}</label>
                <div class="scale-descriptions">
                    <span class="scale-description left">Dor leve</span>
                    <span class="scale-description">Dor moderada</span>
                    <span class="scale-description right">Dor intensa</span>
                </div>
                <div class="rainbow-scale"></div>
                <div class="horizontal-radio-group">
                    {% for radio in form.eva_score %}
                        <div class="radio-option">
                            <label>{{ radio.tag }}</label>
                            {{ radio.choice_label }}
                        </div>
                    {% endfor %}
                </div>
                {% if form.eva_score.errors %}
                <div class="error-message">
                    {% for error in form.eva_score.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- FLACC specific fields -->
            <div id="flacc-fields" class="radio-group">
                {% for field in form %}
                    {% if field.name in 'face,pernas,atividade,choro,consolabilidade' %}
                        <div class="scale-container">
                            <label>{{ field.label }}</label>
                            <div class="scale-descriptions">
                                <span class="scale-description left">{{ form.FLACC_DESCRIPTIONS|get_item:field.name|get_item:'low' }}</span>
                                <span class="scale-description">{{ form.FLACC_DESCRIPTIONS|get_item:field.name|get_item:'mid' }}</span>
                                <span class="scale-description right">{{ form.FLACC_DESCRIPTIONS|get_item:field.name|get_item:'high' }}</span>
                            </div>
                            <div class="rainbow-scale"></div>
                            <div class="horizontal-radio-group">
                                {% for radio in field %}
                                    <div class="radio-option">
                                        <label>{{ radio.tag }}</label>
                                        {{ radio.choice_label }}
                                    </div>
                                {% endfor %}
                            </div>
                            {% if field.errors %}
                            <div class="error-message">
                                {% for error in field.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <!-- BPS specific fields -->
            <div id="bps-fields" class="radio-group">
                {% for field in form %}
                    {% if field.name in 'expressao_facial,movimentos_membros_superiores,adaptacao_ventilador' %}
                        <div class="scale-container">
                            <label>{{ field.label }}</label>
                            <div class="scale-descriptions">
                                <span class="scale-description left">{{ form.BPS_DESCRIPTIONS|get_item:field.name|get_item:'low' }}</span>
                                <span class="scale-description">{{ form.BPS_DESCRIPTIONS|get_item:field.name|get_item:'mid' }}</span>
                                <span class="scale-description">{{ form.BPS_DESCRIPTIONS|get_item:field.name|get_item:'high' }}</span>
                                <span class="scale-description right">{{ form.BPS_DESCRIPTIONS|get_item:field.name|get_item:'extreme' }}</span>
                            </div>
                            <div class="rainbow-scale"></div>
                            <div class="horizontal-radio-group">
                                {% for radio in field %}
                                    <div class="radio-option">
                                        <label>{{ radio.tag }}</label>
                                        {{ radio.choice_label }}
                                    </div>
                                {% endfor %}
                            </div>
                            {% if field.errors %}
                            <div class="error-message">
                                {% for error in field.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endfor %}
            </div>

            <!-- PAINAD-B specific fields -->
            <div id="painad-b-fields" class="radio-group">
                {% for field in form %}
                    {% with painad_fields='respiracao,vocalizacao_negativa,expressao_facial_painad,linguagem_corporal,consolabilidade_painad'|split:',' %}
                        {% if field.name in painad_fields %}
                            <div class="scale-container">
                                <label>{{ field.label }}</label>
                                <div class="scale-descriptions">
                                    <span class="scale-description left">{{ form.PAINAD_B_DESCRIPTIONS|get_item:field.name|get_item:'low' }}</span>
                                    <span class="scale-description">{{ form.PAINAD_B_DESCRIPTIONS|get_item:field.name|get_item:'mid' }}</span>
                                    <span class="scale-description right">{{ form.PAINAD_B_DESCRIPTIONS|get_item:field.name|get_item:'high' }}</span>
                                </div>
                                <div class="rainbow-scale"></div>
                                <div class="horizontal-radio-group">
                                    {% for radio in field %}
                                        <div class="radio-option">
                                            <label>{{ radio.tag }}</label>
                                            {{ radio.choice_label }}
                                        </div>
                                    {% endfor %}
                                </div>
                                {% if field.errors %}
                                <div class="error-message">
                                    {% for error in field.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endwith %}
                {% endfor %}
            </div>

            <div class="total-container">
                <span class="total-label">Total:</span>
                <span class="total-value" id="total-score">0</span>
                <span class="pain-classification" id="pain-classification"></span>
            </div>

            <div class="radio-group">
                <label>{{ form.abreviacao_jejum.label }}</label>
                <div class="radio-options-container">
                    {% for radio in form.abreviacao_jejum %}
                        <div class="radio-option">
                            <label>{{ radio.tag }}</label>
                            {{ radio.choice_label }}
                        </div>
                    {% endfor %}
                </div>
                {% if form.abreviacao_jejum.errors %}
                <div class="error-message">
                    {% for error in form.abreviacao_jejum.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="radio-group scale-container">
                <label>{{ form.escala_aldrete.label }}</label>
                <div class="rainbow-scale"></div>
                <div class="horizontal-radio-group">
                    {% for radio in form.escala_aldrete %}
                        <div class="radio-option">
                            <label>{{ radio.tag }}</label>
                            {{ radio.choice_label }}
                        </div>
                    {% endfor %}
                </div>
                {% if form.escala_aldrete.errors %}
                <div class="error-message">
                    {% for error in form.escala_aldrete.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="radio-group">
                <label>{{ form.eventos_adversos_graves.label }}</label>
                <div class="radio-options-container">
                    {% for radio in form.eventos_adversos_graves %}
                        <div class="radio-option">
                            <label>{{ radio.tag }}</label>
                            {{ radio.choice_label }}
                        </div>
                    {% endfor %}
                </div>
                {% if form.eventos_adversos_graves.errors %}
                <div class="error-message">
                    {% for error in form.eventos_adversos_graves.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="radio-group" id="eventos_adversos_graves_desc_group" style="display: none;">
                <label for="{{ form.eventos_adversos_graves_desc.id_for_label }}">{{ form.eventos_adversos_graves_desc.label }}</label>
                <div class="input-width-280">
                    {{ form.eventos_adversos_graves_desc }}
                </div>
                {% if form.eventos_adversos_graves_desc.errors %}
                <div class="error-message">
                    {% for error in form.eventos_adversos_graves_desc.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="radio-group">
                <label>{{ form.reacao_alergica_grave.label }}</label>
                <div class="radio-options-container">
                    {% for radio in form.reacao_alergica_grave %}
                        <div class="radio-option">
                            <label>{{ radio.tag }}</label>
                            {{ radio.choice_label }}
                        </div>
                    {% endfor %}
                </div>
                {% if form.reacao_alergica_grave.errors %}
                <div class="error-message">
                    {% for error in form.reacao_alergica_grave.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="radio-group" id="reacao_alergica_grave_desc_group" style="display: none;">
                <label for="{{ form.reacao_alergica_grave_desc.id_for_label }}">{{ form.reacao_alergica_grave_desc.label }}</label>
                {{ form.reacao_alergica_grave_desc }}
                {% if form.reacao_alergica_grave_desc.errors %}
                <div class="error-message">
                    {% for error in form.reacao_alergica_grave_desc.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="radio-group">
                <label>{{ form.evento_adverso_evitavel.label }}</label>
                <div class="radio-options-container">
                    {% for radio in form.evento_adverso_evitavel %}
                        <div class="radio-option">
                            <label>{{ radio.tag }}</label>
                            {{ radio.choice_label }}
                        </div>
                    {% endfor %}
                </div>
                {% if form.evento_adverso_evitavel.errors %}
                <div class="error-message">
                    {% for error in form.evento_adverso_evitavel.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="radio-group" id="evento_adverso_evitavel_desc_group" style="display: none;">
                <label for="{{ form.evento_adverso_evitavel_desc.id_for_label }}">{{ form.evento_adverso_evitavel_desc.label }}</label>
                <div class="input-width-280">
                    {{ form.evento_adverso_evitavel_desc }}
                </div>
                {% if form.evento_adverso_evitavel_desc.errors %}
                <div class="error-message">
                    {% for error in form.evento_adverso_evitavel_desc.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <!-- Exclude already handled fields from the general radio fields loop -->
            {% for field in form %}
                {% with excluded_fields='eventos_adversos_graves,reacao_alergica_grave,dor_pos_operatoria,escala,eva_score,face,pernas,atividade,choro,consolabilidade,expressao_facial,movimentos_membros_superiores,adaptacao_ventilador,respiracao,vocalizacao_negativa,expressao_facial_painad,linguagem_corporal,consolabilidade_painad,tipo_cobranca,adesao_profilaxia_antibiotica,adesao_prevencao_tvp_tep,evento_adverso_evitavel,abreviacao_jejum,escala_aldrete'|split:',' %}
                    {% if field.field.widget.input_type == "radio" and field.name not in excluded_fields %}
                        <div class="radio-group">
                            <label>{{ field.label }}</label>
                            <div class="radio-options-container">
                                {% for radio in field %}
                                    {% if radio.choice_label != '---------' %}
                                        <div class="radio-option">
                                            <label>{{ radio.tag }}</label>
                                            {{ radio.choice_label }}
                                        </div>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% if field.errors %}
                            <div class="error-message">
                                {% for error in field.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </div>
                    {% endif %}
                {% endwith %}
            {% endfor %}

            <div class="radio-group">
                <label>{{ form.adesao_profilaxia_antibiotica.label }}</label>
                <div class="radio-options-container">
                    {% for radio in form.adesao_profilaxia_antibiotica %}
                        {% if radio.choice_label != '---------' %}
                            <div class="radio-option">
                                <label>{{ radio.tag }}</label>
                                {{ radio.choice_label }}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% if form.adesao_profilaxia_antibiotica.errors %}
                <div class="error-message">
                    {% for error in form.adesao_profilaxia_antibiotica.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="radio-group">
                <label>{{ form.adesao_prevencao_tvp_tep.label }}</label>
                <div class="radio-options-container">
                    {% for radio in form.adesao_prevencao_tvp_tep %}
                        {% if radio.choice_label != '---------' %}
                            <div class="radio-option">
                                <label>{{ radio.tag }}</label>
                                {{ radio.choice_label }}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% if form.adesao_prevencao_tvp_tep.errors %}
                <div class="error-message">
                    {% for error in form.adesao_prevencao_tvp_tep.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="radio-group">
                <label>{{ form.tipo_cobranca.label }}</label>
                <div class="radio-options-container">
                    {% for radio in form.tipo_cobranca %}
                        {% if radio.choice_label != '---------' %}
                            <div class="radio-option">
                                <label>{{ radio.tag }}</label>
                                {{ radio.choice_label }}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
                {% if form.tipo_cobranca.errors %}
                <div class="error-message">
                    {% for error in form.tipo_cobranca.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="radio-group" id="valor_faturado_container">
                <label for="{{ form.valor_faturado.id_for_label }}">{{ form.valor_faturado.label }}</label>
                <div class="input-width-280">
                    {{ form.valor_faturado }}
                    {% if form.valor_faturado.errors %}
                    <div class="error-message">
                        {% for error in form.valor_faturado.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="radio-group" id="tipo_pagamento_direto_container" style="display: none;">
                <label>{{ form.tipo_pagamento_direto.label }}</label>
                <div class="input-width-280">
                    {{ form.tipo_pagamento_direto }}
                    {% if form.tipo_pagamento_direto.errors %}
                    <div class="error-message">
                        {% for error in form.tipo_pagamento_direto.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="radio-group" id="data_pagamento_container" style="display: none;">
                <label for="{{ form.data_pagamento.id_for_label }}">{{ form.data_pagamento.label }}</label>
                <div class="input-width-280">
                    {{ form.data_pagamento }}
                    {% if form.data_pagamento.errors %}
                    <div class="error-message">
                        {% for error in form.data_pagamento.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="button-container">
                <button type="submit" class="btn btn-primary">Salvar</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://unpkg.com/imask"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('finalizarProcedimentoForm');
    const valorFaturadoInput = document.getElementById('id_valor_faturado');
    let moneyMask; // Instance of IMask

    // Declare elements that might be used by various functions
    let escalaInputs, evaFields, flaccFields, bpsFields, painadBFields, painScaleSectionElements;
    const tipoCobrancaInputs = document.querySelectorAll('input[name="tipo_cobranca"]'); // First and only declaration
    const dorPosOperatoriaInputs = document.querySelectorAll('input[name="dor_pos_operatoria"]');

    if (form) {
        escalaInputs = form.querySelectorAll('input[name="escala"]');
    }
    // These are looked up by ID, so they are fine here
    evaFields = document.getElementById('eva-fields');
    flaccFields = document.getElementById('flacc-fields');
    bpsFields = document.getElementById('bps-fields');
    painadBFields = document.getElementById('painad-b-fields');
    
    // Define pain scale section elements
    // This includes the 'escala' radio group, all specific scale field divs, and the total-container.
    // The 'escala' field is within a div with class 'radio-group scale-container'.
    // Other scale fields are in divs with IDs like 'eva-fields'.
    // The total score is in a div with class 'total-container'.
    painScaleSectionElements = [
        document.querySelector('input[name="escala"]').closest('.radio-group.scale-container'), // Escala radio buttons
        evaFields,
        flaccFields,
        bpsFields,
        painadBFields,
        document.getElementById('total-score').closest('.total-container') // Total score display
    ].filter(el => el != null); // Filter out any null elements if some IDs don't exist

    if (valorFaturadoInput) {
        // --- Debug: Initial value from Django ---
        // console.log('DEBUG: Initial valorFaturadoInput.value (from Django):', valorFaturadoInput.value);

        let initialValueForIMask = valorFaturadoInput.value;
        if (initialValueForIMask && initialValueForIMask.includes('.') && !initialValueForIMask.includes(',')) {
            const parts = initialValueForIMask.split('.');
            if (parts.length === 2 && /^\d+$/.test(parts[0]) && /^\d+$/.test(parts[1])) {
                initialValueForIMask = initialValueForIMask.replace('.', ',');
                console.log('DEBUG: initialValueForIMask (after replacing . with ,):', initialValueForIMask);
            }
        }
        valorFaturadoInput.value = initialValueForIMask;

        const maskOptions = {
            mask: 'R$ num',
            blocks: {
                num: {
                    mask: Number,
                    scale: 2,
                    thousandsSeparator: '.',
                    padFractionalZeros: true,
                    radix: ',',
                    mapToRadix: ['.'],
                    max: 999999.99,
                    autofix: true
                }
            }
        };
        moneyMask = IMask(valorFaturadoInput, maskOptions);

        console.log('DEBUG: IMask after init - moneyMask.value:', moneyMask.value);
        console.log('DEBUG: IMask after init - moneyMask.unmaskedValue:', moneyMask.unmaskedValue);
        console.log('DEBUG: IMask after init - moneyMask.typedValue:', moneyMask.typedValue);

        if (form) { // Ensure form exists before adding submit listener
            form.addEventListener('submit', function(e) {
                if (valorFaturadoInput && moneyMask) {
                    console.log('DEBUG: Submit handler - moneyMask.value:', moneyMask.value);
                    console.log('DEBUG: Submit handler - moneyMask.unmaskedValue:', moneyMask.unmaskedValue);
                    console.log('DEBUG: Submit handler - moneyMask.typedValue:', moneyMask.typedValue);

                    let finalSubmitValue = '';
                    if (typeof moneyMask.typedValue === 'number' && !isNaN(moneyMask.typedValue)) {
                        finalSubmitValue = moneyMask.typedValue.toFixed(maskOptions.blocks.num.scale);
                        console.log('DEBUG: Submit - Using typedValue, formatted to:', finalSubmitValue);
                    } else {
                        const unmasked = moneyMask.unmaskedValue;
                        if (unmasked && unmasked.trim() !== '') {
                            finalSubmitValue = unmasked.replace(',', '.');
                            console.log('DEBUG: Submit - Using unmaskedValue, converted to:', finalSubmitValue);
                        } else {
                            console.log('DEBUG: Submit - Input is considered empty.');
                        }
                    }
                    valorFaturadoInput.value = finalSubmitValue;
                    console.log('DEBUG: Final valorFaturadoInput.value for submission:', valorFaturadoInput.value);
                }
            });
        }
    }

    function handleTipoCobrancaChange() {
        const selectedValue = document.querySelector('input[name="tipo_cobranca"]:checked')?.value;
        // console.log('Tipo cobrança changed:', selectedValue); // Keep for debugging

        const valorFaturadoContainer = document.getElementById('valor_faturado_container');
        const tipoPagamentoDiretoContainer = document.getElementById('tipo_pagamento_direto_container');
        const tipoPagamentoDiretoInput = document.getElementById('id_tipo_pagamento_direto');
        const dataPagamentoContainer = document.getElementById('data_pagamento_container');
        const dataPagamentoInput = document.getElementById('id_data_pagamento');

        if (selectedValue === 'cooperativa') {
            if (valorFaturadoContainer) valorFaturadoContainer.style.display = 'none';
            if (tipoPagamentoDiretoContainer) tipoPagamentoDiretoContainer.style.display = 'none';
            if (dataPagamentoContainer) dataPagamentoContainer.style.display = 'none';
            if (tipoPagamentoDiretoInput) tipoPagamentoDiretoInput.value = '';
            if (dataPagamentoInput) dataPagamentoInput.value = ''; // Clear data_pagamento if cooperativa
            // valorFaturadoInput is hidden, its value is managed by IMask & submit handler
        } else if (selectedValue === 'cortesia') {
            // Hide value and date, ensure value is zero
            if (valorFaturadoContainer) valorFaturadoContainer.style.display = 'none';
            if (dataPagamentoContainer) dataPagamentoContainer.style.display = 'none';
            if (tipoPagamentoDiretoContainer) tipoPagamentoDiretoContainer.style.display = 'none';
            if (tipoPagamentoDiretoInput) tipoPagamentoDiretoInput.value = '';
            if (dataPagamentoInput) dataPagamentoInput.value = '';
            if (moneyMask && valorFaturadoInput) {
                moneyMask.typedValue = 0;
                valorFaturadoInput.value = '0.00';
            }
        } else { // hospital, particular, via_cirurgiao
            if (valorFaturadoContainer) valorFaturadoContainer.style.display = 'block';
            if (dataPagamentoContainer) dataPagamentoContainer.style.display = 'block'; // Show for hospital/particular/via_cirurgiao

            if (tipoPagamentoDiretoContainer) {
                tipoPagamentoDiretoContainer.style.display = selectedValue === 'particular' ? 'block' : 'none';
            }
            if (selectedValue !== 'particular') { // hospital or via_cirurgiao
                if (tipoPagamentoDiretoInput) tipoPagamentoDiretoInput.value = ''; // Clear tipo_pagamento_direto
            }
        }
    }

    if (tipoCobrancaInputs && tipoCobrancaInputs.length > 0) {
        tipoCobrancaInputs.forEach(input => {
            input.addEventListener('change', handleTipoCobrancaChange);
        });
        handleTipoCobrancaChange(); // Initial call to set visibility based on current state
    }

    function togglePainScaleSectionVisibility() {
        const dorPosOperatoriaSelectedValue = document.querySelector('input[name="dor_pos_operatoria"]:checked')?.value;
        const showPainScale = dorPosOperatoriaSelectedValue === 'True';

        painScaleSectionElements.forEach(el => {
            if (el) el.style.display = showPainScale ? 'block' : 'none';
        });

        // If pain scale is hidden, also hide specific scale fields
        if (!showPainScale) {
            if (evaFields) evaFields.style.display = 'none';
            if (flaccFields) flaccFields.style.display = 'none';
            if (bpsFields) bpsFields.style.display = 'none';
            if (painadBFields) painadBFields.style.display = 'none';
        } else {
            // If pain scale is shown, trigger the logic to show the relevant specific scale
            showRelevantScaleFields();
        }
    }

    function showRelevantScaleFields() {
        if (!form || !escalaInputs || !evaFields || !flaccFields || !bpsFields || !painadBFields) return; // Guard

        const dorPosOperatoriaSelectedValue = document.querySelector('input[name="dor_pos_operatoria"]:checked')?.value;
        // Only proceed if "Sim" is selected for post-operative pain
        if (dorPosOperatoriaSelectedValue !== 'True') {
            return;
        }

        const selectedScale = form.querySelector('input[name="escala"]:checked');
        const selectedValue = selectedScale ? selectedScale.value : null;

        if (evaFields) evaFields.style.display = selectedValue === 'EVA' ? 'block' : 'none';
        if (flaccFields) flaccFields.style.display = selectedValue === 'FLACC' ? 'block' : 'none';
        if (bpsFields) bpsFields.style.display = selectedValue === 'BPS' ? 'block' : 'none';
        if (painadBFields) painadBFields.style.display = selectedValue === 'PAINAD-B' ? 'block' : 'none';

        const totalScoreEl = document.getElementById('total-score');
        const painClassificationEl = document.getElementById('pain-classification');
        if (!selectedValue && totalScoreEl && painClassificationEl) {
            totalScoreEl.textContent = '0';
            painClassificationEl.textContent = '';
        }
    }
    
    if (dorPosOperatoriaInputs && dorPosOperatoriaInputs.length > 0) {
        dorPosOperatoriaInputs.forEach(input => {
            input.addEventListener('change', togglePainScaleSectionVisibility);
        });
        // Initial call to set visibility on page load
        togglePainScaleSectionVisibility();
    }

    if (escalaInputs && escalaInputs.length > 0) {
        escalaInputs.forEach(input => {
            input.addEventListener('change', showRelevantScaleFields);
        });
        // Initial call, but it will be controlled by togglePainScaleSectionVisibility's call to showRelevantScaleFields
        // showRelevantScaleFields(); 
    }

    // Pain classification logic
    function getPainClassification(scale, total) {
        if (scale === 'BPS') {
            if (total === 3) return "Sem dor";
            if (total >= 4 && total <= 5) return "Dor Leve";
            if (total >= 6 && total <= 8) return "Dor moderada";
            if (total >= 9 && total <= 12) return "Dor forte";
        }
        else if (scale === 'PAINAD-B') {
            if (total === 0) return "Sem dor";
            if (total >= 1 && total <= 3) return "Dor Leve";
            if (total >= 4 && total <= 7) return "Dor moderada";
            if (total >= 8 && total <= 10) return "Dor forte";
        }
        return "";
    }

    function calculateTotal() {
        const selectedScale = form.querySelector('input[name="escala"]:checked');
        if (!selectedScale) return;

        let total = 0;
        
        switch(selectedScale.value) {
            case 'EVA':
                const evaScore = form.querySelector('input[name="eva_score"]:checked');
                total = evaScore ? parseInt(evaScore.value) : 0;
                break;
                
            case 'FLACC':
                const flaccFields = ['face', 'pernas', 'atividade', 'choro', 'consolabilidade'];
                flaccFields.forEach(field => {
                    const checked = form.querySelector(`input[name="${field}"]:checked`);
                    total += checked ? parseInt(checked.value) : 0;
                });
                break;
                
            case 'BPS':
                const bpsFields = ['expressao_facial', 'movimentos_membros_superiores', 'adaptacao_ventilador'];
                bpsFields.forEach(field => {
                    const checked = form.querySelector(`input[name="${field}"]:checked`);
                    total += checked ? parseInt(checked.value) : 0;
                });
                break;
                
            case 'PAINAD-B':
                const painadFields = ['respiracao', 'vocalizacao_negativa', 'expressao_facial_painad', 
                                   'linguagem_corporal', 'consolabilidade_painad'];
                painadFields.forEach(field => {
                    const checked = form.querySelector(`input[name="${field}"]:checked`);
                    total += checked ? parseInt(checked.value) : 0;
                });
                break;
        }
        
        document.getElementById('total-score').textContent = total;
        
        // Update pain classification
        const classification = getPainClassification(selectedScale.value, total);
        const classificationElement = document.getElementById('pain-classification');
        classificationElement.textContent = classification ? `- ${classification}` : '';
    }

    // Add event listeners for all fields that affect the total
    const allScaleInputs = form.querySelectorAll('input[type="radio"]');
    allScaleInputs.forEach(input => {
        input.addEventListener('change', calculateTotal);
    });

    // Calculate initial total
    calculateTotal();

    // Eventos Adversos Graves handler
    const eventosAdversosGravesInputs = document.querySelectorAll('input[name="eventos_adversos_graves"]');
    const eventosAdversosGravesDescGroup = document.getElementById('eventos_adversos_graves_desc_group');

    function handleEventosAdversosGravesChange(event) {
        const selectedValue = event.target.value === 'True';
        eventosAdversosGravesDescGroup.style.display = selectedValue ? 'block' : 'none';
        
        if (!selectedValue) {
            const select = document.querySelector('select[name="eventos_adversos_graves_desc"]');
            if (select) select.value = '';
        }
    }

    eventosAdversosGravesInputs.forEach(input => {
        input.addEventListener('change', handleEventosAdversosGravesChange);
    });

    // Run on page load to handle initial states
    const initialEventosAdversos = document.querySelector('input[name="eventos_adversos_graves"]:checked');
    if (initialEventosAdversos) {
        handleEventosAdversosGravesChange({ target: initialEventosAdversos });
    }

    // Evento Adverso Evitável handler
    const eventoAdversoEvitavelInputs = document.querySelectorAll('input[name="evento_adverso_evitavel"]');
    const eventoAdversoEvitavelDescGroup = document.getElementById('evento_adverso_evitavel_desc_group');

    function handleEventoAdversoEvitavelChange(event) {
        const selectedValue = event.target.value === 'True';
        eventoAdversoEvitavelDescGroup.style.display = selectedValue ? 'block' : 'none';
        
        if (!selectedValue) {
            const select = document.querySelector('select[name="evento_adverso_evitavel_desc"]');
            if (select) select.value = '';
        }
    }

    eventoAdversoEvitavelInputs.forEach(input => {
        input.addEventListener('change', handleEventoAdversoEvitavelChange);
    });

    const initialEventoAdversoEvitavel = document.querySelector('input[name="evento_adverso_evitavel"]:checked');
    if (initialEventoAdversoEvitavel) {
        handleEventoAdversoEvitavelChange({ target: initialEventoAdversoEvitavel });
    }

    // Reação Alérgica Grave handler
    const reacaoAlergicaGraveInputs = document.querySelectorAll('input[name="reacao_alergica_grave"]');
    const reacaoAlergicaGraveDescGroup = document.getElementById('reacao_alergica_grave_desc_group');

    function handleReacaoAlergicaGraveChange(event) {
        const selectedValue = event.target.value === 'True';
        reacaoAlergicaGraveDescGroup.style.display = selectedValue ? 'block' : 'none';
        
        if (!selectedValue) {
            const textarea = document.querySelector('textarea[name="reacao_alergica_grave_desc"]');
            if (textarea) textarea.value = '';
        }
    }

    reacaoAlergicaGraveInputs.forEach(input => {
        input.addEventListener('change', handleReacaoAlergicaGraveChange);
    });

    // Run on page load to handle initial states
    const initialReacaoAlergica = document.querySelector('input[name="reacao_alergica_grave"]:checked');
    if (initialReacaoAlergica) {
        handleReacaoAlergicaGraveChange({ target: initialReacaoAlergica });
    }

    // Ensure initial state of pain scale section is correct based on dor_pos_operatoria
    togglePainScaleSectionVisibility();
    // Then, ensure the correct specific scale fields are shown if the section itself is visible.
    showRelevantScaleFields(); 
});
</script>
{% endblock %}

