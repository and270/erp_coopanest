{% extends 'layout.html' %}
{% load static %}

{% block title %}Finalizar Procedimento{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/formularios.css' %}">
{% endblock %}

{% block content %}
<div class="page-container">
    <div class="container-info">
        <div class="info-section">
            <h2>Resumo do procedimento</h2>
            <div class="info-item">
                <div class="procedure-type">
                    <span class="type-indicator {% if procedimento.procedimento_type == 'cirurgia_procedimento' %}cirurgia{% elif procedimento.procedimento_type == 'fora_centro_procedimento' %}fora-centro{% else %}exame{% endif %}"></span>
                    {{ procedimento.get_procedimento_type_display }}
                </div>
                <div class="procedure-name">{{ procedimento.procedimento }}</div>
                <div class="info-value">{{ procedimento.data_horario|date:"d/m/Y" }} - {{ procedimento.data_horario|time:"H:i" }} às {{ procedimento.data_horario_fim|time:"H:i" }}</div>
            </div>
        </div>

        <div class="info-section">
            <div class="info-item">
                <div class="info-label">Paciente</div>
                <div class="info-value">{{ procedimento.nome_paciente|default:"Não informado" }}</div>
            </div>
        </div>

        <div class="info-section">
            <div class="info-item">
                <div class="info-label">Local</div>
                <div class="info-value">{{ procedimento.hospital|default:"Não informado" }}</div>
            </div>
        </div>
    </div>

    <div class="container-form">
        <form method="post" id="finalizarProcedimentoForm">
            <h1>Finalizar Procedimento</h1>
            {% csrf_token %}
            
            {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {% for error in form.non_field_errors %}
                    {{ error }}
                {% endfor %}
            </div>
            {% endif %}
            
            <div class="radio-group">
                <label for="{{ form.data_horario_inicio_efetivo.id_for_label }}">{{ form.data_horario_inicio_efetivo.label }}</label>
                <div class="input-width-280">
                    {{ form.data_horario_inicio_efetivo }}
                    {% if form.data_horario_inicio_efetivo.errors %}
                    <div class="error-message">
                        {% for error in form.data_horario_inicio_efetivo.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="radio-group">
                <label for="{{ form.data_horario_fim_efetivo.id_for_label }}">{{ form.data_horario_fim_efetivo.label }}</label>
                <div class="input-width-280">
                    {{ form.data_horario_fim_efetivo }}
                    {% if form.data_horario_fim_efetivo.errors %}
                    <div class="error-message">
                        {% for error in form.data_horario_fim_efetivo.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div id="dor_pos_operatoria_imediata-fields" class="radio-group scale-container">
                <label>{{ form.dor_pos_operatoria_imediata.label }}</label>
                <div class="scale-descriptions">
                    <span class="scale-description left">Dor leve</span>
                    <span class="scale-description">Dor moderada</span>
                    <span class="scale-description right">Dor intensa</span>
                </div>
                <div class="rainbow-scale"></div>
                <div class="horizontal-radio-group">
                    {% for radio in form.dor_pos_operatoria_imediata %}
                        <div class="radio-option">
                            <label>{{ radio.tag }}</label>
                            {{ radio.choice_label }}
                        </div>
                    {% endfor %}
                </div>
                {% if form.eva_score.errors %}
                <div class="error-message">
                    {% for error in form.dor_pos_operatoria_imediata.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="radio-group">
                <label>{{ form.eventos_adversos_graves.label }}</label>
                <div class="radio-options-container">
                    {% for radio in form.eventos_adversos_graves %}
                        <div class="radio-option">
                            <label>{{ radio.tag }}</label>
                            {{ radio.choice_label }}
                        </div>
                    {% endfor %}
                </div>
                {% if form.eventos_adversos_graves.errors %}
                <div class="error-message">
                    {% for error in form.eventos_adversos_graves.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="radio-group" id="eventos_adversos_graves_desc_group" style="display: none;">
                <label for="{{ form.eventos_adversos_graves_desc.id_for_label }}">{{ form.eventos_adversos_graves_desc.label }}</label>
                {{ form.eventos_adversos_graves_desc }}
                {% if form.eventos_adversos_graves_desc.errors %}
                <div class="error-message">
                    {% for error in form.eventos_adversos_graves_desc.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="radio-group">
                <label>{{ form.reacao_alergica_grave.label }}</label>
                <div class="radio-options-container">
                    {% for radio in form.reacao_alergica_grave %}
                        <div class="radio-option">
                            <label>{{ radio.tag }}</label>
                            {{ radio.choice_label }}
                        </div>
                    {% endfor %}
                </div>
                {% if form.reacao_alergica_grave.errors %}
                <div class="error-message">
                    {% for error in form.reacao_alergica_grave.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            <div class="radio-group" id="reacao_alergica_grave_desc_group" style="display: none;">
                <label for="{{ form.reacao_alergica_grave_desc.id_for_label }}">{{ form.reacao_alergica_grave_desc.label }}</label>
                {{ form.reacao_alergica_grave_desc }}
                {% if form.reacao_alergica_grave_desc.errors %}
                <div class="error-message">
                    {% for error in form.reacao_alergica_grave_desc.errors %}
                        {{ error }}
                    {% endfor %}
                </div>
                {% endif %}
            </div>

            {% for field in form %}
                {% if field.field.widget.input_type == "radio" and field.name not in 'eventos_adversos_graves,reacao_alergica_grave,dor_pos_operatoria_imediata' %}
                    <div class="radio-group">
                        <label>{{ field.label }}</label>
                        <div class="radio-options-container">
                            {% for radio in field %}
                                {% if radio.choice_label != '---------' %}
                                    <div class="radio-option">
                                        <label>{{ radio.tag }}</label>
                                        {{ radio.choice_label }}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>
                        {% if field.errors %}
                        <div class="error-message">
                            {% for error in field.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                {% endif %}
            {% endfor %}

            <div class="radio-group">
                <label for="{{ form.valor_cobranca.id_for_label }}">{{ form.valor_cobranca.label }}</label>
                <div class="input-width-280">
                    {{ form.valor_cobranca }}
                    {% if form.valor_cobranca.errors %}
                    <div class="error-message">
                        {% for error in form.valor_cobranca.errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>

            <div class="button-container">
                <button type="submit" class="btn btn-primary">Salvar</button>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('finalizarProcedimentoForm');
    
    // Toggle description fields based on radio selections
    function setupToggleField(radioName, descGroup) {
        const radioInputs = form.querySelectorAll(`input[name="${radioName}"]`);
        const descGroupElement = document.getElementById(descGroup);
        
        function toggleDesc() {
            const selectedValue = form.querySelector(`input[name="${radioName}"]:checked`)?.value;
            descGroupElement.style.display = selectedValue === 'True' ? 'block' : 'none';
        }
        
        radioInputs.forEach(input => {
            input.addEventListener('change', toggleDesc);
        });
        
        toggleDesc(); // Initial state
    }
    
    setupToggleField('eventos_adversos_graves', 'eventos_adversos_graves_desc_group');
    setupToggleField('reacao_alergica_grave', 'reacao_alergica_grave_desc_group');
});
</script>
{% endblock %}

